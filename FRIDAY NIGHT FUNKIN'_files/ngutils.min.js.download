if(typeof(ngutils)===typeof(undefined)){var ngutils={};(function($){var login_container,notification_bar,notification_shim;var www_root=PHP.get('www_root','/');var referrer=PHP.get('referrer',www_root);var is_mobile=PHP.get('ismobile')?true:false;var iOS=/iPad|iPhone|iPod/g.test(navigator.userAgent)&&!window.MSStream;ngutils.blacked_out=false;ngutils.screen_lock=false;ngutils.scrollBarWidth=0;ngutils.slugify=(str)=>{str=str.replace(/^\s+|\s+$/g,'');str=str.toLowerCase();var from="ÁÄÂÀÃÅČÇĆĎÉĚËÈÊẼĔȆÍÌÎÏŇÑÓÖÒÔÕØŘŔŠŤÚŮÜÙÛÝŸŽáäâàãåčçćďéěëèêẽĕȇíìîïňñóöòôõøðřŕšťúůüùûýÿžþÞĐđßÆa·/_,:;";var to="AAAAAACCCDEEEEEEEEIIIINNOOOOOORRSTUUUUUYYZaaaaaacccdeeeeeeeeiiiinnooooooorrstuuuuuyyzbBDdBAa------";for(var i=0,l=from.length;i<l;i++){str=str.replace(new RegExp(from.charAt(i),'g'),to.charAt(i));}
str=str.replace(/[^a-z0-9 -]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-');return str;};ngutils.logOut=function(element){var _paq=window._paq||[];_paq.push(["setDocumentTitle",document.domain+"/"+document.title]);_paq.push(["setCookieDomain","*.newgrounds.com"]);_paq.push(["setDomains",["*.newgrounds.com"]]);_paq.push(['resetUserId']);_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var u="https://analytics.ngfiles.com/";_paq.push(['setTrackerUrl',u+'js/']);_paq.push(['setSiteId','1']);var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0];g.type='text/javascript';g.async=true;g.defer=true;g.src=u+'js/';s.parentNode.insertBefore(g,s);})();var action=$(element).attr('data-url');var $form=$('<form>').attr('action',action).attr('method','post');$('body').prepend($form);$form.submit();return false;};ngutils.checkDataAttributes=function(){$('*[data-exec-script]').click(function(){var handler=$(this).attr('data-exec-script');var params=$(this).attr('data-exec-params');try{if(params){params=JSON.parse(params);}}
catch(e){console.error('Bad JSON in data-exec-params="'+params+'"');return false;}
return ngutils.click_watcher.execute(handler,params);});$('a[data-post-on-click]').each(function(){var params=$(this).attr('data-post-on-click');if(params.indexOf("{")!==0){params={};}else{try{var jsp=JSON.parse(params);params=jsp;}
catch(e){console.error('Bad JSON in data-post-on-click="'+params+'"');return false;}}
params.XD=true;$(this).formifyLink(params);});};ngutils.clearSelection=function(){if(document.selection&&document.selection.empty){document.selection.empty();}else if(window.getSelection){var sel=window.getSelection();sel.removeAllRanges();}};ngutils.initScrollFixColumn=function(){var $column=$(".scrollfix-column").first();if(!$column||$column.length<1)return;var fixed=false;var $notification_bar=$('#notification-bar');var $shim=$("<div></div>");$shim.attr('class',$column.attr('class'));$shim.attr('id','scrollfix-shim');$shim.hide();$column.after($shim);var $body=$(window);var native_y=$column.offset().top;var fixed_y=0;var native_position=$column.css('position');var fix_at=native_y;function fix(){fixed=true;$column.css('position','fixed');$column.css('top',fixed_y);$shim.width($column.outerWidth());$shim.height($column.outerHeight());$shim.show();}
function unfix(){fixed=false;$shim.hide();$column.css('position',native_position);}
function checkScrollFixPosition(){var pos=$body.scrollTop();var fixme=(pos>=fix_at);if(fixed&&!fixme)unfix();else if(!fixed&&fixme)fix();}
checkScrollFixPosition();$(document).scroll(checkScrollFixPosition);};ngutils.bytesToString=function(bytes){var sizeSymbols=["KB","MB","GB","TB","PB","EB"];if(bytes===0){return bytes+sizeSymbols[0];}
var i=-1;do{bytes=bytes / 1e3;i++;}while(bytes>999);return Math.max(bytes,0.1).toFixed(1)+sizeSymbols[i];};ngutils.b64toBlob=function(b64Data,contentType,sliceSize){contentType=contentType||'';sliceSize=sliceSize||512;var byteCharacters=atob(b64Data);var byteArrays=[];for(var offset=0;offset<byteCharacters.length;offset+=sliceSize){var slice=byteCharacters.slice(offset,offset+sliceSize);var byteNumbers=new Array(slice.length);for(var i=0;i<slice.length;i++){byteNumbers[i]=slice.charCodeAt(i);}
var byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray);}
var blob=new Blob(byteArrays,{type:contentType});return blob;};ngutils.ieHacks=function(){var ua=window.navigator.userAgent;var msie=ua.indexOf("MSIE ");if(msie>0||!!navigator.userAgent.match(/Trident.*rv\:11\./)){var outer=$('#outer-skin');var fixOuter=function(){$(outer).height($(document).height());};ngutils.event.addListener(ngutils.event.resize,fixOuter);fixOuter();}};$(function(){login_container=$('#user_login_container');notification_bar=$('#notification-bar');notification_shim=$('#notification-shim');ngutils.media.smartscale.autodetect();ngutils.element.autoCondense();ngutils.initScrollFixColumn();ngutils.ieHacks();ngutils.grids.init();ngutils.media.smartload.autodetect();ngutils.forms.fakeSelect.autodetect();ngutils.forms.selectLinks.autodetect();ngutils.forms.selectAltLabels.autodetect();var noscroll=function(e){if(ngutils.screen_lock){e.preventDefault();return false;}
return true;};$('#body-main').on('touchmove',noscroll);$('#notification-bar').on('touchmove',noscroll);});ngutils.ajaxOnClick=(event,link,complete_event,fail_event)=>{event.preventDefault();let $link=$(link);if($link.attr('data-confirm')&&!confirm($link.attr('data-confirm')))return;$.get($link.attr('href'),(result)=>{if(complete_event)ngutils.event.dispatch(complete_event,result);}).fail((result)=>{if(fail_event)ngutils.event.dispatch(fail_event,result);});};ngutils.onAjaxComplete=function(){setTimeout(function(){ngutils.media.smartscale.autodetect();ngutils.element.autoCondense();ngutils.media.smartload.autodetect();ngutils.forms.fakeSelect.autodetect();ngutils.forms.selectLinks.autodetect();ngutils.forms.selectAltLabels.autodetect();},3);};$(document).ajaxComplete(function(){ngutils.onAjaxComplete();});ngutils.input={lastX:null,lastY:null,getMouse:function(e){var input=is_mobile?e.originalEvent.touches[0]:e;if(!input){return{x:this.lastX,y:this.lastY};}
this.lastX=input.pageX;this.lastY=input.pageY;return{x:input.pageX,y:input.pageY};}};if(is_mobile){ngutils.input.mouseDown="touchstart";ngutils.input.mouseUp="touchend";ngutils.input.mouseMove="touchmove";}else{ngutils.input.mouseDown="mousedown";ngutils.input.mouseUp="mouseup";ngutils.input.mouseMove="mousemove";}
ngutils.activeTasks={increment:0,tasks:{},$saving:null,activeTaskInterrupt:function(e){for(var i in ngutils.activeTasks.tasks){let message=ngutils.activeTasks.tasks[i].saving?'Your changes are still saving.\n\nAre you sure you want to leave?':'You have unsaved changes.\n\nAre you sure you want to leave the page?';e.returnValue=message;return message;}},checkTasks:function(){window.removeEventListener("beforeunload",ngutils.activeTasks.activeTaskInterrupt);let task=null;let saving=false;for(var i in ngutils.activeTasks.tasks){task=ngutils.activeTasks.tasks[i];console.log(task);if(task.saving)saving=true;}
if(task){window.addEventListener("beforeunload",ngutils.activeTasks.activeTaskInterrupt);}
if(saving){if(!ngutils.activeTasks.$saving){ngutils.activeTasks.$saving=$('#activetask-saving-msg');}
ngutils.activeTasks.$saving.fadeIn();}else if(ngutils.activeTasks.$saving){ngutils.activeTasks.$saving.fadeOut();}},addTask:function(saving,$element){return new ngutils.activeTasks.task(saving,$element);},task:function(saving,$element){let _this=this;ngutils.activeTasks.increment++;this.name="task"+ngutils.activeTasks.increment;this.complete=false;this._saving=saving?true:false;ngutils.activeTasks.tasks[this.name]=this;if($element){console.log('Blackout from element');this.blackout=ngutils.blackout.getByChild($element);}else{console.log('Blackout from lastlayer');this.blackout=ngutils.blackout.getTop();}
console.log(this.blackout);this.completed=function(){delete ngutils.activeTasks.tasks[this.name];ngutils.activeTasks.checkTasks();_this.completed=function(){return false;};_this.complete=true;ngutils.event.dispatch(ngutils.event.taskCompleted,_this);return true;};ngutils.activeTasks.checkTasks();ngutils.event.dispatch(ngutils.event.taskStarted,this);},endTask:function(name){if(ngutils.activeTasks.tasks[name])ngutils.activeTasks.tasks[name].endTask();}};ngutils.activeTasks.task.prototype={_saving:false,get saving(){return this._saving;},set saving(s){this._saving=s?true:false;ngutils.activeTasks.checkTasks();}};ngutils.event={resize:'resize',closeall:'closeall',closeMenus:'closeMenus',newNotifications:'newNotifications',topMenuOpen:'topMenuOpen',userBlockUpdated:'user-block-updated',userBlocksUpdated:'user-blocks-updated',emoteSetChanged:'emote-set-changed',emoteSelectLoaded:'emote-select-loaded',tagsUpdated:'tag-collection-updated',taskStarted:'task-started',taskCompleted:'task-completed',blackoutClosed:'blackout-closed',listeners:[],addListener:function(event,listener){if(typeof(ngutils.event.listeners[event])===typeof(undefined))ngutils.event.listeners[event]=[];ngutils.event.listeners[event].unshift(listener);},removeListener:function(event,listener){if(typeof(ngutils.event.listeners[event])===typeof(undefined))return;var index=ngutils.event.listeners[event].indexOf(listener);if(index>=0)ngutils.event.listeners[event].splice(index,1);},removeAll:function(event){if(typeof(ngutils.event.listeners[event])===typeof(undefined))return;ngutils.event.listeners[event]=[];},dispatch:function(event,data){var i;if(typeof(ngutils.event.listeners[event])===typeof(undefined))return;var queue=ngutils.event.listeners[event].slice(0);for(i=0;i<queue.length;i++){if(queue[i](data)===false)return;}
return true;}};$(function(){setTimeout(function(){$(window).resize(function(){ngutils.event.dispatch(ngutils.event.resize);});var selector=is_mobile?'#body-main':'body';$(selector).click(function(){ngutils.event.dispatch(ngutils.event.closeall);});var scrollTop=$(window).scrollTop();var nb_dir=1;var nb=$('#notification-bar');nb.css('position','absolute').css('top','0px');var to;var nb_height=nb.outerHeight();function dispatchNotificationScrolled(){let top=0;if(nb.css('position')=='fixed'){top=nb_height+parseInt(nb.css('top').replace('px',''));}
ngutils.event.dispatch('notification-bar-moved',top);}
function showNotificationBar(force,skip_animation){var st=$(window).scrollTop();nb_dir=0;if(force===true||st>200){if(!skip_animation){nb.css('position','fixed').css('top',"-"+nb_height+"px");nb.animate({top:'0px'},{duration:200,step:dispatchNotificationScrolled,complete:dispatchNotificationScrolled});}else{nb.css('position','fixed').css('top',"0px");dispatchNotificationScrolled();}}else{nb.css('position','absolute').css('top',"0px");dispatchNotificationScrolled();}
clearTimeout(to);to=setTimeout(function(){nb_dir=-1;},600);}
ngutils.event.addListener(ngutils.event.newNotifications,function(){showNotificationBar(true,false);});ngutils.event.addListener(ngutils.event.topMenuOpen,function(){showNotificationBar(true,true);});$(window).scroll(function(e){if(ngutils.notification_controller.open_menu)return;var st=$(window).scrollTop();if(st===scrollTop)return;var moved=scrollTop-st;scrollTop=st;if(nb_dir===-1&&moved<0){if(st<=200){nb.css('position','absolute').css('top','0px');dispatchNotificationScrolled();nb_dir=1;return;}else{nb_dir=0;nb.css('position','fixed').css('top','0px');nb.stop();nb.css('background-color','');nb.animate({top:"-"+nb_height+"px"},{duration:200,step:dispatchNotificationScrolled,complete:function(){dispatchNotificationScrolled();nb.css('position','absolute').css('top','0px');}});}
clearTimeout(to);to=setTimeout(function(){nb_dir=1;},600);}else if(nb_dir===1&&moved>0){showNotificationBar(false,false);}});},500);});ngutils.search={initMobile:function(element_id,shim_id,button_id,transition_speed,auto_open){var waiting=false;var open=auto_open?true:false;var element=$('#'+element_id);var shim=$('#'+shim_id);var button=$('#'+button_id);var textfield=element.find('input').first();element.show();var eheight=element.outerHeight();if(open){element.css('top',shim.outerHeight());}else{element.hide();}
button.click(function(){if(waiting)return false;ngutils.event.dispatch(ngutils.event.closeall,'topsearch');var nheight=shim.outerHeight();var anchor=nheight-eheight;waiting=true;var from=open?nheight:anchor;var to=open?anchor:nheight;open=!open;element.css('top',from);element.show();if(open)textfield.focus();element.animate({top:to},transition_speed,function(){waiting=false;if(!open)element.hide();});return false;});ngutils.event.addListener(ngutils.event.resize,function(){if(open){element.stop();var nheight=shim.outerHeight();element.css('top',nheight);}});ngutils.event.addListener(ngutils.event.closeall,function(source){ngutils.screen_lock=false;if(source!='topsearch'&&open){element.stop();var nheight=shim.outerHeight();var anchor=nheight-eheight;open=false;waiting=true;element.animate({top:anchor},transition_speed,function(){waiting=false;element.hide();});}});}};ngutils.desktop={register_menu:function(menu_id){var menu=$('#'+menu_id);$('button',menu).click(function(){var li=$(this).parent();if(li.hasClass('collapsed')){li.removeClass('collapsed');li.addClass('expanded');$(this).html("&ndash;");}else{li.removeClass('expanded');li.addClass('collapsed');$(this).html("+");}
return false;});}};ngutils.mobile={last_id:0};ngutils.mobile.menuController=function(container_id,button_id,default_menu){var i;var controller=this;this.id=ngutils.mobile.last_id;ngutils.mobile.last_id++;this.container=$("#"+container_id);this.button=$("#"+button_id);var waiting=false;var open=false;this.container.show();this.width=this.container.outerWidth();this.direction=this.container.hasClass('right-menu')?1:-1;this.background=$('div.mobile-menu-background',this.container).first();this.anchor=this.width*this.direction;this.background.css('left',this.anchor);this.container.hide();this.transition_speed=250;this.menus={};this.default_menu=null;this.current=null;this.width=this.container.outerWidth();var touchat=null;var startPos=null;var sceolling=false;var noscroll=function(e){var touchpos=e.originalEvent.touches[0].clientY;var maxScroll=controller.current.$element.prop('scrollHeight')-controller.container.innerHeight();if(maxScroll<1){e.preventDefault();return false;}
var moved=touchpos-touchat;touchat=touchpos;var scrollTop=controller.current.$element.scrollTop();if(scrollTop!=startPos&&!scrolling)scrolling=true;if((moved>0&&scrollTop<1)||(moved<0&&scrollTop>=maxScroll)){if(!scrolling){e.preventDefault();return false;}}
return true;};this.container.on('touchmove',noscroll);this.container.on('touchstart',function(e){touchat=e.originalEvent.touches[0].clientY;startPos=controller.current.$element.scrollTop();scrolling=false;});if(typeof(_params)=='object'){for(i in _params){this[i]=_params[i];}}
$("*[data-menu-id]",this.container).each(function(){var menu=new ngutils.mobile.menu($(this),controller);if(default_menu){if(menu.id==default_menu)controller.default_menu=menu;}else if(menu.isRoot()){controller.default_menu=menu;}
controller.menus[menu.id]=menu;});this.setMenu=function(menu_id,animate,direction){if(animate&&waiting)return false;if(!direction)direction=1;var menu=this.menus[menu_id];var to,from,anchor=0;if(this.current){anchor=this.anchor*direction;if(animate===true){waiting=true;var $last=this.current.$element;to=anchor;this.current.$element.animate({left:to},this.transition_speed,function(){waiting=false;$last.hide();});}else{this.current.$element.hide();}}
this.current=menu;if(!menu)return;this.current.$element.show();this.current.$element.scrollTop(0);if(animate===true){from=anchor*-1;to=0;waiting=true;this.current.$element.css('left',from);this.current.$element.animate({left:to},this.transition_speed,function(){waiting=false;});}else{this.current.$element.css('left',0);}};this.button.click(function(){if(waiting)return false;ngutils.event.dispatch(ngutils.event.closeall,'menuController'+controller.id);waiting=true;var from=open?0:controller.anchor;var to=open?controller.anchor:0;open=!open;if(open)controller.setMenu(controller.default_menu.id,false);controller.background.css('left',from);controller.container.show();controller.background.animate({left:to},controller.transition_speed,function(){waiting=false;if(!open){controller.container.hide();}else{ngutils.screen_lock=true;}});return false;});ngutils.event.addListener(ngutils.event.closeall,function(source){if(open&&source!=='menuController'+controller.id){controller.background.stop();var to=controller.anchor;waiting=true;open=false;controller.background.animate({left:to},controller.transition_speed,function(){waiting=false;controller.container.hide();});}});};ngutils.mobile.menu=function($element,controller){this.controller=controller;this.$element=$element;this.id=$element.attr('data-menu-id');this.parent_id=$element.attr('data-parent-id');this.parent=null;this.$element.hide();$("*[data-open-menu]").each(function(){var opens=$(this).attr('data-open-menu');var dir=$(this).attr('data-direction')=='-1'?-1:1;$(this).click(function(){controller.setMenu(opens,true,dir);return false;});});};ngutils.mobile.menu.prototype={children:[],addChild:function(child){this.children.push(child);},isRoot:function(){return!(this.parent_id&&this.parent_id!=this.id);}};ngutils.footer={buttons:[],selected:null,init:function(button_id_array){this.buttons=button_id_array;var $container=$('#footer-feature-buttons');$('button',$container).click(function(){ngutils.footer.changeTo($(this).attr('id'));return false;});$('#featureshift-left').click(function(){ngutils.footer.previous();return false;});$('#featureshift-right').click(function(){ngutils.footer.next();return false;});this.selected=$('button.selected',$container).first().attr('id');},changeTo:function(button_id){var $container=$('#footer-feature-buttons');var $items=$('#footer-featured-items');var $button=$("#"+button_id,$container);if(!$button)return;$('button.selected',$container).removeClass('selected');$button.addClass('selected');this.selected=button_id;var footer_feature=button_id.split("-").pop();$.get("/footer-feature/"+footer_feature,function(data){$items.html(data);});},next:function(){var index=this.buttons.indexOf(this.selected);index++;if(index>=this.buttons.length)index=0;this.changeTo(this.buttons[index]);},previous:function(){var index=this.buttons.indexOf(this.selected);index--;if(index<0)index=this.buttons.length-1;this.changeTo(this.buttons[index]);}};ngutils.grids={_initialized:false,init:function(){this.update();if(!this._initialized)ngutils.event.addListener(ngutils.event.resize,this.update);this._initialized=true;},init_grids_with_max_rows:function(){$("*[data-max-rows]").each(function(){var $grid=$(this);var max_rows=parseInt($grid.attr('data-max-rows'));ngutils.grids.setMaxRows($grid,max_rows);});},update:function(){ngutils.grids.init_grids_with_max_rows();},setMaxRows:function($grid,max_rows){var left=-9999;var row=1;$grid.children().each(function(){$(this).show();var l=$(this).offset().left;if(l<=left){row++;}
left=l;if(row>max_rows)$(this).hide();});}};ngutils.blackout=function(config){ngutils.blackout.autoID++;this.id=ngutils.blackout.autoID;this.remove_on_hide=false;this.remove_on_click_outside=true;this.fade_in=true;this.fade_out=true;this.loaded=false;this.visible=false;this.$elements={};this._onfail=null;this._onfail_context=this;this._onload=null;this._onload_context=this;this._onshow=null;this._onshow_context=this;this._onhide=null;this._onhide_context=this;this._onremove=null;this._onremove_context=this;this.$container=null;if(typeof(config)==='object'){for(var i in config){this[i]=config[i];}}
var _this=this;$(document).keyup(function(e){if(_this.visible&&e.key==='Escape')_this.hide();});};ngutils.blackout.prototype={onLoad:function(callback,thisArg){this._onload=typeof(callback)==='function'?callback:null;this._onload_context=thisArg?thisArg:this;},onShow:function(callback,thisArg){this._onshow=typeof(callback)==='function'?callback:null;this._onshow_context=thisArg?thisArg:this;},onHide:function(callback,thisArg){this._onhide=typeof(callback)==='function'?callback:null;this._onhide_context=thisArg?thisArg:this;},onRemove:function(callback,thisArg){this._onremove=typeof(callback)==='function'?callback:null;this._onremove_context=thisArg?thisArg:this;},load:function(url,data,jQuery_success){var _this=this;this.loaded=false;this.show(ngutils.blackout.spinner);if(typeof(data)==='function'){jQuery_success=data;data={};}
$.getXD(url,data,function(data,textStatus,jqXHR){_this.loaded=true;_this.show(data);ngutils.onAjaxComplete();if(typeof(jQuery_success)==='function'){jQuery_success.call(this,data,textStatus,jqXHR);}
if(_this._onload){_this._onload.call(_this._onload_context);}}).fail(function(jqXHR,textStatus,errorThrown){if(_this._onfail){_this._onfail.call(_this._onfail_context);}});},createElements:function(){var $hover,$inner,$bookend,$bookshelf,$centered,$dimmer;var $body=$('body').first();var _this=this;$hover=$("<div>");$hover.addClass('blackout-hover');$hover.attr('data-id',this.id);$dimmer=$('<div>').addClass('page-dimmer');$hover.append($dimmer);var checkReset=function(id){if(id===_this.id){_this.initButtons();}};ngutils.event.addListener('blackout-refresh',checkReset);$hover.on('remove',function(){$hover.off('remove');ngutils.event.removeListener('blackout-refresh',checkReset);});$inner=$("<div>");$inner.addClass('blackout-inner');$bookend=$("<div>");$bookend.addClass('blackout-bookend');$bookshelf=$("<div>");$bookshelf.addClass('blackout-bookshelf');$centered=$("<div>");$centered.addClass('blackout-center');$bookshelf.append($bookend.clone().addClass('shimmed'));$bookshelf.append($centered);$bookshelf.append($bookend.clone().addClass('shimmed'));$inner.append($bookend.clone());$inner.append($bookshelf);$inner.append($bookend.clone());$hover.append($inner);$body.append($hover);_this.$elements.hover=$hover;_this.$elements.inner=$inner;_this.$elements.centered=$centered;$('div.blackout-bookend',_this.$elements.inner).click(function(){if(_this.remove_on_click_outside){_this.hide();}});},removeLayer:function(){var layered_at=ngutils.blackout.layers.indexOf(this);if(layered_at>-1)ngutils.blackout.layers.splice(layered_at,1);},getZIndex:function(){return(ngutils.blackout.layers.length*2)+ngutils.blackout.zIndex;},initButtons:function(){var _this=this;var $btn=$('[data-action="blackout-close"]',_this.$elements.inner);$btn.off('click');$btn.show();var in_blackout=$btn.parents('.blackout-hover').length>0;if(!in_blackout){$btn.remove();return;}
$btn.click(function(){_this.hide();});$btn.removeAttr('data-action');},hiding:false,timeout:null,show:function(data){var _this=this;this.hiding=false;this.removeLayer();ngutils.blackout.lockLastLayer();ngutils.blackout.layers.push(this);var $body=$('body').first();if(!_this.$elements.centered){_this.createElements();}
_this.$elements.centered.hide();if(!data&&!$.trim(_this.$elements.centered.html())){data=ngutils.blackout.spinner;}
if(data){_this.setBody(data);}
if(!ngutils.blackout.$background){ngutils.blackout.$background=$("<div>");ngutils.blackout.$background.addClass('blackout');$body.append(ngutils.blackout.$background);}
for(var e in this.$elements){if(e!='centered')this.$elements[e].show();}
var $inner=_this.$elements.inner;$inner.css('height','');var zIndex=_this.getZIndex();ngutils.blackout.$background.css('z-index',zIndex);if(this.fade_in&&!ngutils.blackout.$background.__visible){ngutils.blackout.$background.hide();ngutils.blackout.$background.fadeIn(200);}else{ngutils.blackout.$background.show();}
ngutils.blackout.$background.__visible=true;if(_this.timeout)clearTimeout(_this.timeout);_this.timeout=setTimeout(function(){var $centered=_this.$elements.centered;var $hover=_this.$elements.hover;if($centered.outerHeight()<=$hover.outerHeight()){$inner.css('height','100%');}
$hover.css('z-index',zIndex+1);$centered.show();_this.visible=true;if(_this._onshow)_this._onshow.call(_this._onshow_context);},1);},setBody:function(data){var _this=this;if(!_this.$elements.centered){_this.createElements();}
if(data instanceof jQuery){_this.$elements.centered.html('');_this.$elements.centered.append(data);}else{_this.$elements.centered.html(data);}
_this.initButtons();},unlinkTask:function(){for(var i in ngutils.activeTasks.tasks){if(ngutils.activeTasks.tasks[i].blackout==this){ngutils.activeTasks.tasks[i].blackout=null;}}},locked:false,lock:function(){this.locked=true;return this;},unlock:function(){this.locked=false;return this;},ignore_active_tasks:false,hide:function(){if(this.locked)return false;let activetask=null;let savingtask=false;if(!this.ignore_active_tasks){for(var i in ngutils.activeTasks.tasks){if(ngutils.activeTasks.tasks[i].blackout==this){if(ngutils.activeTasks.tasks[i].saving)savingtask=true;activetask=true;}}}
if(activetask&&!activetask.complete){message=savingtask?'Your changes are still saving.\n\nAre you sure you want to close this?':'You have unsaved changes.\n\nAre you sure you want to close this?';if(!confirm(message))return;}
this.removeLayer();var _this=this;ngutils.blackout.unlockLastLayer();if(this.hiding)return;this.hiding=false;if(ngutils.blackout.$background){ngutils.blackout.$background.css('z-index',this.getZIndex());if(ngutils.blackout.layers.length<1){if(!this.fade_out||!ngutils.blackout.$background.__visible){ngutils.blackout.$background.hide();}else{_this.hiding=true;ngutils.blackout.$background.fadeOut(200,function(){_this.hiding=false;});}
ngutils.blackout.$background.__visible=false;}}
if(this.$elements.hover)this.$elements.hover.scrollTop(0);for(var e in this.$elements){this.$elements[e].hide();}
this.visible=false;ngutils.event.dispatch(ngutils.event.blackoutClosed,this);if(this.remove_on_hide)return this.remove();if(this._onhide)this._onhide.call(this._onhide_context);},toggle:function(){if(this.locked)return false;if(this.visible)this.hide();else this.show();},remove:function(){if(this.locked)return false;for(var e in this.$elements){this.$elements[e].remove();}
this.$elements={};this.loaded=false;this.visible=false;if(this._onremove)this._onremove.call(this._onremove_context);},getLayerElement:function(){var $hover;if(this.$elements&&this.$elements.hover)$hover=this.$elements.hover;return $hover;}};ngutils.blackout.prototype.constructor=ngutils.blackout;ngutils.blackout.zIndex=11000;ngutils.blackout.layers=[];ngutils.blackout.$background=null;ngutils.blackout.spinner='<em class="fa fa-spinner fa-spin" style="font-size: 2em"></em>';ngutils.blackout.fromOnClick=function(event,$element,options,callback){event.preventDefault();$element=$($element);if(!$element.attr('href')){console.error('onClick element requires href attribute');return;}
if(typeof(options)=='function'){callback=options;options=null;}
if(!options){options={remove_on_hide:true};}
var blackout=new ngutils.blackout(options);if(typeof(callback)=='function')callback(blackout);blackout.show(ngutils.blackout.spinner);var params={userkey:PHP.get('uek')};if(PHP.get('ng_design'))params.___ng_design=PHP.get('ng_design');blackout.load($element.attr('href'),params);return false;};ngutils.blackout.getTop=function(){if(ngutils.blackout.layers<1)return null;let i=ngutils.blackout.layers.length-1;return ngutils.blackout.layers[i];};ngutils.blackout.getByChild=function($child){var $hover=$child.closest(".blackout-hover");if($hover.length<1)return null;var id=parseInt($hover.attr('data-id'));if(!id)return null;for(var i=0;i<ngutils.blackout.layers.length;i++){if(ngutils.blackout.layers[i]&&ngutils.blackout.layers[i].id===id)return ngutils.blackout.layers[i];}
return null;};ngutils.blackout.getLastLayer=function(){var $layer;if(ngutils.blackout.layers.length<1){$layer=$('body').first();}else{var blackout=ngutils.blackout.layers[ngutils.blackout.layers.length-1];if(blackout)$layer=blackout.getLayerElement();}
return $layer;};ngutils.blackout.lockLastLayer=function(){ngutils.layer_element.lock(ngutils.blackout.getLastLayer());};ngutils.blackout.unlockLastLayer=function(){ngutils.layer_element.unlock(ngutils.blackout.getLastLayer());};ngutils.blackout.autoID=0;ngutils.blackout.refresh=function(id){if(!id)return;id=parseInt(id);ngutils.event.dispatch('blackout-refresh',id);};ngutils.blackout._currentDim=null;ngutils.blackout.dim=function($container){if(ngutils.blackout._currentDim)ngutils.blackout.undim();ngutils.blackout._currentDim=ngutils.blackout.getLastLayer();ngutils.blackout._currentDim.addClass('dimmed');};ngutils.blackout.undim=function(){if(ngutils.blackout._currentDim)ngutils.blackout._currentDim.removeClass('dimmed');ngutils.blackout._currentDim=null;};ngutils.layer_element={};ngutils.layer_element.lock=function($element){if(!is_mobile&&!ngutils.scrollBarWidth){var $body=$('body').first();var width_with_scroll=$body.outerWidth();$body.css('overflow','hidden');var width_without_scroll=$body.outerWidth();$body.css('overflow','');ngutils.scrollBarWidth=width_without_scroll-width_with_scroll;}
if(!$element||$element.length<1)return;if($element.is('[data-locked-layer]'))return;$element.attr('data-locked-layer',1);$element.css('overflow','hidden');var applyScrollShim=function($element){$element.css('width','calc(100% - '+ngutils.scrollBarWidth+'px)');$element.css('margin-right',ngutils.scrollBarWidth+'px');};if(ngutils.scrollBarWidth){if($element.is('body')){applyScrollShim($('#outer-skin'));applyScrollShim($('#notification-bar'));$('div.skin-wrapper.fixed').css('left',"-"+(ngutils.scrollBarWidth/2)+"px");}else{applyScrollShim($element);}}};ngutils.layer_element.unlock=function($element){if(!$element||$element.length<1)return;if(!$element.is('[data-locked-layer]'))return;$element.removeAttr('data-locked-layer');$element.css('overflow','');var removeShim=function($element){$element.css('width','');$element.css('margin-right','');};if(ngutils.scrollBarWidth){if($element.is('body')){removeShim($('#outer-skin'));removeShim($('#notification-bar'));$('div.skin-wrapper.fixed').css('left','');}else{removeShim($element);}}};ngutils.form_draft=function($element,options){var self=this;self.$element=$element;self.options=options||{};self.field_callbacks=[];self.generic_id=null;self.type_id=null;self.extra_id=null;self.interval=null;self.task=null;$element.on('remove',function(){self.complete();});if('generic_id'in self.options){self.generic_id=self.options.generic_id;delete self.options.generic_id;}
if('type_id'in self.options){self.type_id=self.options.type_id;delete self.options.type_id;}
if('extra_id'in self.options){self.extra_id=self.options.extra_id;delete self.options.extra_id;}
self.addFieldCallback=function(f){self.field_callbacks.push(f);};var updateIfNecessary=function(){var prev=$(this).data('previous');var val=$(this).val().trim();if(val.length&&prev!==val){console.log("New val "+val);$(this).data('previous',val);self.update();}};self.registerOnBlurElements=function($element_or_elements){$element_or_elements.each(function(index){$(this).blur(updateIfNecessary);});return self;};self.registerOnChangeElements=function($element_or_elements){$element_or_elements.each(function(index){$(this).change(updateIfNecessary);});return self;};self.begin=function(){if(null!==self.interval){return self;}
self.interval=setInterval(self.update.bind(self),20000);return self;};self.end=function(){if(null===self.interval){return self;}
clearInterval(self.interval);self.interval=null;return self;};self.complete=function(){self.end();if(self.task){self.task.completed();self.task=null;}
return self;};self.getUrl=function(action){let url='/form/'+action+'/draft/'+self.generic_id+'/'+self.type_id;if(null!==self.extra_id){url=url+'/'+self.extra_id;}
return url;};self.fetch=function(callback){if(null===self.generic_id||null===self.type_id){return false;}
$.get(self.getUrl('get'),callback);return self;};self.update=function(){if(null===self.generic_id||null===self.type_id){return false;}
if(null===self.task){self.task=ngutils.activeTasks.addTask(false,$element);}
let url=self.getUrl('save');let params;if(self.$element.is('form')){params=self.$element.serializeArray();}else{params=[];}
if(self.field_callbacks.length){for(let callback,i=0,len=self.field_callbacks.length;i<len;++i){params.push(self.field_callbacks[i](this));}}
$.post(url,params);return self;};self.updateTask=function(saving){if(self.task)self.task.saving=saving;return self;};};ngutils.form_draft.prototype.constructor=ngutils.form_draft;ngutils.notification_controller={open_menu:null,interval:30000,decay:0,timer:null,window_active:true,active:true,inactive_start:null,containers:{},init:function(){var self=this;var container=$('#notification_icons');this.notification_bar=$('#notification-bar');this.bar_color=this.notification_bar.css('backgroundColor');this.flash_color="#fc0";if(container){$("a[id^='notify']").each(function(){$(this).show();var info=$(this).attr('id').split("_");var mode=info.shift();var item=info.join("_");ngutils.notification_controller.containers[item]={toggles:(mode=='notifyonly'),element:$(this),value:0};});}
var data=PHP.get("notification_init_values",null);if(data){ngutils.notification_controller.parse(data,false);}
$(window).blur(function(){ngutils.notification_controller.active=false;ngutils.notification_controller.inactive_start=new Date();});window.setInterval(function(){ngutils.notification_controller.decay+=10000;},10000);var resetDecay=function(){if(ngutils.notification_controller.decay>(ngutils.notification_controller.interval*4)){ngutils.notification_controller.makeRequest();}
ngutils.notification_controller.decay=0;};var events=['mousedown','mousemove','keypress','scroll','touchstart'];events.forEach(function(name){document.addEventListener(name,resetDecay,true);});$(window).focus(function(){var ms_diff=new Date()-ngutils.notification_controller.inactive_start;ngutils.notification_controller.active=true;ngutils.notification_controller.inactive_start=null;if(ms_diff>ngutils.notification_controller.interval){ngutils.notification_controller.begin();}});window.setTimeout(this.begin.bind(this),ngutils.notification_controller.interval);},begin:function(){if(ngutils.notification_controller.timer){clearInterval(ngutils.notification_controller.timer);}
ngutils.notification_controller.makeRequest();},makeRequest:function(){if(ngutils.notification_controller.open_menu)return;if(ngutils.notification_controller.timer){window.clearTimeout(ngutils.notification_controller.timer);}
$.getJSON(PHP.get('notification_ajax_url','/checknotifications'),function(data){ngutils.notification_controller.parse(data,true);ngutils.notification_controller.timer=window.setTimeout(ngutils.notification_controller.load.bind(this),parseInt(ngutils.notification_controller.interval+ngutils.notification_controller.decay,10));});},load:function(){if(ngutils.notification_controller.active){ngutils.notification_controller.makeRequest();}},parse:function(data,animated){var changed=false;var _this=this;if(!data){return false;}
for(var item in data){if(this.update(item,data[item],animated))changed=true;}
if(animated&&changed&&this.bar_color&&this.flash_color){this.notification_bar.stop();ngutils.event.dispatch(ngutils.event.newNotifications);this.notification_bar.css('background-color',this.flash_color);this.notification_bar.animate({'background-color':this.bar_color},1000,function(){_this.notification_bar.css('background-color','');});}},update:function(item,value){ngutils.notification_controller.values[item]=value;if(!this.containers[item])return;var element=this.containers[item].element;var toggles=this.containers[item].toggles;var oldval=this.containers[item].value;var span=$('span',element);this.containers[item].value=value;if(value=="0")value="";span.html(value?value:"");return value>oldval;}};ngutils.notification_controller.values={messages:0,interactions:0};ngutils.notification_controller.setInteractionButton=function($button){var interaction_blackout=new ngutils.blackout();var is_open=false;interaction_blackout.onHide(function(){is_open=false;});$button.click(function(){if(is_open){interaction_blackout.hide();}else{is_open=true;interaction_blackout.show(ngutils.blackout.spinner);var url=$button.attr('href');var context='header';$.getXD(url,"context=header",function(data){interaction_blackout.show(data);});ngutils.notification_controller.clearCount($button);}
return false;});};ngutils.notification_controller.button=function($button,$default_body){var menuspeed=250;this.$button=$($button);var detail=this.$button.attr('data-detail');var $nbar=$('#notification-buttons');var $template=$('#header-dropdown-template').clone();var $menu_body=$('.menu-body',$template).first();var $menu_footer=$('.menu-footer',$template).first();var $view_all=$('a',$menu_footer).first();$view_all.attr('href',this.$button.attr('href'));var $menu_scroll=$('.menu-scroll',$template).first();var $loading_spinner=$('.loading-spinner',$template).first();$loading_spinner.remove();if(!$default_body){$default_body=$loading_spinner;}
else{$default_body.show().detach();}
this.is_open=false;var _this=this;this.open=function(){if(_this.is_open)return;ngutils.notification_controller.clearCount(this.$button);_this.is_open=true;ngutils.notification_controller.open_menu=_this;ngutils.event.dispatch(ngutils.event.topMenuOpen);$('body').append($template);$menu_body.html('').append($default_body);var right=$nbar.offset().left+$nbar.outerWidth();$template.show().css('left',right-$template.outerWidth());$template.height('');var h=$menu_body.outerHeight();$template.height(0);$template.animate({height:h+"px"},menuspeed);$menu_footer.hide();$menu_scroll.css('height','100%');if(detail){$.getJSON('/checknotifications',{detail:detail},function(json){if(json.has){$menu_footer.show();}else{$menu_footer.hide();if(json.redirect){window.location.href=json.redirect;return;}}
$menu_scroll.css('height','');$menu_body.html(json.partial);$template.stop();var h1=$template.height();$template.height('');var h2=$template.height();var h3=$menu_body.innerHeight()+$menu_footer.outerHeight();if(h3<h2)h2=h3;$template.height(h1);$template.animate({height:h2},menuspeed);});}
$template.off('click').on('click',function(e){e.stopPropagation();});$menu_scroll.off('mousewheel DOMMouseScroll').on('mousewheel DOMMouseScroll',function(e){e.stopPropagation();e.preventDefault();var st=$menu_scroll.scrollTop();if(e.originalEvent.wheelDelta>0||e.originalEvent.detail<0){$menu_scroll.scrollTop(st-12);}
else{$menu_scroll.scrollTop(st+12);}});};this.close=function(){if(!_this.is_open)return;_this.is_open=false;ngutils.notification_controller.open_menu=null;$template.animate({height:0},100,function(){$template.detach();$template.height('');});};$(window).resize(this.close);_this.$button.off('click').on('click',function(e){e.preventDefault();if(ngutils.notification_controller.open_menu&&ngutils.notification_controller.open_menu!==_this){ngutils.notification_controller.open_menu.close();}
if(_this.is_open)_this.close();else _this.open();return false;});_this.$button.clickOutside(function(source){_this.close();});};ngutils.notification_controller.clearCount=function($button){$('span',$button).html('');};$(function(){if(PHP.get('activeuser'))ngutils.notification_controller.init();ngutils.checkDataAttributes();});ngutils.click_watcher={handlers:{ngutils:ngutils},addHandler:function(handler,alias){this.handlers[alias]=handler;},execute:function(alias,param_obj){var obj=null;var chain=alias.split(".");var a;var thisobj=window;function doError(a){console.error("data-exec-script='"+alias+"' refers to undefined or unregistered object at '"+a+"'.");}
while(chain.length>0){a=chain.shift();if(!obj){if(!this.handlers[a]){doError(a);return false;}
obj=this.handlers[a];}else{if(!obj[a]){doError(a);return false;}
obj=obj[a];}
if(chain.length>0)thisobj=obj;}
if(typeof(obj)!='function'){console.error("data-exec-script='"+alias+"' refers to "+typeof(obj)+". Must be a function.");}
if(!param_obj){return obj();}else if(Array.isArray(param_obj)){return obj.apply(thisobj,param_obj);}else{return obj(param_obj);}}};ngutils.review={};ngutils.review.blackout=null;ngutils.review.form={};ngutils.review.form.blackout=null;ngutils.review.form.launch=false;ngutils.review.form.votebar=null;ngutils.review.form.show_fields=function(callback){if(callback&&$.isNumeric(callback)){var review_id=callback;callback=function(){var $existing=ngutils.review.getExisting(review_id);if($existing&&$existing.exists()){$existing.hide();}};}
if($('#review_fields').hasClass('collapsed')){$('#review_fields').removeClass('collapsed');if(typeof(callback)==='function'){callback();}}else if(typeof(callback)==='function'){callback();}};ngutils.review.form.hide_fields=function(callback){if(callback&&$.isNumeric(callback)){var review_id=callback;callback=function(){var $existing=ngutils.review.getExisting(review_id);if($existing&&$existing.exists()){$existing.show();if(!$('#review_fields').hasClass('notempt')){$('#review_fields').addClass('notempt');}}};}
if(!$('#review_fields').hasClass('collapsed')){$('#review_fields').addClass('collapsed');if(typeof(callback)==='function'){callback();}}else if(typeof(callback)==='function'){callback();}};ngutils.review.getId=function($element){return $element.attr('data-review-id');};ngutils.review.getExisting=function(id){return $('div.pod').find('.review[data-review-id="'+id+'"]');};ngutils.review.form.watch=function(review_id){var $container=$('#review_vote');var $form=$('form',$container);var $fields=$('#review_fields');var generic_id=$('input[name="generic_id"]',$form).val();var type_id=$('input[name="type_id"]',$form).val();var getExisting=function(id){return ngutils.review.getExisting(id);};var callback=function(response){if($('#review_vote').exists()){ngutils.review.form.hide_fields(function(){$('#review_vote').replaceWith($(response.edit));});}};$form.submit(function(e){var $agreed=$('#review_agreed');if($agreed.exists()&&!$agreed.is(':checked')){alert("You haven't agreed to the terms and conditions!");return false;}
$(this).ajaxSubmit(callback);return false;});$form.find('button.cancel').off().click(function(){var $element=$(this);ngutils.review.form.hide_fields($element.attr('data-review-id'));return false;});$('textarea',$fields).focus(function(){if($fields.hasClass('collapsed')){$fields.removeClass('collapsed');}});$(document).click(function(event){if(!$(event.target).closest($fields).length){if($('textarea',$fields).exists()&&!$('textarea',$fields).val().length&&!$fields.hasClass('collapsed')){$fields.addClass('collapsed');}}});};ngutils.review.getBlackout=function(){if(null===ngutils.review.blackout){ngutils.review.blackout=new ngutils.blackout({"remove_on_hide":true});}
return ngutils.review.blackout;};ngutils.review.paginate=function($pod,update_location){var watchLinks=function(){$('.pagenav[id^="review-navigation-"] a').off().click(function(){var url=this.href;if(url&&url.length){fetchReviews(url);}
return false;});};var fetchReviews=function(url){var fetch_url=url;if(window.location.pathname.indexOf('/reviews')===0){fetch_url=fetch_url+'?include-title';}
$.get(fetch_url,function(response){$pod.replaceWith(response);if(update_location){history.pushState({page:url},null,url);}else{history.pushState({page:url},null,null);}});};watchLinks();};ngutils.review.registered={};ngutils.review.register=function($element,launch){var self=this;self.launch=launch===true?true:false;if(typeof($element)==='string'){$element=$($element);}
if($element.attr('id')in ngutils.review.registered){$element.off();}
ngutils.review.registered[$element.attr('id')]=$element;var parts=$element.attr('id').split('_');var review_id=parseInt(parts.pop(),10);var $container=$element.parents('.pod');var $review_body=$('.review-body',$element);var $review_options=$('.review-options',$element);var $response_container=$('.rev-resp-container',$element);var $edit_link=$('a[class$="pencil"]',$review_options);var $delete_link=$('a[class$="trash"]',$review_options);var $moderate_link=$('a[class$="moderate"]',$review_options);var $response_link=$('a[class="comment-count"]',$element);$('time',$element).couNtinGDate({'format':'longDate'});$delete_link.off().ajaxifyLink({confirmation:"Are you sure you want to delete this review?",success_func:function(response){var $rv=$('#review_vote');if(response&&response.edit&&$rv.exists()){$rv.replaceWith($(response.edit));}
var $success=$(response.success).find('.pod-body');$element.replaceWith($success);$success.on('remove',function(e){$(this).off();if($container.attr('id')&&$container.attr('id').indexOf('review_event_')===0){$container.remove();}else{var remaining=$('.pod-body.review',$container).length;if(!remaining){$container.remove();}}
var $fields=$('#review_fields');if($fields.exists()){$fields.removeClass('notempt');}});}});$edit_link.off().click(function(){if(false===self.launch){$element.hide();ngutils.review.form.show_fields();}else{ngutils.review.form.blackout=new ngutils.blackout();ngutils.review.form.blackout.load(this.href);ngutils.review.form.blackout._onhide=function(){window.location.href=window.location.href;};}
return false;});$moderate_link.off().click(function(){ngutils.review.getBlackout().load(this.href,null,function(data){var $element=$(data);});return false;});var fetchResponseForm=function(response,$existing_response){if(typeof($existing_response)===typeof(undefined)){$existing_response=false;}
var $response_element=$(response.response_form);if($existing_response){$response_container.hide();}
$response_element.insertAfter($element);ngutils.review.watch_response_form($('form',$response_element),ngutils.review.form.launch);};$response_link.off().click(function(){var $element=$(this);$.get(this.href,function(response){$element.remove();return fetchResponseForm(response);});return false;});if($response_container.exists()){$('a[class$="pencil"]',$response_container).click(function(){var $self=$(this);$.get(this.href,function(response){fetchResponseForm(response,$self.parents('.authresponse'));});return false;});$('a[class$="trash"]',$response_container).ajaxifyLink({confirmation:"Are you sure you want to remove this response?",success_func:function(response){var $review=$(response.review);var review_id=$review.attr('data-review-id');var $existing=ngutils.review.getExisting(review_id);$existing.replaceWith($review);}});}};ngutils.review.watch_response_form=function($element){var makeReplacement=function(response){$element.parent().remove();var $review=$(response.review);var review_id=$review.attr('data-review-id');var $existing=ngutils.review.getExisting(review_id);$existing.replaceWith($review);};$element.find('button[class="cancel"]').off().click(function(){$.get($element.attr('action'),makeReplacement);return false;});$element.off().on('submit',function(){$(this).ajaxSubmit(makeReplacement);return false;});};ngutils.votebar=function($element,vote){var votebar=this;locked=false;if(typeof($element)==='string'){$element=$($element);}
if(typeof(vote)===typeof(undefined)){vote=null;}
var $form=$element.parents('form');var $reaction=$('div.star-reaction',$element).first();var $xp_info;this.voteCallback=function(response){};this.getSelectedInput=function(){return $('input[type=radio]:checked',$element);};this.getRealValue=function(){var $input=this.getSelectedInput();if($input){return parseInt($input.val(),10);}
return null;};this.getValue=function(){var val=this.getRealValue();return parseInt(val);};var last_score=this.getRealValue();var $selected_input=this.getSelectedInput();this.showXp=function(){if(!$xp_info.exists()){return false;}
var score=parseInt($xp_info.attr('data-attr-vote'),10);var $zero=$('label[for="votebar-0"]',$element);var star_width=$zero.width();var star_height=$zero.height();var closest=(score>0&&score%2===0)?score-1:score;var $target=$('label[for="votebar-'+closest+'"]',$element);var offset=$target.offset();var tw=$target.width();var th=$target.height();var xw=$xp_info.width();var xh=$xp_info.height();var x_top=offset.top;if(!is_mobile){x_top=x_top-xh;}else{x_top=x_top+(xh / 2);}
var x_left=offset.left;if(score>0){x_left=offset.left+(Math.floor(((score-1)/ 10)*5)*star_width);}
x_left+=(star_width-xw)/ 2;$('body:first').append($xp_info);$xp_info.css({'top':x_top+'px','left':x_left+'px'});$({brightness:5}).animate({brightness:1},{duration:500,easing:'swing',step:function(){$xp_info.css({"-webkit-filter":'brightness('+this.brightness+')',"filter":'brightness('+this.brightness+')'});},complete:function(){$xp_info.fadeOut(100,function(){$xp_info.remove();});}});$xp_info.animate({top:(x_top-40)},{duration:500,easing:'swing'});};this.clickHandler=function(event,$clicked,record){var score=$('#'+$clicked.attr('for')).val();if(this.castVote(event,score)){this.showFromLabel($clicked,record);}};this.castVote=function(event,score){score=parseInt(score,10);if(!$form.exists())return false;if(locked||score===last_score){this.getSelectedInput().prop('checked',false);$selected_input.prop('checked',true);return false;}
var data={show_fields:($('textarea',$form).exists()&&$('textarea',$form).is(':visible'))?1:0,vote:score,userkey:PHP.get('uek')};var url=$element.attr('data-attr-url');var review_progress={};$('input[type="checkbox"], textarea',$form).each(function(){if($(this).is('textarea')){review_progress[this.name]=this.value;}else{review_progress[this.name]=this.checked;}});var success=function(response){last_score=score;$selected_input=votebar.getSelectedInput();locked=false;var id='#sidestats_'+data.generic_id+'_'+data.type_id;var composite_id=data.generic_id+'_'+data.type_id;var search='dl.sidestats[data-statistics="'+composite_id+'"]';var $existing=$(search);var $replacement;if($existing.exists()){var $sidestats=$(response.sidestats);$replacement=$sidestats.filter(search);$existing.replaceWith($replacement);}
if(response.edit&&response.edit.length){var $response_html=$(response.edit);var rid=$('[data-review-id]:first',$response_html).attr('data-review-id');$stars=$('.star-score',$('[data-review-id="'+rid+'"]'));$('span:first',$stars).css('width',(score*10)+"%");$stars.attr('title',(score/2).toFixed(2)+"/5.00");if($xp_info)$xp_info.remove();$xp_info=$('.xp-info',$response_html);if($xp_info.exists())votebar.showXp();}
if(response.replace_sidestats){$('#sidestats').replaceWith(response.sidestats);}
if(response.info&&response.info.length){var info=response.info;var blackout=new ngutils.blackout();var $pod=$(info.pod);$('.pod-body',$pod).append($(info.contents));if(info.blam||info.protect){blackout._onhide=function(){window.location.href=info.redirect;};}
$pod.click(function(){blackout.hide();});blackout.show($pod);}
votebar.voteCallback(response);};locked=true;$.post(url,data,success).fail(function(){locked=false;});return true;};this.showFromLabel=function($label,record){var $radio=$('#'+$label.attr('for'));var v=parseInt($radio.attr('value'));if(record){vote=v;var brightness=5;var setBrightness=function(b){var f=b>1?"brightness("+b+")":"";$label.css({'filter':f,'-webkit-filter':f});};setBrightness(brightness);$({brightness:brightness}).animate({brightness:1},{duration:300,easing:'swing',step:function(){setBrightness(this.brightness);brightness=this.brightness;}});}
this.show(v);};this.clear=function(){this.show(vote);};this.show=function(v){var c='star-reaction';if(v!==null)c+=" reaction-"+v;$reaction.attr('class',c);};if(!is_mobile){$('label',$element).click(function(e){votebar.clickHandler(e,$(this),true);});$('label',$element).hover(function(){votebar.showFromLabel($(this));},function(){votebar.clear();});}else{var over=null;var compare=[];var initTouch=function(){compare=[];$('label',$element).each(function(){var right=$(this).offset().left+$(this).outerWidth();compare.push({label:$(this),right:right});});compare.sort(function(a,b){return a.right>b.right?1:-1;});};var checkTouch=function(e){e.preventDefault();e.stopPropagation();if(over){over.removeClass('hover');}
over=compare[compare.length-1].label;var x=e.originalEvent.touches[0].pageX;for(var i=compare.length-1;i>=0;i--){if(x<=compare[i].right){over=compare[i].label;}else{break;}}
if(over){over.addClass('hover');}
votebar.showFromLabel(over);};$element.on('touchstart',function(e){initTouch();checkTouch(e);});$element.on('touchmove',function(e){checkTouch(e);});$(document).off('touchend').on('touchend',function(e){$('#'+over.attr('for'),$element).prop('checked',true);votebar.clickHandler(e,over,true);over=null;compare=[];$('label',$element).removeClass('hover');});}
$element.on('remove',function(){$(this).off();});};ngutils.color={};ngutils.color.picker=function($element){var _this=this;var last_value;if(typeof($element)=='string')$element=$($element);var updating=false;var $input=$('input[type="text"]',$element).first();ngutils.color.autoid++;var id='__color_picker_swatch'+ngutils.color.autoid;var $picker=$('<input />');$picker.attr('type','color');if(ngutils.color.supportsColorInput()){$picker.attr('id',id);}else{if($input.is('[id]'))id=$input.attr('id');else($input.attr('id',id));}
var $label=$('<label />');$label.attr('for',id);var $wrapper=$('<div />');$wrapper.attr('class','color-picker-swatch');$picker.appendTo($wrapper);$label.appendTo($wrapper);$wrapper.appendTo($element);$picker.outerHeight($input.outerHeight());$picker.outerWidth(30);this.sync=function(value){updating=true;$input.val(value);$picker.val(value);$label.css('background-color',value);last_value=value;updating=false;};this.onChange=function(newval){};this.value=function(value){if(typeof(value)==typeof(undefined))return $input.val();if(value==last_value)return;this.sync(value);this.onChange(this.value());};$input.on("change keyup paste",function(){if(updating)return;var val=$input.val();$input.removeClass('notation');if(!ngutils.color.isValidHexCode(val)){$input.addClass('notation');return;}
if(val==last_value)return;_this.sync(val);_this.onChange(_this.value());});$picker.on("change",function(){if(updating)return;var val=$picker.val();if(val==last_value)return;_this.sync(val);_this.onChange(_this.value());});last_value=$input.val();if(!last_value||!ngutils.color.isValidHexCode(last_value))last_value="#000000";this.sync(last_value);};ngutils.color.autoid=0;ngutils.color.isValidHexCode=function(hex){return /(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(hex);};ngutils.color.supportsColorInput=function(){var colorInput=$('<input type="color" value="!" />')[0];return colorInput.type==='color'&&colorInput.value!=='!';};ngutils.dropmenu=function($btn,$menu){if(typeof($btn)=='string')$btn=$($btn);if(typeof($menu)=='string')$menu=$($menu);var $body=$btn.closest(".blackout-hover");if($body.length<1)$body=$('body').first();$menu.hide().remove();$body.append($menu);var menu_open=false;$('a',$menu).off('click');$('a',$menu).click(function(){return false;});var self=this;this.closeMenu=function(source){if(source!==self){menu_open=false;$menu.animate({height:0},100,function(){$menu.hide();});}};$menu.off('clickOutside');$menu.clickOutside(this.closeMenu);ngutils.event.removeListener(ngutils.event.closeMenus,this.closeMenu);ngutils.event.addListener(ngutils.event.closeMenus,this.closeMenu);$btn.on("remove",function(){$menu.remove();ngutils.event.removeListener(ngutils.event.closeMenus,this.closeMenu);});$btn.off('click');$btn.click(function(e){ngutils.dropmenu.closeOpenMenus(self);if(!menu_open){$menu.show();var full_height=$menu.height('auto').height();$menu.height(0);$menu.css('left',$btn.offset().left+$btn.outerWidth()-$menu.outerWidth());$menu.css('top',$btn.offset().top+$btn.outerHeight());$menu.css('position','absolute');$menu.css('z-index',10002);$menu.attr("tabindex",-1).focus();$menu.animate({height:full_height},100,function(){$menu.height('auto');});menu_open=true;}else{self.closeMenu();}
return false;});};ngutils.dropmenu.closeOpenMenus=function(source_btn){ngutils.event.dispatch(ngutils.event.closeMenus,source_btn);};ngutils.hovertext={};ngutils.hovertext.register=function($target_element,$hover_element){var $e,$h;$e=(typeof($target_element)=='string')?$($target_element):$target_element;$h=(typeof($hover_element)=='string')?$($hover_element):$hover_element;$h.remove();$h.css('position','absolute');$h.css('z-index',500);$('body').first().append($h);$h.hide();var on_hover=false;var on_element=false;function showHover(){var a=42;var c=$e.offset().left+($e.outerWidth()/2);var s=5;var pb=parseInt($h.css('padding-bottom'),10);$h.css('top',$e.offset().top-$h.outerHeight()-s+pb);$h.css('left',c-$h.outerWidth()+a);$h.show();}
function hideHover(){if(!on_element&&!on_hover){$h.hide();}}
$e.mouseover(function(){on_element=true;showHover();});$e.mouseout(function(){on_element=false;setTimeout(hideHover,5);});$e.on('remove',function(){on_element=false;setTimeout(function(){hideHover();$h.remove();},5);});$h.mouseover(function(){on_hover=true;});$h.mouseout(function(){on_hover=false;setTimeout(hideHover,5);});};ngutils.friendship={};ngutils.friendship.registerRequestForm=function(form_id){var $form=$('#'+form_id);var action=$form.attr('action');function onSubmit(e){var params=$form.serializeArray();params.push({name:'userkey',value:PHP.get('uek')});var old=$form.html();$form.html("<em>Please wait...</em>");$.post(action,params,function(data){$form.replaceWith(data);}).fail(function(){$form.html(old);$('[type="submit"]',$form).click(onSubmit);});return false;}
$('[type="submit"]',$form).click(onSubmit);var $cont=$('[data-action="manage"]',$form);var event_name='remove-friend-'+$('input[name="uid"]',$form).val();ngutils.event.addListener(event_name,function(){$cont.html('<p><em class="notation">Un-friended...</em></p>');});$('a',$cont).click(function(e){e.preventDefault();var bo=new ngutils.blackout({remove_on_hide:true});bo.show(ngutils.blackout.spinner);bo.load($(this).attr('href'));return false;});};ngutils.friendship.registerManageButtons=function($container){if(typeof($container)=='string')$container=$($container);$container.removeAttr('id');var _user=$container.attr('data-friend');$manage=$('[data-action="manage"]',$container);$unfriend=$('[data-action="unfriend"]',$container);$manage.click(function(){var blackout=new ngutils.blackout({remove_on_hide:true});blackout.show(ngutils.blackout.spinner);blackout.load($(this).attr('href'));return false;});$unfriend.click(function(){if(confirm("Are you sure you want to unfriend "+_user+"?")){$.post($(this).attr('href'),{userkey:PHP.get('uek')});ngutils.element.fancyRemove($container);}
return false;});};ngutils.fave_follow=function(fave_type,selector,user_key,button_key){var _this=this;var $element=$(selector);var waiting=false;this.common=null;var $reaction_button=$(".reaction-button",$element);var $reaction_options=$(".reaction-options",$element);var $reaction_emote=$(".reaction-emote",$element);var $reaction_text=$(".reaction-text",$element);var reaction_options_visible=false;var reactions_blackout=is_mobile?new ngutils.blackout():null;this.onRefresh=function(data,target){};function showReactionOptions(e){if(e)e.stopPropagation();$reaction_options.show();reaction_options_visible=true;if(is_mobile){$reaction_options.remove();reactions_blackout.show($reaction_options);reactions_blackout.onHide(function(){if(reaction_options_visible)hideReactionOptions();});initEmoteButtons($reaction_options);}
if(_this.common&&_this.common.closeLinked)_this.common.closeLinked();return false;}
function hideReactionOptions(e){if(e)e.stopPropagation();var was_visible=reaction_options_visible;$reaction_options.hide();reaction_options_visible=false;if(is_mobile&&was_visible){reactions_blackout.hide();}
return false;}
this.hideReactionOptions=function(){hideReactionOptions();};$reaction_button.click(function(e){return reaction_options_visible?hideReactionOptions(e):showReactionOptions(e);});if(!is_mobile)$element.hover(showReactionOptions,hideReactionOptions);function initEmoteButtons($container){var $add_button=$("a[data-action='add']",$container);var $remove_button=$("a[data-action='remove']",$container);$add_button.off('click');$remove_button.off('click');$add_button.on('click',function(e){e.stopPropagation();if(waiting)return false;var extra_id=parseInt($(this).attr('data-extra-id'));waiting=true;var ajax_url="/favorites/"+ngutils.fave_follow.types[fave_type]+"/add/"+button_key;if(typeof(extra_id)!='undefined')ajax_url+="/extra/"+extra_id;var data={fave_type:ngutils.fave_follow.types[fave_type],emote_text:$(this).attr('title'),emote_class:$('span',$(this)).first().attr('class')};ngutils.fave_follow.refreshListeners(button_key,true,extra_id,data,_this);var params={userkey:user_key};if(PHP.get('ng_design'))params.___ng_design=PHP.get('ng_design');$.getJSON(ajax_url,params,function(data){waiting=false;ngutils.fave_follow.refreshListeners(button_key,true,extra_id,data,_this);ngutils.reactions.refreshListeners(data.count_key,data,_this);}).fail(function(){waiting=false;ngutils.fave_follow.refreshListeners(button_key,false,extra_id,data,_this);});hideReactionOptions();return false;});$remove_button.on('click',function(e){e.stopPropagation();if(waiting)return false;waiting=true;var ajax_url="/favorites/"+ngutils.fave_follow.types[fave_type]+"/remove/"+button_key;var data={fave_type:ngutils.fave_follow.types[fave_type],emote_text:"React",emote_class:$('span',$(this)).first().attr('class')};ngutils.fave_follow.refreshListeners(button_key,false,0,data,_this);var params={userkey:user_key};if(PHP.get('ng_design'))params.___ng_design=PHP.get('ng_design');$.getJSON(ajax_url,params,function(data){waiting=false;ngutils.fave_follow.refreshListeners(button_key,false,0,data,_this);ngutils.reactions.refreshListeners(data.count_key,data,_this);}).fail(function(){waiting=false;});hideReactionOptions();return false;});}
initEmoteButtons($element);this.refresh=function(active,extra_id,data,target){if(data.fave_type==='reaction'){$reaction_emote.attr('class',data.emote_class+" reaction-emote");$reaction_text.html(data.emote_text);if(!active)$reaction_text.removeClass('active');else $reaction_text.addClass('active');$('a.active',$reaction_options).removeClass('active');$('a[data-extra-id="'+extra_id+'"]',$element).addClass('active');}else{if(typeof(extra_id)===typeof(undefined)||isNaN(extra_id)){$element.removeAttr('data-extra-id');}else{$element.attr('data-extra-id',extra_id);}
if(active)$element.addClass('active');else $element.removeClass('active');}
this.onRefresh(data,target);};ngutils.fave_follow.listeners[button_key]=ngutils.fave_follow.listeners[button_key]||[];ngutils.fave_follow.listeners[button_key].push(this);};ngutils.fave_follow.listeners={};ngutils.fave_follow.FOLLOW=1;ngutils.fave_follow.FAVORITE=2;ngutils.fave_follow.REACTION=3;ngutils.fave_follow.types={};ngutils.fave_follow.types[ngutils.fave_follow.FOLLOW]='follow';ngutils.fave_follow.types[ngutils.fave_follow.FAVORITE]='favorite';ngutils.fave_follow.types[ngutils.fave_follow.REACTION]='reaction';ngutils.fave_follow.refreshListeners=function(button_key,active,extra_id,data,target){if(ngutils.fave_follow.listeners[button_key]){for(var i=0,len=ngutils.fave_follow.listeners[button_key].length;i<len;i++){ngutils.fave_follow.listeners[button_key][i].refresh(active,extra_id,data,target);}}
if(data.dispatchEvent&&data.dispatchEvent.event){ngutils.event.dispatch(data.dispatchEvent.event,data.dispatchEvent.data);}};ngutils.initFollowButton=function(selector,user_key,button_key){return new ngutils.fave_follow(ngutils.fave_follow.FOLLOW,selector,user_key,button_key);};ngutils.initFavoriteButton=function(selector,user_key,button_key){return new ngutils.fave_follow(ngutils.fave_follow.FAVORITE,selector,user_key,button_key);};ngutils.reactions={};ngutils.reactions.totals={};ngutils.reactions.linked=[];ngutils.reactionBlackout=null;ngutils.reactions.refreshListeners=function(key,data,target){if(ngutils.reactions.totals[key]&&ngutils.reactions.totals[key].length>0){for(var i=0;i<ngutils.reactions.totals[key].length;i++){var rt=ngutils.reactions.totals[key][i];rt.onAjaxUpdate(data);}}};ngutils.initReactionLink=function(common_id,prop,val){if(!common_id)return null;if(!ngutils.reactions.linked[common_id])ngutils.reactions.linked[common_id]={};ngutils.reactions.linked[common_id][prop]=val;return ngutils.reactions.linked[common_id];};ngutils.initReactionTotals=function(selector,item_type,item_id,common_id,extra_id){var key=item_type+"-"+item_id;if(!ngutils.reactions.totals[key])ngutils.reactions.totals[key]=[];var $total=$(selector);var common=ngutils.initReactionLink(common_id,'totals',$total);ngutils.reactions.totals[key].push($total);function hideTotals(e){if(ngutils.reactionBlackout){ngutils.reactionBlackout.onHide(null);ngutils.reactionBlackout.hide();}
return false;}
common.closeLinked=$total.closeDetails=function(){hideTotals();};function showTotals(e){if(e)e.stopPropagation();if(common&&common.button)common.button.hideReactionOptions();var base_url="/favorites/reactions/type/"+item_type+"/id/"+item_id;if(ngutils.reactionBlackout)ngutils.reactionBlackout.hide();ngutils.reactionBlackout=new ngutils.blackout({remove_on_hide:true});ngutils.reactionBlackout.show(ngutils.blackout.spinner);ngutils.reactionBlackout.onHide(hideTotals);$.get(base_url,function(data){if(!data)return;$child=$(data);ngutils.reactionBlackout.show($child);ngutils.initReactionUsers(item_type,item_id,$child);});return false;}
$total.click(function(e){if(extra_id===null){return showTotals(e);}
ngutils.showReactionUsers(item_type,item_id,extra_id);return false;});$total.onAjaxUpdate=function(data){extra_id=data.inner_extra_id;$total.html(data.count_html);$total.closeDetails();};};ngutils.showReactionUsers=function(item_type,item_id,extra_id){if(ngutils.reactionBlackout){ngutils.reactionBlackout.fade_out=false;ngutils.reactionBlackout.hide();}
ngutils.reactionBlackout=new ngutils.blackout({remove_on_hide:true,fade_in:false});var url="/favorites/reactions/type/"+item_type+"/id/"+item_id+"/reaction/"+extra_id;ngutils.reactionBlackout.show(ngutils.blackout.spinner);ngutils.reactionBlackout.load(url);};ngutils.initReactionUsers=function(item_type,item_id,$child){if(!$child)$child=$('body').first();else if(typeof($child)=='string')$child=$($child);$('[data-extra-id]',$child).click(function(e){if(e){e.preventDefault();e.stopPropagation();}
var extra_id=$(this).attr('data-extra-id');ngutils.showReactionUsers(item_type,item_id,extra_id);return false;});};ngutils.initReactionButton=function(selector,user_key,button_key,common_id){var ff=new ngutils.fave_follow(ngutils.fave_follow.REACTION,selector,user_key,button_key);ff.common=ngutils.initReactionLink(common_id,'button',ff);return ff;};ngutils.emote={};ngutils.emote.clickSelector=function($input,$icon,event){if(event)event.preventDefault();$input=$($input);$icon=$($icon);let selected=$input.val();let uri="/emoteselect";if(selected)uri+="/"+selected;let bo=new ngutils.blackout({remove_on_hide:true});let $selector;let init=function(){let $inputs=$("input[type='radio']",$selector);$inputs.change(()=>{let $checked=$('input[type="radio"]:checked',$selector).first();$input.val($checked.val());let _for=$checked.attr('id');let $label=$('label[for="'+_for+'"]',$selector);let $span=$('span',$label);$icon.attr('class',$span.attr('class'));bo.hide();});ngutils.event.dispatch(ngutils.event.emoteSelectLoaded,$inputs);};bo.load(uri,function(){$selector=$('#active-emote-selector',bo.getLayerElement()).removeAttr('id');init();ngutils.event.addListener(ngutils.event.emoteSetChanged,function($select){if($selector.has($select))init();});});};ngutils.flagging_options={};ngutils.flagging_options.blackout=new ngutils.blackout({"remove_on_hide":true});ngutils.flagging_options.close=function(callback){if(PHP.get('nodimming')){PHP.get('nodimming').addClass('nodimming');}
if(typeof callback==='function'){callback();}else{ngutils.flagging_options.blackout.hide();return false;}};ngutils.flagging_options.watchFormPage=function(){var commentIsRequired=function(){return $.rInArray(parseInt($('#flag_form input[type="radio"]:checked').val(),10),PHP.get('flag_types_needing_comment'));};var setUpCommentRequired=function(){if(commentIsRequired()){$('#flag_form span.required').show();$('#flag_comment').attr('required',true);}else{$('#flag_comment').removeAttr('required');$('#flag_form span.required').hide();}
return true;};var that;if($('#flag_comment').exists()){$('#flag_comment').on('focus blur',setUpCommentRequired).focus();}
$('#flag_form input[type="radio"]').off('click').on('click',setUpCommentRequired);$('#flag_form').on('submit',function(){that=$(this);$(this).ajaxSubmit(function(response){var element=$('#'+PHP.get('flag_element_clicker'));if(response&&response.url){element.attr('href',response.url);}else if(element&&element.exists()){element.remove();}
ngutils.flagging_options.close(function(){if(response.success){ngutils.flagging_options.blackout.show($(response.success));}else{alert("Your report has been submitted!");ngutils.flagging_options.blackout.hide();}});});return false;});$('#flag_close').on('click',ngutils.flagging_options.close);};ngutils.flagging_options.register=function(object,data){data=data||{};$(object).on('click',function(){if($('.nodimming').exists()){PHP.set('nodimming',$('.nodimming'));}
PHP.set('flag_element_clicker',$(this).attr('id'));ngutils.flagging_options.blackout.load(this.href,data,function(response){if($('.nodimming').exists()){$('.nodimming').removeClass('nodimming');}
ngutils.flagging_options.watchFormPage();});return false;});};ngutils.sharebox={};ngutils.sharebox.blackout=null;ngutils.sharebox.watch=function(){var iOSCopyText=function(el){var n,contentEditable=el.contentEditable,readOnly=el.readOnly,d=el.disabled;el.contentEditable=true;el.readOnly=false;el.disabled=false;var range=document.createRange();range.selectNodeContents(el);var s=window.getSelection();s.removeAllRanges();s.addRange(range);el.setSelectionRange(0,999999);el.contentEditable=contentEditable;el.readOnly=readOnly;el.disabled=d;document.execCommand('copy');};var copyText=function($select_input,$confirmation_object){var content=$select_input.val();if(!iOS){$select_input.select();document.execCommand("copy");$select_input.selectionEnd=$select_input.selectionStart;$select_input.blur();}else{iOSCopyText($select_input[0]);}
if($confirmation_object&&$confirmation_object.length){$confirmation_object.show();setTimeout(function(){$confirmation_object.fadeOut(500);},750);}};var pod=$('#share_content_pod');$("[data-action='copy-input']").each(function(){var $element=$(this);$element.removeAttr('data-action');var $input=$('input',$element);var $a=$('a',$element);var doCopy=function(){copyText($input,$(".check-fader",$a));};if(iOS){$input.prop('readonly',true);$input.css({'-webkit-touch-callout':'none','-webkit-user-select':'none','-webkit-tap-highlight-color':'rgba(0,0,0,0)'});}
$input.click(doCopy);$a.click(doCopy);$input.keypress(function(){return false;});});};ngutils.sharebox.register=function($el){if(null===ngutils.sharebox.blackout){ngutils.sharebox.blackout=new ngutils.blackout({"remove_on_hide":true});}
$el.click(function(){var h=this.href;ngutils.sharebox.blackout.load(h,null,function(response){ngutils.sharebox.watch();});return false;});};ngutils.playlist_form={};ngutils.playlist_form.blackout=null;ngutils.playlist_form.watch=function(){var pod=$('#playlist_add');var myform=$('form',pod);myform.submit(function(){$(this).ajaxSubmit(function(response){if(response&&response.url){window.location.href=response.url;}else{ngutils.playlist_form.blackout.hide();}});});$('a.icon-close',pod).click(function(){ngutils.playlist_form.blackout.hide();});};ngutils.playlist_form.register=function($el){if(null===ngutils.playlist_form.blackout){ngutils.playlist_form.blackout=new ngutils.blackout({"remove_on_hide":true});}
$el.click(function(){var h=this.href;ngutils.playlist_form.blackout.load(h,null,function(response){ngutils.playlist_form.watch();});return false;});};ngutils.forms={};ngutils.forms.registerDateInput=function(input){var $input=$(input);if($input.attr('data-registered'))return;function onChange(){if($input.val()){$input.addClass('date-focused');}else{$input.removeClass('date-focused');}}
$input.attr('data-registered',1);$input.change(onChange);onChange();};ngutils.forms.selectAltLabels={};ngutils.forms.selectAltLabels.autodetect=function(){$(".select-wrapper.alternate-label").each(function(){let $select=$('select',$(this));let $label=$('span.label',$(this));function updateMe(){let $option=$('option[value="'+$select.val()+'"]',$select);let txt;if($option.is('[data-label]')){txt=$option.attr('data-label');}else{txt=$option.html();}
$label.html(txt);}
$select.change(function(){updateMe();});updateMe();});};ngutils.forms.selectLinks={};ngutils.forms.selectLinks.autodetect=function(){$('[data-select-links]').change(function(){var url=($(this).val());if(url){window.location=url;}});};ngutils.forms.fakeSelect={};ngutils.forms.fakeSelect.autodetect=function(){$('.faux-select:not(.ready)').each(function(){$(this).addClass('ready');var select=$(this);var options=$('span.options',select);var bubble=true;ngutils.event.addListener(ngutils.event.closeall,function(){if(bubble)select.removeClass('expanded');bubble=true;});$('a',$(this)).click(function(){bubble=false;});$('ul',$(this)).click(function(){if(bubble)return false;});$(this).click(function(){if($(this).hasClass('expanded')){$(this).removeClass('expanded');}else{ngutils.event.dispatch(ngutils.event.closeall);$(this).addClass('expanded');options.outerWidth(select.outerWidth());}
if(bubble)return false;});$(window).scroll(function(){if(select.hasClass('expanded')){select.removeClass('expanded');}});});};ngutils.image={view:(src,event)=>{if(event)event.preventDefault();let img=new Image();img.onload=()=>{let start_at={};let drag=false;let $container;let bo=new ngutils.blackout({remove_on_hide:true});bo.show(img);if(is_mobile){$(img).click(()=>{bo.hide();});}else{bo.onRemove(()=>{$(img).off(ngutils.input.mouseDown,startDrag);$(document).off(ngutils.input.mouseMove,doDrag);$(document).off(ngutils.input.mouseUp,endDrag);});let doDrag=(e)=>{if(drag){let mx=e.pageX-drag.x;let my=e.pageY-drag.y;drag={x:e.pageX,y:e.pageY};bo.$elements.hover.scrollLeft(bo.$elements.hover.scrollLeft()-mx);bo.$elements.hover.scrollTop(bo.$elements.hover.scrollTop()-my);}};let startDrag=(e)=>{start_at.x=e.pageX;start_at.y=e.pageY;drag=start_at;return false;};let endDrag=(e)=>{drag=false;if(start_at.x===e.pageX&&start_at.y===e.pageY)bo.hide();};$(img).on(ngutils.input.mouseDown,startDrag);$(document).on(ngutils.input.mouseMove,doDrag);$(document).on(ngutils.input.mouseUp,endDrag);}};img.src=src;}};ngutils.element={};ngutils.element.fancyAdd=function($element,callback,delay){let height=$element.height();$element.show();$element.height(0);$element.hide();if(typeof(callback)==='number'){delay=callback;callback=null;}
let doFancyAdd=function(){$element.show().css('visibility','hidden');$element.animate({height:height},150,function(){$element.hide().css('height','').css('visibility','').fadeIn(300,()=>{if(callback)callback();});});};if(delay){setTimeout(doFancyAdd,delay);}else{doFancyAdd();}};ngutils.element.fancyHide=function($element,callback,delay){if(typeof(callback)==='number'){delay=callback;callback=null;}
if(delay){setTimeout(()=>{ngutils.element.fancyRemove($element,callback);},delay);return;}
$element.fadeOut(300,function(){$element.show();$element.css('visibility','hidden');$element.animate({height:0},150,function(){$element.css('visibility','').css('height','').hide();if(callback)callback();});});};ngutils.element.fancyRemove=function($element,callback,delay){if(typeof(callback)==='number'){delay=callback;callback=null;}
if(delay){setTimeout(()=>{ngutils.element.fancyRemove($element,callback);},delay);return;}
$element.fadeOut(300,function(){$element.show();$element.css('visibility','hidden');$element.animate({height:0},150,function(){$element.remove();if(callback)callback();});});};ngutils.element.isOnScreen=function($element,buffer,fixed){if(!buffer)buffer=0;$element=$($element);var eTop;if(fixed)eTop=$element.position().top;else eTop=$element.offset().top;var eBot=eTop+$element.outerHeight();var wTop=fixed?0:$(window).scrollTop();var wBot=wTop+$(window).height();return((eTop-buffer<wBot)&&(eBot+buffer>wTop));};ngutils.element.loadWhenOnscreen=function($element,ajax_url,scroll_buffer,$container){$element=$($element);var _this=this;this.onReady=function(){};this.onScrolledTo=function(){};this.onLoaded=function(){};this.onComplete=function(){};this.onFailed=function(){};var wos=ngutils.element.whenOnscreen($element,function(){if(_this.onScrolledTo()===false){_this.onComplete();return;}
if(ajax_url){$.get(ajax_url,function(data){if(_this.onLoaded(data)===false){_this.onComplete();return;}
$element.replaceWith(data);$('body').hide().show(0);_this.onComplete();}).fail(function(e){_this.onFailed(e);});}},scroll_buffer,$container);setTimeout(function(){wos.onReady=_this.onReady;},3);return this;};ngutils.element.whenOnscreen=function($element,callback,scroll_buffer,$container){$element=$($element);var _this=this;this.onReady=function(){};if(!$container){$container=$element.closest(".blackout-hover");if($container.length<1)$container=$(window);}
var fixed=$container[0]!==window;function onScroll(e){if(ngutils.element.isOnScreen($element,scroll_buffer,fixed)){$container.off('scroll',onScroll);if(callback)callback();}}
setTimeout(function(){if($element.length===1){if(_this.onReady()===false)return;$container.on('scroll',onScroll);onScroll();}else{console.warn("Invalid element");}},5);return this;};ngutils.element.autoCondense=function(){$('.condensed').each(function(){ngutils.element.condense($(this));});};ngutils.element.condense=function(element,more_text){var $condensed=$(element);if(!$condensed||$condensed.length<1)return;var $parent=$condensed.parent();var position=$parent.css('position').toLowerCase();if(position!='fixed'&&position!='absolute'&&position!='relative'){$parent.css('position','relative');}
var max_height=parseInt($condensed.css('max-height').replace(/[^-\d\.]/g,''));$condensed.removeClass('condensed');$condensed.css('max-height',"100%");if(isNaN(max_height)||max_height<1)return;var full_height=$condensed.height();var height_allowance=140;if(full_height-height_allowance<=max_height)return;$condensed.addClass('condensed-processed');$condensed.css('max-height',max_height);if(!more_text)more_text=$condensed.attr("data-expand-text");if(!more_text)more_text="Read More...";var $expand=$("<div>",{class:"expand-condensed",html:more_text});$expand.click(function(){$condensed.css("max-height","100%");$condensed.trigger('expanded');$(this).remove();});$condensed.after($expand);};ngutils.element.editable=function(element,editing){var $e=$(element);var editable=this;var $toggle_btn;var toggle_params=[null,null];this._editing=editing?true:false;this.setEditing=function(ed){$e.removeClass('edit-on').removeClass('edit-off');if(ed)$e.addClass('edit-on');else $e.addClass('edit-off');editable._editing=ed?true:false;if($toggle_btn&&$toggle_btn.length>0){var i=editable._editing?1:0;$toggle_btn.html(toggle_params[i]);}
return this;};this.toggle=function(){if(editable._editing)this.setEditing(false);else this.setEditing(true);return this;};this.setToggleButton=function(button,edit_text,noedit_text,callback,thisArg){$toggle_btn=$(button);if(!noedit_text)noedit_text=$toggle_btn.html();if(!edit_text)edit_text=noedit_text;toggle_params[0]=noedit_text;toggle_params[1]=edit_text;toggle_params[2]=typeof(callback)=='function'?callback:null;toggle_params[3]=thisArg?thisArg:$toggle_btn;this.setEditing(this._editing);$toggle_btn.click(function(e){editable.toggle();if(toggle_params[2]){return toggle_params[2].call(toggle_params[3],e);}else{return false;}});return this;};if(editing)this.setEditing(editable._editing);else if($e.hasClass('edit-on'))this.setEditing(true);else this.setEditing(false);};ngutils.element.editable.prototype={get editing(){return this._editing;},set editing(editing){this.setEditing(editing);}};ngutils.media={};ngutils.media.smartscale=function($element){if(!$element.attr('data-smart-scale'))return;var dimensions=$element.attr('data-smart-scale').split(",");var width=dimensions[0].indexOf("%")<0?parseInt(dimensions[0]):dimensions[0];var height=dimensions[1].indexOf("%")<0?parseInt(dimensions[1]):dimensions[1];var cw=null;var $closest=$element.parent();var parent_selectors=['.scale-to-this','.blog-embed-left','p','.blog-post-body','.ql-body','.pod-body'];var s,$p;for(s=0;s<parent_selectors.length;s++){$p=$element.closest(parent_selectors[s]);if($p&&$p.length>0&&($p.width()>0||$p.attr('data-scale-width'))){$closest=$p;break;}}
if(!$closest.width()&&!$closest.attr('data-scale-width')){$element.css('width','100%');return false;}
$element.removeAttr('data-smart-scale');function setDimensions(){var pw=$closest.attr('data-scale-width')?parseFloat($closest.attr('data-scale-width')):$closest.width();$closest.removeAttr('data-scale-width');if(pw===cw)return;var nw=width;var nh=height;if(typeof(nw)=='number'&&pw<width){nw=pw;if(typeof(nh)=='number'){var scale=pw/width;nh=Math.round(height*scale);}}
if(nw==cw)return;var css_class='media-block-center';var css_inline={'width':nw,'height':nh};if(!is_mobile&&pw>nw&&nw<pw/2)css_class='media-inline-auto';$element.removeClass('media-inline-auto');$element.removeClass('media-block-center');var $media_element=$element;if(css_class=='media-block-center'){var $img_container=$element.parent('.ng-img-container').first();if($img_container.length>0){$media_element=$img_container;}}
$media_element.addClass(css_class);$element.css(css_inline);cw=nw;$element[0].dispatchEvent(new Event('rescaled'));}
if(is_mobile){$(window).resize(setDimensions);}
setDimensions();this.refresh=function(){setDimensions();};};ngutils.media.smartscale.autodetect=function(){$('[data-smart-scale]').each(function(){new ngutils.media.smartscale($(this));});};ngutils.media.smartload=function($element){var self=this;var src=$element.attr('data-smartload-src');var y_buffer=400;var $container=$element.closest("div[class^='condensed']");if(!$container||$container.length<1)$container=null;if($container){var cropped_at=$container.offset().top+$container.innerHeight();if($element.offset().top<cropped_at)$container=null;}
$element.removeAttr('data-smartload-src');ngutils.element.whenOnscreen($element,()=>{$element.attr('src',src);if($element.attr('data-smartload-event')){ngutils.event.dispatch($element.attr('data-smartload-event'),$element);}},y_buffer);};ngutils.media.smartload.autodetect=function(){$('[data-smartload-src]').each(function(){new ngutils.media.smartload($(this));});};ngutils.media.item=function(id){this.id=id?id:null;this.sources={};};ngutils.media.item.prototype={qualities:[],addSource:function(src,type,quality){if(!quality)quality=this.qualities[0];if(this.qualities.indexOf(quality)<0)console.error("Invalid media quality: "+quality);if(!this.sources[quality])this.sources[quality]=[];this.sources[quality].push({src:src,type:type});},getAvailableQualities:function(){var qs=[];for(var i=0;i<this.qualities.length;i++){if(this.sources[this.qualities[i]])qs.push(this.qualities[i]);}
return qs;}};ngutils.media.audio=function(){ngutils.media.item.apply(this,arguments);this.qualities=['mp3'];this.type='audio';this.html="";var self=this;var base_url="/audio/load/";this.load=function(callback){var data={};if(is_mobile)data.isMobile=true;$.ajax({dataType:"json",url:base_url+this.id,async:true,data:data,success:function(data){if(data.error){console.error(data.error);}else if(data.html&&data.sources){for(var i=0;i<data.sources.length;i++){self.addSource(data.sources[i].src,data.sources[i].type);}
self.html=data.html;if(typeof(callback)=='function')callback();}else{console.error("Unexpected Server Response from "+base_url+self.id,data);}}});};};ngutils.media.audio.prototype=Object.create(ngutils.media.item.prototype);ngutils.media.audio.prototype.constructor=ngutils.media.audio;Object.defineProperty(ngutils.media.audio,'volume',{get:function(){var vol=ngutils.local.getItem('ng-audio-vol',1);vol=parseFloat(vol);if(isNaN(vol))vol=1;return vol;},set:function(vol){vol=parseFloat(vol);if(isNaN(vol))vol=1;ngutils.local.setItem('ng-audio-vol',vol);}});ngutils.media.video=function(){ngutils.media.item.apply(this,arguments);this.qualities=['1080p','720p','360p'];this.type='video';};ngutils.media.video.prototype=Object.create(ngutils.media.item.prototype);ngutils.media.video.prototype.constructor=ngutils.media.video;ngutils.media.playlist=function(type){this._items=[];this._shuffled=[];this._shuffle=false;this._current_index=0;this.type=type;};ngutils.media.playlist.prototype={addMedia:function(title,callback){var source;switch(this.type){case'audio':source=new ngutils.media.audio(title);break;case'video':source=new ngutils.media.video(title);break;default:throw("Invalid media type: "+this.type);}
if(typeof(callback)=='function')callback(source);this.add(source);return this;},add:function(media_item){var i=this._items.length;this._items.push(media_item);},clear:function(){this._items=[];this._shuffled=[];this._shuffle=false;this._current_index=0;},_doshuffle:function(){this._shuffled=[];var j,x,i;for(i=0;i<this._items.length;i++){if(this._shuffled.length){x=Math.floor(Math.random()*this._shuffled.length);this._shuffled.splice(x,0,i);}else{this._shuffled.push(i);}}},toggleShuffle:function(){this.shuffle(!this._shuffle);if(this._shuffle)this._doshuffle();},shuffle:function(shuffle){if(typeof(shuffle)===typeof(undefined))return this._shuffle;shuffle=shuffle?true:false;if(shuffle!=this._shuffle){this._current_index=0;this._shuffle=shuffle;if(this._shuffle)this._doshuffle();}
return this;},setCurrentItem:function(media){var bookmark=this._current_index;for(this._current_index=0;this._current_index<this._items.length;this._current_index++){if(this.getCurrentItem()==media){return true;}}
this._current_index=bookmark;return false;},getCurrentItem:function(){if(this._current_index<0||this._current_index>=this._items.length)return null;if(this._shuffle){return this._items[this._shuffled[this._current_index]];}
return this._items[this._current_index];},forward:function(can_loop){if(this._current_index>=0)this._current_index++;else this._current_index=0;if(this._current_index>=this._items.length){if(!can_loop){return null;}
this._current_index=0;}
return this.getCurrentItem();},reverse:function(can_loop){if(this._current_index<this._items.length)this._current_index--;else this._current_index=this._items.length-1;if(this._current_index<0){if(!can_loop){return null;}
this._current_index=this._items.length-1;}
return this.getCurrentItem();}};ngutils.media.getPlaylist=function(type){var playlist=new ngutils.media.playlist();playlist.type=type=='video'?'video':'audio';return playlist;};ngutils.media.player=function($player_element,$controls_element,$display_element){this.wait_for_async=false;this.$player_element=null;this.$controls_element=null;this.$display_element=null;this.controls=null;this.type=null;this.autoplay=false;this._loop=false;this._shuffle=false;this.active=false;this.playing=false;this.paused=false;this.skip_forward_time=15;this.skip_back_time=15;this.media_playlist=null;this.current_media_item=null;this.quality="default";if(!$player_element)throw('Missing $player_element');if(typeof($player_element)=='string')$player_element=$("#"+$player_element);if(!$controls_element&&!$player_element.is('audio')){$controls_element=$player_element;$player_element=$('audio',$controls_element).first();}
if(!$display_element){$display_element=$('.media-player-display',$controls_element).first();}
this.onPressPlay=function(){};this.onPressStop=function(){};this.onPressPause=function(){};this.onPressSkipForward=function(){};this.onPressSkipBack=function(){};this.onPressPlayNext=function(){};this.onPressPlayPrevious=function(){};this.onPressLoop=function(){};this.onPressFullscreen=function(){};this.onPressShuffle=function(){};this.onTimeChange=function(newtime){};this.onVolumeChange=function(newvolume){};this.onPlaybackStarted=function(){};this.onPlaybackEnded=function(){};this.onLoopEnabled=function(){};this.onLoopDisabled=function(){};this.onShuffleEnabled=function(){};this.onShuffleDisabled=function(){};this.onMediaPaused=function(media){};this.onMediaUnpaused=function(media){};this.onMediaStarted=function(media){};this.onMediaEnded=function(media){};this.onMediaLoaded=function(media){};this.setCurrentTitle=function(){};this.registerAudioElement($player_element);if($controls_element)this.registerControls($controls_element);if($display_element)this.registerDisplay($display_element);};ngutils.media.player.prototype={activate:function(){this.active=true;this.$controls_element.addClass('active');},deactivate:function(){this.active=false;this.$controls_element.removeClass('active');},loop:function(loop){if(typeof(loop)===typeof(undefined)){return this._loop;}
this._loop=loop?true:false;if(this._loop){this.onLoopEnabled();}else{this.onLoopDisabled();}
this.updateControls();return this;},shuffle:function(shuffle){if(typeof(shuffle)===typeof(undefined)){return this._shuffle;}
this._shuffle=shuffle?true:false;if(this._shuffle){this.onShuffleEnabled();}else{this.onShuffleDisabled();}
if(this.media_playlist)this.media_playlist.shuffle(this._shuffle);this.updateControls();return this;},endMedia:function(){if(this.playing||this.paused){this.onMediaEnded(this.current_media_item);}
this.playing=false;this.paused=false;},updateControls:function(){this.controls.play.removeClass('active');this.controls.pause.removeClass('active');this.controls.play_pause.removeClass('active');this.controls.play_pause.removeClass('paused');this.controls.shuffle.removeClass('active');this.controls.loop.removeClass('active');this.controls.fullscreen.removeClass('active');if(this.playing){this.controls.play.addClass('active');this.controls.play_pause.addClass('active');}else if(this.paused){this.controls.play_pause.addClass('active');this.controls.play_pause.addClass('paused');this.controls.pause.addClass('active');}
if(this.media_playlist){this.controls.play_next.show();this.controls.play_previous.show();this.controls.shuffle.show();}else{this.controls.play_next.hide();this.controls.play_previous.hide();this.controls.shuffle.hide();}
if(this.loop()){this.controls.loop.addClass('active');}
if(this.shuffle()){this.controls.shuffle.addClass('active');}
if(this.controls.position_bar)this.controls.position_bar.updateBarBounds();},setDisplay:function(html){if(this.$display_element)this.$display_element.html(html);},setStopped:function(){this.endMedia();if(this.active){this.onPlaybackEnded();}
this.deactivate();this.updateControls();},setPlaying:function(){if(!this.active){this.onPlaybackStarted();}
if(!this.playing&&this.paused){this.onMediaUnpaused(this.current_media_item);}else if(!this.playing){this.onMediaStarted(this.current_media_item);}
this.activate();this.playing=true;this.paused=false;this.updateControls();},setPaused:function(){if(this.playing&&!this.paused){this.onMediaPaused(this.current_media_item);}
this.playing=false;this.paused=true;this.updateControls();},setMedia:function(media_item){var $player=this.$player_element;var self=this;if(!$player||$player.length<1)return false;if(this.current_media_item==media_item)return false;this.initForAsynch(function(){media_item.load(function(){self.onMediaLoaded(media_item);self.doSetMedia(media_item);});});},initForAsynch:function(callback){var $player=this.$player_element;var self=this;if($('source',$player).length<1){var sources=[];if($player.is('audio')){sources.push({src:PHP.get('www_root')+"/content/micro.mp3",type:"audio/mpeg"});}
if(sources.length>0){this.wait_for_async=true;this.setCurrentSources(sources);setTimeout(function(){self.wait_for_async=false;callback();},150);return;}}
callback();},setCurrentSources:function(sources){var $player=this.$player_element;$player.html("");var $source;for(i=0;i<sources.length;i++){$source=$("<source/>");$source.attr('src',sources[i].src);$source.attr('type',sources[i].type);$player.append($source);}
$player[0].pause();$player[0].load();$player[0].currentTime=0;},doSetMedia:function(media_item){this.current_media_item=media_item;var $player=this.$player_element;var i,q=null;var qa=media_item.getAvailableQualities();for(i=0;i<qa.length;i++){if(!q)q=qa[i];if(qa[i]==this.quality){q=qa[i];break;}}
var sources=media_item.sources[q];this.setCurrentSources(sources);this.setCurrentTitle(media_item.title);var self=this;if((!this.playing&&self.autoplay)||this.playing){setTimeout(function(){self.play();},150);}
return(sources.length>0);},setPlaylist:function(media_playlist){this.media_playlist=media_playlist;if(media_playlist){media_playlist.shuffle(this.shuffle());this.setMedia(media_playlist.getCurrentItem());}},canPlay:function(){var $player=this.$player_element;if(!$player||$player.length<1)return false;var canplay=false;$('source',$player).each(function(){var format=$(this).attr('type');var c=$player[0].canPlayType(format);if(c=='probably'||c=='maybe')canplay=c;});return canplay?canplay:false;},initVolume:function(){var volume=ngutils.media.audio.volume;this.$player_element[0].volume=volume;this.controls.volume_bar.setPosition(volume);},setVolume:function(volume){if(volume>1)volume=1;else if(volume<0)volume=0;this.$player_element[0].volume=volume;ngutils.media.audio.volume=volume;this.onVolumeChange(volume);},play:function(){if(!this.canPlay())return false;this.$player_element[0].play();this.setPlaying();return true;},pause:function(){if(!this.canPlay())return false;this.$player_element[0].pause();this.setPaused();return true;},stop:function(){if(!this.canPlay())return false;this.$player_element[0].pause();this.$player_element[0].currentTime=0;this.setStopped();return true;},skip_forward:function(){if(!this.canPlay())return false;var mt=this.$player_element[0].currentTime+this.skip_forward_time;if(mt>this.$player_element[0].duration)mt=this.$player_element[0].duration;this.$player_element[0].currentTime=mt;return true;},skip_back:function(){if(!this.canPlay())return false;var mt=this.$player_element[0].currentTime-this.skip_back_time;if(mt<0)mt=0;this.$player_element[0].currentTime=mt;return true;},play_next:function(){var media=false;if(this.media_playlist){media=this.media_playlist.forward(this.loop());}
if(media){this.endMedia();this.current_media_item=null;this.setMedia(media);return media;}
this.stop();return false;},play_previous:function(){var media=false;if(this.media_playlist){media=this.media_playlist.reverse(this.loop());}
if(media){this.endMedia();this.current_media_item=null;this.setMedia(media);return media;}
this.stop();return false;},end:function(){this.setStopped();},getTimeFormat:function(s,ms_length){var seconds=s;if(isNaN(seconds))return[0,0,0,0];var hours=Math.floor(seconds / 60 / 60);seconds-=hours*60*60;var minutes=Math.floor(seconds / 60);seconds-=minutes*60;var format=[];if(hours>0){hours=""+hours;format.push(hours.length);format.push(2);format.push(2);return format;}else{format.push(0);}
if(minutes>=10){format.push(2);}else{format.push(1);}
format.push(2);format.push(ms_length?ms_length:0);return format;},formatTime:function(s,format){var seconds=s;if(isNaN(seconds))return"--:--:--";if(!format)format=this.getTimeFormat(seconds);var hours=Math.floor(seconds / 60 / 60);seconds-=hours*60*60;var minutes=Math.floor(seconds / 60);seconds-=minutes*60;seconds=Math.round(seconds*100);var ms=(seconds%100);seconds=((seconds-ms)/100);time="";if(format[0]>0){hours=""+hours;while(hours.length<format[0]){hours="0"+hours;}
time=time+hours+":";}
if(format[1]>0){minutes=""+minutes;while(minutes.length<format[1]){minutes="0"+minutes;}
time=time+minutes+":";}
if(format[2]>0){seconds=""+seconds;while(seconds.length<format[2]){seconds="0"+seconds;}
time=time+seconds;}
if(format[3]>0){ms=""+ms;while(ms.length<format[3]){ms=ms+"0";}
time=time+"."+ms;}
return time?time:"--:--:--";},handleMediaEnded:function(){if(this.wait_for_async)return;if(this.media_playlist){this.play_next();}else if(this.loop()){this.play();}else{this.end();}},registerAudioElement:function($player_element){if(typeof($player_element)=='string')$player_element=$("#"+$player_element);if($player_element.is('audio')){this.type='audio';}else if($player_element.is('video')){this.type='video';}else{throw("Invalid $player_element");}
var self=this;$player_element.on('ended',function(){self.handleMediaEnded();});this.$player_element=$player_element;},refreshTime:function(){var ct=this.$player_element[0].currentTime;var d=this.$player_element[0].duration;var format=this.getTimeFormat(d);this.controls.current_time.html(this.formatTime(ct,format));this.controls.duration.html(this.formatTime(d,format));this.onTimeChange(ct);},toggleFullScreen:function(){var fs=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;var elem,req;if(fs){elem=document;req=elem.exitFullScreen||elem.webkitExitFullscreen||elem.mozCancelFullScreen;}else{elem=this.$controls_element[0];req=elem.requestFullScreen||elem.webkitRequestFullscreen||elem.mozRequestFullScreen;}
if(req)req.call(elem);},registerDisplay:function($display_element){if(typeof($display_element)=='string')$display_element=$("#"+$display_element);this.$display_element=$display_element;},registerControls:function($controls_element){if(typeof($controls_element)=='string')$controls_element=$("#"+$controls_element);this.$controls_element=$controls_element;if(this.controls){for(var i in this.controls){this.controls[i].off();}}
var controls={title:$(".media-player-title",$controls_element).first(),play:$(".media-player-play",$controls_element).first(),pause:$(".media-player-pause",$controls_element).first(),play_pause:$(".media-player-play-pause",$controls_element).first(),stop:$(".media-player-stop",$controls_element).first(),skip_forward:$(".media-player-skip-forward",$controls_element).first(),skip_back:$(".media-player-skip-back",$controls_element).first(),play_next:$(".media-player-play-next",$controls_element).first(),play_previous:$(".media-player-play-previous",$controls_element).first(),loop:$(".media-player-loop",$controls_element).first(),shuffle:$(".media-player-shuffle",$controls_element).first(),quality:$(".media-player-quality",$controls_element).first(),fullscreen:$(".media-player-fullscreen",$controls_element).first(),current_time:$(".media-player-current-time",$controls_element).first(),duration:$(".media-player-duration",$controls_element).first()};var sbar,sbutton;sbar=$(".media-player-position-bar",$controls_element).first();sbutton=$(".media-player-position-button",$controls_element).first();if(sbar&&sbutton&&sbar.length>0&&sbutton.length>0){controls.position_bar=new ngutils.ui.slider({bar:sbar,button:sbutton,fill:$(".media-player-position-fill",$controls_element).first(),});}
sbar=$(".media-player-volume-bar",$controls_element).first();sbutton=$(".media-player-volume-button",$controls_element).first();if(sbar&&sbutton&&sbar.length>0&&sbutton.length>0){controls.volume_bar=new ngutils.ui.slider({direction:'up',bar:sbar,button:sbutton,fill:$(".media-player-volume-fill",$controls_element).first(),add:$(".media-player-volume-up",$controls_element).first(),subtract:$(".media-player-volume-down",$controls_element).first(),toggle:$(".media-player-volume-toggle",$controls_element).first(),select:$(".media-player-volume-select",$controls_element).first(),lock_bar:true});}
var $player=this.$player_element;var self=this;this.setCurrentTitle=function(title){controls.title.html(title);};controls.loop.click(function(){self.loop(!self._loop);self.onPressLoop();return false;});controls.shuffle.click(function(){self.shuffle(!self._shuffle);self.onPressShuffle();return false;});controls.play.click(function(){self.play();self.onPressPlay();return false;});controls.pause.click(function(){self.pause();self.onPressPause();return false;});controls.play_pause.click(function(){if(self.paused||!self.playing){self.play();self.onPressPlay();}else{self.pause();self.onPressPause();}
return false;});controls.stop.click(function(){self.stop();self.onPressStop();return false;});controls.skip_forward.click(function(){self.skip_forward();self.onPressSkipForward();return false;});controls.skip_back.click(function(){self.skip_back();self.onPressSkipBack();return false;});controls.play_next.click(function(){self.play_next();self.onPressPlayNext();return false;});controls.play_previous.click(function(){self.play_previous();self.onPressPlayPrevious();return false;});controls.fullscreen.click(function(){self.toggleFullScreen();self.onPressFullscreen();return false;});function onTimeUpdate(){var p=$player[0].currentTime / $player[0].duration;if(controls.position_bar)controls.position_bar.setPosition(p);self.refreshTime();}
$player.on('timeupdate',function(e){onTimeUpdate();});function setPlayPosition(p){if(!isNaN($player[0].duration))$player[0].currentTime=$player[0].duration*p;}
if(controls.position_bar){controls.position_bar.onStopDrag=function(p){setPlayPosition(p);};}
if(controls.volume_bar){controls.volume_bar.onPositionChanged=function(pos){self.setVolume(pos);};}
this.controls=controls;if(controls.volume_bar){self.initVolume();}}};ngutils.local={getItem:function(item,default_val){value=localStorage.getItem(item);if(value){value=JSON.parse(value);}
else if(default_val){value=default_val;}
else{value=null;}
return value;},setItem:function(item,value){var result=localStorage.setItem(item,JSON.stringify(value));return result;}};ngutils.components={auto_id:0,nextAutoID:function(){this.auto_id++;return"ngutils-components-autoid-"+this.auto_id;},idFor:function($element){var id=$element.attr('id');if(!id){id=this.nextAutoID();$element.attr('id',id);}
return id;}};ngutils.components.audio={global_player:null,playback_items:{},playlists:{},current_playlist:null,registerPlaybackItem:function($playback_element){if(typeof($playback_element)=='string')$playback_element=$("#"+$playback_element);if($playback_element.attr('data-registered'))return this;var item=new ngutils.components.audio.playbackItem($playback_element);return this;},registerPlaylistWrapper:function($wrapper_element){if(typeof($wrapper_element)=='string')$wrapper_element=$("#"+$wrapper_element);if($wrapper_element.attr('data-registered'))return this;var list=new ngutils.components.audioList($wrapper_element);return this;},registerGlobalPlayer:function($audio_element,$control_element,$display_element){var self=this;var player=new ngutils.media.player($audio_element,$control_element,$display_element);player.autoplay=true;$('[data-audio-playback]').each(function(){self.registerPlaybackItem($(this));});if(!ngutils.components.audioList.global){$('[data-audio-playlist]').each(function(){self.registerPlaylistWrapper($(this));});}
function onMediaLoaded(media){player.setDisplay(media.html);}
function onStartMedia(media){if(media.playbackItem&&media.playbackItem.$element){media.playbackItem.$element.addClass('playing');media.playbackItem.$element.removeClass('paused');}}
function onEndMedia(media){if(media.playbackItem&&media.playbackItem.$element){media.playbackItem.$element.removeClass('playing');media.playbackItem.$element.removeClass('paused');}}
function onPauseMedia(media){if(media.playbackItem&&media.playbackItem.$element){media.playbackItem.$element.removeClass('playing');media.playbackItem.$element.addClass('paused');}}
function onUnpauseMedia(media){if(media.playbackItem&&media.playbackItem.$element){media.playbackItem.$element.addClass('playing');media.playbackItem.$element.removeClass('paused');}}
var $volumeControl=$('#global-audio-player-volume');var $volumeToggle=$('.media-player-volume-toggle a',$volumeControl).first();function onChangeVolume(volume){if($volumeControl&&$volumeControl.length>0){$volumeToggle.removeClass('fa-volume-up');$volumeToggle.removeClass('fa-volume-down');$volumeToggle.removeClass('fa-volume-off');if(volume>0.5){$volumeToggle.addClass('fa-volume-up');}else if(volume<=0){$volumeToggle.addClass('fa-volume-off');}else{$volumeToggle.addClass('fa-volume-down');}}}
player.onMediaLoaded=onMediaLoaded;player.onMediaStarted=onStartMedia;player.onMediaEnded=onEndMedia;player.onMediaPaused=onPauseMedia;player.onMediaUnpaused=onUnpauseMedia;player.onVolumeChange=onChangeVolume;onChangeVolume(ngutils.media.audio.volume);this.global_player=player;}};ngutils.components.audio.playbackItem=function($playback_element){if(typeof($playback_element)=='string')$playback_element=$("#"+$playback_element);this.$element=$playback_element;this.$element.attr('data-registered',1);var audio_id=this.$element.attr('data-audio-playback');audio_id=parseInt(audio_id);if(!audio_id||isNaN(audio_id)){console.error("Invalid data-audio-playback value",this.$element.attr('data-audio-playback'));return;}
this.id=ngutils.components.idFor(this.$element);this.media=new ngutils.media.audio(audio_id);this.media.playbackItem=this;this.valid=true;var self=this;this.$element.show();this.$element.off('click');this.$element.click(function(){self.play();return false;});ngutils.components.audio.playback_items[this.id]=this;if(ngutils.components.audioList.global!==null){ngutils.components.audioList.global.addPlaybackItem(this);}};ngutils.components.audio.playbackItem.prototype={valid:false,media:null,id:null,getPlaylist:function(){var id=this.$element.attr('data-audio-playlist-id');return id?ngutils.components.audio.playlists[id]:null;},play:function(){var self=this;if(ngutils.components.audio.global_player.current_media_item==this.media){if(ngutils.components.audio.global_player.playing){ngutils.components.audio.global_player.pause();}else{ngutils.components.audio.global_player.play();}
return;}
var playlist=this.getPlaylist();if(playlist){playlist.setCurrentItem(this.media);playlist.play();}else{if(ngutils.components.audio.global_player){ngutils.components.audio.global_player.stop();ngutils.components.audio.global_player.setPlaylist(null);ngutils.components.audio.global_player.setMedia(this.media);}}}};ngutils.components.audioList=function($wrapper_element){var self=this;this.list=ngutils.media.getPlaylist('audio');if($wrapper_element!='global'){if(typeof($wrapper_element)=='string')$wrapper_element=$("#"+$wrapper_element);this.$element=$wrapper_element;this.$element.attr('data-registered',1);this.id=ngutils.components.idFor(this.$element);$("[data-audio-playback]",this.$element).each(function(){var media_id=$(this).attr('id');var item=ngutils.components.audio.playback_items[media_id];self.addPlaybackItem(item);});}else{this.id='ngutils.components.audioList.global';this.$element=null;}
ngutils.components.audio.playlists[this.id]=this;};ngutils.components.audioList.global=null;ngutils.components.audioList.enableGlobalPlaylist=function(enable){return;};ngutils.components.audioList.clearGlobalPlaylist=function(){return;};ngutils.components.audioList.prototype={addPlaybackItem:function(item){if(item&&item.media){this.list.add(item.media);item.$element.attr('data-audio-playlist-id',this.id);}},setCurrentItem:function(media){if(!this.list){console.error("This playlist wrapper has not been registered.");}else{this.list.setCurrentItem(media);}
return this;},play:function(){if(ngutils.components.audio.global_player){ngutils.components.audio.global_player.stop();ngutils.components.audio.global_player.setPlaylist(this.list);}},clear:function(){this.list.clear();}};ngutils.components.video={ids:0,player:class __NgVideoPlayer__{constructor($container,config){let player=this;let fullscreen=false;ngutils.components.video.ids++;this.id=ngutils.components.video.ids;player.dragging=false;player.focused=false;player.justfocused=false;player.global=false;player.ended=false;player.cleantimout=0;player.fps=24;player.framerate=1/player.fps;player.pos={percent:0,current:'--:--',current_full:'--:--.-',total:'--:--'};player.url=null;player.title=null;player.author=null;player.fbf=false;player.timeline_hover=false;player.duration=0;if(typeof($container)==='string')$container=$($container);if(typeof(config)==='undefined')config={};player.$container=$container;player.paused=true;player.active=false;player.last_timeline=0;player.can_switch_screensize=true;let template=config.template?config.template:`
 <div class="ng-video-player">
  <video style="visibility:hidden" playsinline></video>
  <div class="ng-video-close-overlay">
   <a data-action="close"><em class="far fa-times-circle"></em></a>
  </div>
  <div class="ng-video-meta" style="display:none">

   <a class="ng-video-link">
    <h2 data-value="title">Movie Title</h2>
    <strong data-value="author">By author</strong>
   </a>

  </div>
  <div class="ng-video-postroll">
   <div class="inner">
    <div class="icons">
     <div class="grid">

     </div>
    </div>
   </div>
  </div>
  <div class="ng-video-ui">
   <div class="ng-video-ui-inner">
    <div class="ng-video-mobile-timeline"></div>
    <div class="flexbox align-center">
     <div class="ng-video-controls">
      <button data-action="previous" title="Previous Video"><em class="ngmedia-icon-skip-back"></em></button>
      <button data-action="backward" title="Previous Frame"><em class="ngmedia-icon-fbf-back"></em></button>
      <button data-action="play" title="Play"><em class="ngmedia-icon-play"></em></button>
      <button data-action="pause" title="Pause"><em class="ngmedia-icon-pause"></em></button>
      <button data-action="forward" title="Next Frame"><em class="ngmedia-icon-fbf-next"></em></button>
      <button data-action="next" title="Next Video"><em class="ngmedia-icon-skip-forward"></em></button>
      <button data-action="repeat" title="Repeat"><em class="ngmedia-icon-repeat"></em></button>
     </div>
     <div class="ng-video-timeline flex-1">
      <div class="ng-video-timeline-outer">
       <div class="ng-video-timeline-inner">
        <div class="ng-video-timeline-bar">
        </div>
        <div class="ng-video-pointer">
         <span data-value="current-time-pointer">00:00</span>
        </div>
        <div class="ng-video-cursor">
         <span data-value="current-time-cursor">00:00</span>
        </div>
       </div>
      </div>
     </div>
     <div class="ng-video-time">
      <span data-value="current-time">--:--</span> / <span data-value="total-time">--:--</span>
     </div>
     <div class="ng-video-volume">
      <div class="ng-video-volume-slider">
       <div>
        <div class="ng-video-volume-slider-bar"></div>
       </div>
      </div>
      <button data-action="volume" title="Volume"><em data-icon="volume" class="ngmedia-icon-vol-med"></em></button>
     </div>
     <div class="ng-video-display">
      <button data-action="display-options" title="Display Options">
       <em class="ngmedia-icon-options"></em>
       <span class="ng-video-hd-label"></span>
      </button>
      <div class="ng-option-select">
       <div class="ng-video-options" data-options="other">
        <button data-action="fixed-on" class="selected">Fix to Top</button>
        <button data-action="fixed-off">Fix to Top</button>
        <button data-action="titles-on" class="selected">Titles On</button>
        <button data-action="titles-off">Titles Off</button>
       </div>
       <div class="ng-video-options" data-options="res">
       </div>
      </div>
     </div>
     <div class="ng-video-size">
      <button data-action="size-options" title="Player Size">
       <em class="ngmedia-icon-player-large"></em>
      </button>
      <div class="ng-option-select">
       <div class="ng-video-options" data-options="other">
        <button data-action="screenmode-large" class="selected" title="Auto-Fit"><em class="ngmedia-icon-player-large"></em></button>
        <button data-action="screenmode-medium" class="selected" title="Large"><em class="ngmedia-icon-player-medium"></em></button>
        <button data-action="screenmode-small" class="selected" title="Small"><em class="ngmedia-icon-player-small"></em></button>
       </div>
       <div class="ng-video-options" data-options="size">
       </div>
      </div>
     </div>
     <div class="ng-video-options">
      <button data-action="enter-fullscreen" title="Fullscreen"><em class="ngmedia-icon-enter-fullscreen"></em></button>
      <button data-action="exit-fullscreen" title="Exit Fullscreen"><em class="ngmedia-icon-exit-fullscreen"></em></button>
     </div>
    </div>
   </div>
  </div>
 </div>
`;if(is_mobile)template=template.split("ngmedia-icon-").join("ngmedia-icon-med-");player.$wrapper=$(template);$container.append(player.$wrapper);player.$video=$("video",player.$wrapper).first();player.$video.removeAttr('controls');let video=player.$video[0];video.onended=function(){player.onEnded();};video.ontimeupdate=function(){player.updateTimeline();};player.ui={focus:null,$container:$('.ng-video-ui',player.$wrapper).first()};player.mouse={x:null,y:null,onmove:null,thisarg:player};player.$wrapper.on(ngutils.input.mouseMove,function(e){player.showControls();});function docMouseMove(e){if(typeof(player.mouse.onmove)==='function'){player.mouse.onmove.call(player.mouse.thisarg?player.mouse.thisarg:player,e);}}
$(document).on(ngutils.input.mouseMove,docMouseMove);player.show_titles=ngutils.local.getItem('_ngPreferredShowVideoTitles_',false);player.fix_to_top=ngutils.local.getItem('_ngPreferredFixedVideoPlayer_',1);player.loops=config.loops?config.loops:ngutils.local.getItem('_ngPreferredLooping_',false);player.screensize=config.screensize?config.screensize:ngutils.local.getItem('_ngPreferredVideosize_','large');if(player.screensize!=='small'&&player.screensize!=='medium')player.screensize='large';player.is_loop=config.is_loop?true:false;player.display_options_open=false;player.size_options_open=false;player.volume_open=false;var $video_controls=$('.ng-video-controls',player.ui.$container).first();var $video_volume=$('.ng-video-volume',player.ui.$container).first();var $video_timeline=$('.ng-video-timeline',player.ui.$container).first();var $video_time=$('.ng-video-time',player.ui.$container).first();var $video_options=$('.ng-video-options',player.ui.$container).first();var $video_display=$('.ng-video-display',player.ui.$container).first();var $video_size=player.$video_size_menu=$('.ng-video-size',player.ui.$container).first();player.$barrier=$(`<div class="ng-video-barrier"></div>`).hide();player.$barrier_wrapper=null;player.$meta=$('.ng-video-meta',player.$wrapper).first();player.$meta.hide();player.$postroll=$('.ng-video-postroll',player.$wrapper).first();player.$postroll_icons=$('.icons',player.$postroll).first();player.$postroll_grid=$('.grid',player.$postroll).first();for(var a=0;a<6;a++){let $a=$('<a class="item" href="/movies"><img src="'+PHP.get('img_root')+'/defaults/icon-portal-xl.gif"><p>MORE Movies!</p></a>');player.$postroll_grid.append($a);}
player.$postroll.hide();player.postroll_id=config.postroll_id?parseInt(config.postroll_id):false;player.postroll_timers=[];if(config.barrier){$container.append(player.$barrier);player.$barrier.html(config.barrier).show();player.$barrier_wrapper=$("div.icon-wrapper",player.$barrier).first();player.$barrier_img=$("img",player.$barrier).first();let $barrier_play=$('[data-action="play"]',player.$barrier);let startBarrier=function(e){e.preventDefault();e.stopPropagation();player.$barrier.remove();player.$barrier_wrapper=null;if($barrier_play.attr('data-movie-id')){let movie_id=parseInt($barrier_play.attr('data-movie-id'));player.loadMovieByID(movie_id);player.postroll_id=movie_id;}
player.setFocused();player.showControls(true);player.firstTimePlay=null;return false;};player.firstTimePlay=startBarrier;$barrier_play.click(startBarrier);}
player.ui.$close_container=$('.ng-video-close-overlay',player.$wrapper).first();player.ui.$close_container.hide();player.ui.$close=$('[data-action="close"]',player.ui.$close_container).first();player.ui.$play=$('[data-action="play"]',$video_controls).first();player.ui.$pause=$('[data-action="pause"]',$video_controls).first();player.ui.$backward=$('[data-action="backward"]',$video_controls).first();player.ui.$forward=$('[data-action="forward"]',$video_controls).first();player.ui.$previous=$('[data-action="previous"]',$video_controls).first();player.ui.$next=$('[data-action="next"]',$video_controls).first();player.ui.$repeat=$('[data-action="repeat"]',$video_controls).first();player.ui.$enter_fullscreen=$('[data-action="enter-fullscreen"]',player.ui.$container).first();player.ui.$exit_fullscreen=$('[data-action="exit-fullscreen"]',player.ui.$container).first();player.ui.$screenmode_btn=$('[data-action^="screenmode"]',player.ui.$container)
player.ui.$current_time=$('[data-value="current-time"]',player.ui.$container);player.ui.$current_time_pointer=$('[data-value="current-time-pointer"]',player.ui.$container);player.ui.$current_time_cursor=$('[data-value="current-time-cursor"]',player.ui.$container);player.ui.$total_time=$('[data-value="total-time"]',player.ui.$container);player.ui.$size_toggle=$('[data-action="size-options"]',$video_size).first();player.ui.$size_select=$('.ng-option-select',$video_size).first();player.ui.$display_toggle=$('[data-action="display-options"]',$video_display).first();player.ui.$display_select=$('.ng-option-select',$video_display).first();player.ui.$res_options=$('[data-options="res"]',player.ui.$display_select).first();player.ui.$other_options=$('[data-options="other"]',player.ui.$display_select).first();player.ui.$titles_on=$('[data-action="titles-on"]',player.ui.$other_options).first();player.ui.$titles_off=$('[data-action="titles-off"]',player.ui.$other_options).first();player.ui.$fixed_on=$('[data-action="fixed-on"]',player.ui.$other_options).first();player.ui.$fixed_off=$('[data-action="fixed-off"]',player.ui.$other_options).first();player.ui.$hd_label=$('.ng-video-hd-label',$video_display).first();function updateFixedOptions(){player.ui.$fixed_off.hide();player.ui.$fixed_on.hide();if(player.global){if(!player.fix_to_top)player.ui.$fixed_off.show();else player.ui.$fixed_on.show();ngutils.local.setItem('_ngPreferredFixedVideoPlayer_',player.fix_to_top);}}
player.setGlobal=function(global){player.global=global;updateFixedOptions();}
function updateShowTitleOptions(){player.ui.$titles_off.hide();player.ui.$titles_on.hide();if(!player.show_titles)player.ui.$titles_off.show();else player.ui.$titles_on.show();}
function updateShowTitles(){updateShowTitleOptions();ngutils.local.setItem('_ngPreferredShowVideoTitles_',player.show_titles);player.hideSizeOptions();player.hideDisplayOptions();player.showTitles();}
player.ui.$fixed_on.click(function(e){e.preventDefault();e.stopPropagation();player.fix_to_top=false;updateFixedOptions();if(player.global)player.global.updateFixed();});player.ui.$fixed_off.click(function(e){e.preventDefault();e.stopPropagation();player.fix_to_top=true;updateFixedOptions();if(player.global)player.global.updateFixed();});player.ui.$titles_on.click(function(e){e.preventDefault();e.stopPropagation();player.show_titles=false;updateShowTitles();});player.ui.$titles_off.click(function(e){e.preventDefault();e.stopPropagation();player.show_titles=true;updateShowTitles();});if(!config.barrier){updateShowTitles();}else{updateShowTitleOptions();}
player.ui.$mobile_timeline=$('.ng-video-mobile-timeline',player.ui.$container).first();player.ui.$timeline=$('.ng-video-timeline-outer',$video_timeline).first();player.ui.$timeline_inner=$('.ng-video-timeline-inner',$video_timeline).first();player.ui.$timeline_bar=$('.ng-video-timeline-bar',$video_timeline).first();player.ui.$timeline_pointer=$('.ng-video-pointer',player.ui.$container).first();player.ui.$timeline_cursor=$('.ng-video-cursor',player.ui.$container).first();player.ui.$timeline_pointer.hide();if(is_mobile)player.ui.$timeline_cursor.remove();player.ui.$timeline_cursor.hide();player.ui.$volume=$('.ng-video-volume-slider',$video_volume).first();player.ui.$volume_bar=$('.ng-video-volume-slider-bar',$video_volume).first();player.ui.$volume_btn=$('[data-action="volume"]',$video_volume).first();player.ui.$volume_icon=$('[data-icon="volume"]',$video_volume).first();player.ui.$close.on('click',function(e){e.preventDefault();e.stopPropagation();player.doOnClose();});if(is_mobile){player.ui.$timeline.remove();player.ui.$mobile_timeline.append(player.ui.$timeline);}
if(typeof(config.onScreensizeChanged)=='function'){player.onScreensizeChanged=config.onScreensizeChanged;player.ui.$screenmode_btn.on('click',function(e){let size=$(this).attr('data-action').split("-").pop();player.setScreenSize(size);});player.setScreenSize(player.screensize);}else{$video_size.hide();}
player.ui.$timeline.on("mouseenter touchstart",function(e){if(!player.source_loaded)return;player.timeline_hover=true;player.mouse.onmove=player.updateCursor;player.ui.$timeline_cursor.show();player.updateCursor(e);player.updateTimeline();player.hideSizeOptions();player.hideDisplayOptions();player.hideVolume();});player.ui.$timeline.mouseleave(function(e){if(!player.source_loaded)return;player.timeline_hover=false;if(player.mouse.onmove===player.updateCursor)player.mouse.onmove=null;player.ui.$timeline_cursor.hide();player.updateCursor(e);player.updateTimeline();});player.ui.$timeline.mousemove(function(e){if(!player.source_loaded)return;if(!player.timeline_hover&&player.mouse.onmove!==player.updateCursor){player.timeline_hover=true;player.ui.$timeline_cursor.show();player.mouse.onmove=player.updateCursor;}
if(player.timeline_hover)player.updateCursor(e);});player.ui.$timeline.on(ngutils.input.mouseDown,function(e){if(!player.source_loaded)return;e.preventDefault();player.clickTimeline(e);});player.ui.$volume.on(ngutils.input.mouseDown,function(e){e.preventDefault();player.clickVolume(e);});function mouseUp(e){player.releaseTimeline();player.releaseVolume();setTimeout(function(){player.dragging=false;},100);}
$('body').on(ngutils.input.mouseUp,mouseUp);if(player.loops)player.ui.$repeat.addClass('on');player.ui.$repeat.click(function(){player.loops=!player.loops;ngutils.local.setItem('_ngPreferredLooping_',player.loops);if(player.loops)player.ui.$repeat.addClass('on');else player.ui.$repeat.removeClass('on');return false;});player.ui.$pause.hide();player.ui.$exit_fullscreen.hide();player.ui.$timeline_bar.width(0);player.ui.$volume.hide();player.setPlaylistID(config.playlist_id);player._on_close_callback=null;player._on_close_thisarg=this;player.onClose((config.on_close?config.on_close:null),(config.on_close_target?config.on_close_target:this));player.ui.$container.click(function(e){e.stopPropagation();e.preventDefault();return false;});player.$wrapper.on('mousedown',function(e){player.setFocused();});if(config.hide_ui){config.hide_ui.forEach(function(item){if(player.ui['$'+item])player.ui['$'+item].hide();});}
function deFocus(){if(player.justfocused)return;player.focused=false;}
let keyBindings={nextFrame:['.','>'],prevFrame:[',','<'],playNext:['ArrowRight'],playPrevious:['ArrowLeft'],addVolume:['ArrowUp'],lowerVolume:['ArrowDown'],toggleMute:['m','M'],toggleFullScreen:['f','F'],togglePause:[' '],jumpToTimePercentFromKey:['1','2','3','4','5','6','7','8','9','0']};function checkKeypress(e){if(!player.focused)return;for(var func in keyBindings){if(keyBindings[func].indexOf(e.key)>-1){e.stopPropagation();e.preventDefault();player[func]('key',e.key);console.log('keyaction:',func,player.id);}}}
$(document).on('mousedown',deFocus);$(document).on('keydown',checkKeypress);player.$wrapper.click(()=>{if(player.dragging)return;if(player.volume_open||player.display_options_open||player.size_options_open){player.hideVolume();player.hideSizeOptions();player.hideDisplayOptions();return;}
player.showControls();if(!is_mobile||!player.active){player.paused?player.play():player.pause();}
return false;});player.ui.$enter_fullscreen.click(()=>{player.requestFullScreen();return false;});player.ui.$exit_fullscreen.click(()=>{player.exitFullScreen();return false;});player.ui.$play.click((e)=>{if(player.firstTimePlay){let r=player.firstTimePlay(e);player.firstTimePlay=null;if(r===false)return;}
player.showControls();player.paused?player.play():player.pause();return false;});player.ui.$pause.click(()=>{player.showControls();player.pause();return false;});player.ui.$backward.click((e)=>{player.prevFrame('mouse');return false;});player.ui.$forward.click((e)=>{player.nextFrame('mouse');return false;});player.volume=1;player.ui.$volume_btn.click((e)=>{player.hideSizeOptions();player.hideDisplayOptions();if(is_mobile){if(player.volume)player.setVolume(0);else player.setVolume(1);player.showControls();return;}
if(player.volume_open){player.hideVolume();}else{player.showVolume();}
return false;});player.ui.$size_toggle.click(function(e){e.preventDefault();e.stopPropagation();if(!player.size_options_open){player.showSizeOptions();}else{player.hideSizeOptions();}
player.hideVolume();player.hideDisplayOptions();return false;});player.ui.$display_toggle.click(function(e){e.preventDefault();e.stopPropagation();if(!player.display_options_open){player.showDisplayOptions();}else{player.hideDisplayOptions();}
player.hideVolume();player.hideSizeOptions();return false;});if(!config.width&&!config.height){config.width='auto';config.height=0;}
if(is_mobile){for(var elem in player.ui){if(elem.indexOf('$')===0&&player.ui[elem].is('button')){player.ui[elem].on('touchend',function(e){e.preventDefault();$(this).click();});}}}else{player.$wrapper.mouseleave(function(){if(player.active)player.hideControls();});}
player.width=config.width?config.width:0;player.height=config.height?config.height:0;if(player.width==='auto'){player.fillWidth();setTimeout(function(){player.fillWidth();},100);}else if(player.height==='auto'){player.fillHeight();setTimeout(function(){player.fillHeight();},100);}else{player.$wrapper.width(player.width).height(player.height);}
if(config.sources){player.sources=config.sources;player.source_loaded=true;}else{player.source_loaded=false;player.sources={'360p':[{type:"video/mp4",src:"data:video/mp4;base64, AAAAHGZ0eXBNNFYgAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXTeBAAAbGliZmFhYyAxLjI4AABCAJMgBDIARwAAArEGBf//rdxF6b3m2Ui3lizYINkj7u94MjY0IC0gY29yZSAxNDIgcjIgOTU2YzhkOCAtIEguMjY0L01QRUctNCBBVkMgY29kZWMgLSBDb3B5bGVmdCAyMDAzLTIwMTQgLSBodHRwOi8vd3d3LnZpZGVvbGFuLm9yZy94MjY0Lmh0bWwgLSBvcHRpb25zOiBjYWJhYz0wIHJlZj0zIGRlYmxvY2s9MTowOjAgYW5hbHlzZT0weDE6MHgxMTEgbWU9aGV4IHN1Ym1lPTcgcHN5PTEgcHN5X3JkPTEuMDA6MC4wMCBtaXhlZF9yZWY9MSBtZV9yYW5nZT0xNiBjaHJvbWFfbWU9MSB0cmVsbGlzPTEgOHg4ZGN0PTAgY3FtPTAgZGVhZHpvbmU9MjEsMTEgZmFzdF9wc2tpcD0xIGNocm9tYV9xcF9vZmZzZXQ9LTIgdGhyZWFkcz02IGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MCB3ZWlnaHRwPTAga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCB2YnZfbWF4cmF0ZT03NjggdmJ2X2J1ZnNpemU9MzAwMCBjcmZfbWF4PTAuMCBuYWxfaHJkPW5vbmUgZmlsbGVyPTAgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXiEASZACGQAjgCEASZACGQAjgAAAAAdBmjgX4GSAIQBJkAIZACOAAAAAB0GaVAX4GSAhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGagC/AySEASZACGQAjgAAAAAZBmqAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZrAL8DJIQBJkAIZACOAAAAABkGa4C/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmwAvwMkhAEmQAhkAI4AAAAAGQZsgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGbQC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm2AvwMkhAEmQAhkAI4AAAAAGQZuAL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGboC/AySEASZACGQAjgAAAAAZBm8AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZvgL8DJIQBJkAIZACOAAAAABkGaAC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmiAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpAL8DJIQBJkAIZACOAAAAABkGaYC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmoAvwMkhAEmQAhkAI4AAAAAGQZqgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGawC/AySEASZACGQAjgAAAAAZBmuAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZsAL8DJIQBJkAIZACOAAAAABkGbIC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm0AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZtgL8DJIQBJkAIZACOAAAAABkGbgCvAySEASZACGQAjgCEASZACGQAjgAAAAAZBm6AnwMkhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AAAAhubW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAABDcAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAzB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+kAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAPpAAAAAAABAAAAAAKobWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAB1MAAAdU5VxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAACU21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAhNzdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAkABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhzdHRzAAAAAAAAAAEAAAAeAAAD6QAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAABAAAAAQAAAIxzdHN6AAAAAAAAAAAAAAAeAAADDwAAAAsAAAALAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAAiHN0Y28AAAAAAAAAHgAAAEYAAANnAAADewAAA5gAAAO0AAADxwAAA+MAAAP2AAAEEgAABCUAAARBAAAEXQAABHAAAASMAAAEnwAABLsAAATOAAAE6gAABQYAAAUZAAAFNQAABUgAAAVkAAAFdwAABZMAAAWmAAAFwgAABd4AAAXxAAAGDQAABGh0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAACAAAAAAAABDcAAAAAAAAAAAAAAAEBAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAQkAAADcAABAAAAAAPgbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAC7gAAAykBVxAAAAAAALWhkbHIAAAAAAAAAAHNvdW4AAAAAAAAAAAAAAABTb3VuZEhhbmRsZXIAAAADi21pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADT3N0YmwAAABnc3RzZAAAAAAAAAABAAAAV21wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAAC7gAAAAAAAM2VzZHMAAAAAA4CAgCIAAgAEgICAFEAVBbjYAAu4AAAADcoFgICAAhGQBoCAgAECAAAAIHN0dHMAAAAAAAAAAgAAADIAAAQAAAAAAQAAAkAAAAFUc3RzYwAAAAAAAAAbAAAAAQAAAAEAAAABAAAAAgAAAAIAAAABAAAAAwAAAAEAAAABAAAABAAAAAIAAAABAAAABgAAAAEAAAABAAAABwAAAAIAAAABAAAACAAAAAEAAAABAAAACQAAAAIAAAABAAAACgAAAAEAAAABAAAACwAAAAIAAAABAAAADQAAAAEAAAABAAAADgAAAAIAAAABAAAADwAAAAEAAAABAAAAEAAAAAIAAAABAAAAEQAAAAEAAAABAAAAEgAAAAIAAAABAAAAFAAAAAEAAAABAAAAFQAAAAIAAAABAAAAFgAAAAEAAAABAAAAFwAAAAIAAAABAAAAGAAAAAEAAAABAAAAGQAAAAIAAAABAAAAGgAAAAEAAAABAAAAGwAAAAIAAAABAAAAHQAAAAEAAAABAAAAHgAAAAIAAAABAAAAHwAAAAQAAAABAAAA4HN0c3oAAAAAAAAAAAAAADMAAAAaAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAACMc3RjbwAAAAAAAAAfAAAALAAAA1UAAANyAAADhgAAA6IAAAO+AAAD0QAAA+0AAAQAAAAEHAAABC8AAARLAAAEZwAABHoAAASWAAAEqQAABMUAAATYAAAE9AAABRAAAAUjAAAFPwAABVIAAAVuAAAFgQAABZ0AAAWwAAAFzAAABegAAAX7AAAGFwAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTUuMzMuMTAw"}]};}
player.setSources();if(!config.sources)player.$wrapper.removeClass('ready');player.initialized=false;player.updateTimeline();if(iOS){player.$video[0].addEventListener("webkitendfullscreen",function(e){e.preventDefault();e.stopPropagation();player.onExitFullscreen();});}
player.$video[0].onpause=function(){player.onVideoPaused();}
function onResize(){let fs=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;if(fs)player.onEnterFullScreen();else player.onExitFullscreen();if(is_mobile){if(player.width==='auto'){player.fillWidth();}else if(player.height==='auto'){player.fillHeight();}}
player.updateItemGrid();}
ngutils.event.addListener(ngutils.event.resize,onResize);player.destroy=function(){ngutils.event.removeListener(ngutils.event.resize,onResize);$(document).off(ngutils.input.mouseMove,docMouseMove);$(document).off(ngutils.input.mouseUp,mouseUp);$(document).off('mousedown',deFocus);var i;for(i in player.ui){if(i.charAt(0)=='$')player.ui[i].off();}
for(i in player){if(i.charAt(0)=='$'&&player[i]){if(player[i].off)player[i].off();else console.warn("Couldn't find off method on "+i);}}
$(document).off('mousedown',deFocus);$(document).off('keydown',checkKeypress);if(player.playlist_id){ngutils.components.video.stopPlaybackItem(player.playlist_id);delete ngutils.components.video.playlists[player.playlist_id].player;player.$wrapper.remove();}}}
hidePostRoll(){let player=this;player.$postroll.hide();player.postroll_timers.forEach((t)=>{if(t)clearTimeout(t);});}
showPostRoll(){let player=this;if(!player.postroll_id)return;player.hidePostRoll();player.postroll_timers=[];var $items=$(".item",player.$postroll_grid);$items.css('transition','');$items.css('transform','scale(0)');$items.css('transition','transform 0.33s');$items.off('click');$items.on('click',function(e){e.stopPropagation();});$.get(PHP.get('www_root')+'/portal/exitroll/'+player.postroll_id,function(results){player.postroll_timers.push(setTimeout(()=>{player.$meta.hide();player.$postroll.fadeIn(500);},2000));var base=2500;var space=150;var index=0;var i;for(i=results.item.length-1;i>0;i--){var j=Math.floor(Math.random()*i)
var temp=results.item[i]
results.item[i]=results.item[j]
results.item[j]=temp}
var showNext=function(){var $item=$($items[index]);index++;$item.css('transform','scale(1)');};for(i=0;i<$items.length;i++){let $item=$($items[i]);if(i<results.item.length){$item.attr('href',results.item[i].url)
$item.attr('data-postroll-id',results.item[i].id);$('img',$item).attr('src',results.item[i].icon);$('p',$item).html('<strong></strong><br/>by '+results.item[i].author);$('strong',$item).text(results.item[i].title);}else{$item.attr('data-postroll-id','');}
player.postroll_timers.push(setTimeout(showNext,base));base+=space;}},'json');}
updateItemGrid(){let player=this;let fs=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;player.$postroll_grid.attr('class','grid');let ih=player.$container.innerHeight();let iw=player.$wrapper.innerWidth();let cols=3;let rows=2;if(is_mobile){cols=2;rows=1;}
let icw=488*cols;let ich=278*rows;let ww=icw*(ih/ich);if(ww>1280)ww=1280;if(ww>iw)ww=iw;player.$postroll_icons.width(ww);player.$postroll_grid.addClass('show-'+(rows*cols));}
canSwitchScreensize(can){let player=this;if(can===player.can_switch_screensize)return;if(can){player.$video_size_menu.show();player.setScreenSize(player.screensize);}else{player.$video_size_menu.hide();}}
setScreenSize(size){let player=this;if(size!=='small'&&size!=='large')size='medium';ngutils.local.setItem('_ngPreferredVideosize_',size);player.screensize=size;let prefix=is_mobile?'ngmedia-icon-med-player-':'ngmedia-icon-player-'
$('em',player.ui.$size_toggle).first().attr('class',prefix+size);player.onScreensizeChanged(size);}
loadMovieByID(movie_id,callback){let player=this;player.init(function(){player.pause();$.get(PHP.get('www_root')+"/portal/video/"+movie_id,function(r){if(r.error){console.error(r.error);alert(r.error.msg);}else if(r.sources){if(typeof(callback)==='function')callback(r);player.setMeta(r);player.$video[0].load();player.$video[0].currentTime=0;player.play();}
if(r.warning)console.warn("NG Video Warning:",r.warning);},'json');});}
togglePause(input){let player=this;player.paused?player.play():player.pause();player.hidePostRoll();}
prevFrame(input){let player=this;let video=player.$video[0];if(input==='mouse')player.showControls();if(isNaN(video.duration)||isNaN(video.currentTime))return;let goto=video.currentTime-player.framerate;if(goto<0)goto=video.currentTime<=0?video.duration:0;player.pause();if(input==='mouse')player.showControls(true);video.currentTime=goto;player.fbf=true;player.updateTimeline();player.hidePostRoll();}
nextFrame(input){let player=this;let video=player.$video[0];if(input==='mouse')player.showControls();if(isNaN(video.duration)||isNaN(video.currentTime))return;let goto=video.currentTime+player.framerate;if(goto>video.duration)goto=video.currentTime>=video.duration?0:video.duration;player.pause();if(input==='mouse')player.showControls(true);video.currentTime=goto;player.fbf=true;player.updateTimeline();player.hidePostRoll();}
playPrevious(input){let player=this;if(player.playlist_id){let playing=ngutils.components.video.playPrevious(player.playlist_id);}
player.hidePostRoll();}
playNext(input){let player=this;if(player.playlist_id){let playing=ngutils.components.video.playNext(player.playlist_id);}
player.hidePostRoll();}
onClose(callback,thisarg){let player=this;player._on_close_callback=callback?callback:null;player._on_close_thisarg=thisarg?thisarg:this;if(typeof(player._on_close_callback)==='function'){player.ui.$close_container.show();}else{player.ui.$close_container.hide();}}
doOnClose(){let player=this;if(!player._on_close_callback)return false;if(player._on_close_thisarg){player._on_close_callback.call(player._on_close_thisarg,this);}else{player._on_close_callback(this);}
return true;}
hideControls(){let player=this;player.hideSizeOptions();player.hideDisplayOptions();player.hideVolume();player.ui.$timeline_pointer.hide();player.ui.$timeline_cursor.hide();player.fbf=false;player.$wrapper.addClass('clean');if(player.cleantimout)clearTimeout(player.cleantimout);player.onHideControls();}
setPlaylistID(id){let player=this;player.playlist_id=id||id===0?id:false;if(player.playlist_id){player.ui.$previous.show().off('click');player.ui.$next.show().off('click');player.ui.$previous.on('click',function(){player.playPrevious('mouse');return false;});player.ui.$next.on('click',function(){player.playNext('mouse');return false;});}else{player.ui.$previous.hide();player.ui.$next.hide();}}
updateBarrierWidth(){let player=this;if(player.$barrier_wrapper&&player.$barrier_img.length>0){let img=player.$barrier_img[0];if(!img.naturalWidth)return;let ih=player.$container.innerHeight();if(ih>=img.naturalHeight){player.$barrier_wrapper.css('max-width','100%');}else{let scale=ih/img.naturalHeight;player.$barrier_wrapper.css('max-width',Math.floor(img.naturalWidth*scale)+"px");}}}
fillWidth(){let player=this;let width=player.$container.innerWidth();let height=player.height==='fill'?'100%':Math.round((width/16)*9);player.$wrapper.width(width).height();player.updateBarrierWidth();player.updateItemGrid();player.onResize();}
fillHeight(){let player=this;let height=player.$container.innerHeight();let width=player.width==='fill'?'100%':Math.round((height/9)*16);player.$wrapper.width(width).height(height);player.updateBarrierWidth();player.updateItemGrid();player.onResize();}
onResize(){}
setMeta(meta){let player=this;if(meta.sources)player.setSources(meta.sources);player.source_loaded=true;player.setUrl(meta.url);player.setTitle(meta.title);player.setAuthor(meta.author);player.showTitles();}
setUrl(url){let player=this;if(url)$('.ng-video-link',player.$meta).attr('href',url);else $('.ng-video-link',player.$meta).removeAttr('href');player.url=url;}
setTitle(title){let player=this;if(title)$('[data-value="title"]',player.$meta).text(title).show();else $('[data-value="title"]',player.$meta).text('').hide();player.title=title;}
setAuthor(author){let player=this;if(author)$('[data-value="author"]',player.$meta).text("By "+author).show();else $('[data-value="author"]',player.$meta).text('').hide();player.author=author;}
showTitles(){let player=this;if(player.show_titles){player.$meta.show();$('a',player.$meta).fadeIn(1000,function(){setTimeout(function(){$('a',player.$meta).fadeOut(1000,function(){player.$meta.hide();});},5000);});}else{player.$meta.hide();}}
setSources(sources){let player=this;player.fbf=false;if(sources)player.sources=sources;$('button',player.ui.$res_options).off('click');player.ui.$res_options.html('');let $option;var default_res=ngutils.local.getItem('_ngPreferredVideoResv2_');if(typeof(default_res)==="undefined"||!default_res||default_res==="undefined"){default_res=is_mobile?'360p':'720p';}
if(([360,720,1080]).indexOf(default_res)>=0){default_res=default_res+"p";}
var vol=parseFloat(ngutils.local.getItem('_ngPlayerVolume_'));var muted=parseInt(ngutils.local.getItem('_ngPlayerMuted_'));if(null===vol||isNaN(vol)){vol=1;}
player.setVolume(vol,muted);player.resolution=null;player.resolutions=[];for(var res in player.sources){if(player.resolution===null||res===default_res){player.resolution=res;}
player.resolutions.push(res);}
player.hideDisplayOptions();player.hideSizeOptions();if(player.resolutions.length>1){player.ui.$res_options.show();player.resolutions.forEach((res)=>{$option=$("<button>");$option.attr('data-value',res);$option.html(res);if(res==player.resolution)$option.addClass('selected');player.ui.$res_options.append($option);$option.on('click',function(e){$('button',player.ui.$res_options).removeClass('selected');e.preventDefault();let res=$(this).attr('data-value');let at=player.$video[0].currentTime;let paused=player.$video[0].paused;player.resolution=res;player.updateResolution();player.$video[0].load();player.$video[0].currentTime=at;if(!paused)player.play();ngutils.local.setItem('_ngPreferredVideoResv2_',res);player.hideDisplayOptions();player.hideSizeOptions();$(this).addClass('selected');});});}else{player.ui.$res_options.hide();}
player.updateResolution();player.$wrapper.addClass('ready');}
hideSizeOptions(){let player=this;player.ui.$size_select.hide();player.size_options_open=false;}
showSizeOptions(){let player=this;player.ui.$size_select.show();player.size_options_open=true;}
hideDisplayOptions(){let player=this;player.ui.$display_select.hide();player.display_options_open=false;}
showDisplayOptions(){let player=this;player.ui.$display_select.show();player.display_options_open=true;}
updateResolution(){let player=this;let $source;player.$video.html('');let res_labels={'8k':'8K','4k':'4K','1080p':'HD','720p':'HD','360p':''};player.ui.$hd_label.text(typeof(res_labels[player.resolution])=='undefined'?'':res_labels[player.resolution]);player.sources[player.resolution].forEach((source)=>{$source=$("<source>");if(typeof(source)==='string'){$source.attr('src',source);}else{if(typeof(source.src)!=='string')throw('Video source must be a string, or an object with a valid src property');if(typeof(source.type)=='string')$source.attr('type',source.type);$source.attr('src',source.src);}
player.$video.append($source);});}
getXY(e,element){if(is_mobile)e=e.touches[0];var rect=element.getBoundingClientRect();var scrollTop=document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft;var elementLeft=rect.left+scrollLeft;var elementTop=rect.top+scrollTop;return{x:e.pageX-elementLeft,y:e.pageY-elementTop};}
getTimelineX(time){let player=this;if(!time)time=player.$video[0].currentTime;let pc=time / player.$video[0].duration;return player.ui.$timeline_inner.width()*pc;}
getTimelineXFromEvent(e){let player=this;let x=player.getXY(e,player.ui.$timeline_inner[0]).x;if(x<0)x=0;else if(x>player.ui.$timeline_inner.width())x=player.ui.$timeline_inner.width();return x;}
getTimelinePercentFromEvent(e,format){let player=this;let x=player.getTimelineXFromEvent(e);let pc=x / player.ui.$timeline_inner.width();if(format)pc=(Math.round(pc*1000)/10)+"%";return pc;}
getTimeAt(x){let player=this;let ww=player.ui.$timeline_inner.width();if(x<0)x=0;else if(x>ww)x=ww;return player.$video[0].duration*(x/ww);}
toggleMute(input){let player=this;player.setMuted(player.muted?0:1);}
setMuted(muted){let player=this;player.setVolume(player.volume,muted);}
addVolume(){let player=this;player.volume+=0.1;if(player.volume>1)player.volume=1;player.setVolume(player.volume,0);}
lowerVolume(){let player=this;player.volume-=0.1;if(player.volume<0)player.volume=0;player.setVolume(player.volume,0);}
setVolume(vol,muted){let player=this;player.volume=vol;player.muted=muted?1:0;if(player.muted)vol=0;if(vol>0)player.$video.prop('muted',false);else player.$video.prop('muted',true);player.ui.$volume_bar.height(((vol*10000)/100)+"%");player.$video[0].volume=vol;let fa_class=is_mobile?'ngmedia-icon-med-':'ngmedia-icon-';if(vol===0)fa_class+="vol-off";else if(vol>=0.75)fa_class+="vol-high";else if(vol>=0.20)fa_class+="vol-med";else fa_class+="vol-low";player.ui.$volume_icon.attr('class',fa_class);ngutils.local.setItem('_ngPlayerVolume_',player.volume);ngutils.local.setItem('_ngPlayerMuted_',parseInt(muted));}
jumpToTimePercent(percent){let player=this;player.$video[0].currentTime=player.$video[0].duration*percent;}
jumpToTimePercentFromKey(input,key){let player=this;let time=parseInt(key+"");if(isNaN(time)||time<0||time>9)return;player.jumpToTimePercent(time / 10);}
clickTimeline(e){let player=this;player.fbf=false;player.ui.focus='timeline';player.showControls();player.mouse.onmove=player.updateTimelineBar;player.updateTimelineBar(e);player.dragging=true;}
updateCursor(e){let player=this;let video=player.$video[0];let s,m,ms;if(player.timeline_hover){let pc=player.getTimelinePercentFromEvent(e);let pos=video.duration*pc;if(isNaN(pos))return;player.ui.$timeline_cursor.css('left',(Math.round(pc*1000)/ 10)+"%");s=Math.floor(pos);ms=Math.floor((pos-s)*100).toString();m=Math.floor(s/60).toString();s=(s%60).toString();console.log(m,s,ms,pos);if(m.length<2)m="0"+m;if(s.length<2)s="0"+s;if(ms.length<2)ms="0"+ms;player.ui.$current_time_cursor.text(m+":"+s+"."+ms);}}
updateTimelineBar(e){let player=this;let time=player.getTimeAt(player.getTimelineXFromEvent(e));player.$video[0].currentTime=time;}
releaseTimeline(){let player=this;if(player.ui.focus!=='timeline')return;player.ui.focus=null;player.showControls();if(player.mouse.onmove===player.updateTimelineBar){player.mouse.onmove=null;player.timeline_hover=false;player.ui.$timeline_cursor.hide();if(player.ended)player.play();}}
clickVolume(e){let player=this;player.fbf=false;player.ui.focus='volume';player.showControls();player.mouse.onmove=player.updateVolumeBar;player.updateVolumeBar(e);player.dragging=true;}
updateVolumeBar(e){let player=this;let bp=player.ui.$volume_bar.parent();let ih=bp.innerHeight();let mouse=player.getXY(e,bp[0]);let pc=(-(mouse.y-ih))/ ih;if(pc<0)pc=0;else if(pc>1)pc=1;player.setVolume(pc,0);}
releaseVolume(){let player=this;if(player.ui.focus!=='volume')return;player.ui.focus=null;player.showControls();if(player.mouse.onmove===player.updateVolumeBar)player.mouse.onmove=null;}
hideVolume(){let player=this;player.showControls();player.ui.$volume.hide();player.volume_open=false;}
showVolume(){let player=this;player.showControls();player.ui.$volume.show();clearTimeout(player.cleantimout);player.volume_open=true;}
requestFullScreen(){let player=this;player.fbf=false;if(iOS){player.$video[0].webkitEnterFullscreen();return;}
let elem=player.$wrapper[0];let req=elem.webkitRequestFullscreen||elem.requestFullScreen||elem.mozRequestFullScreen;if(req){req.call(elem);player.onEnterFullScreen();}}
toggleFullScreen(input){let player=this;if(player.is_fullscreen)player.exitFullScreen();else player.requestFullScreen();}
onEnterFullScreen(){let player=this;player.is_fullscreen=true;player.ui.$exit_fullscreen.show();player.ui.$enter_fullscreen.hide();player.$wrapper.addClass('fullscreen');if(is_mobile&&!iOS)player.$wrapper.addClass('fullscreen-ios');}
exitFullScreen(){let player=this;if(iOS){player.$video[0].webkitExitFullScreen();player.onExitFullscreen();return;}
let fs=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;if(fs){let elem=document;let req=elem.webkitExitFullscreen||elem.exitFullScreen||elem.mozCancelFullScreen;if(req)req.call(elem);player.onExitFullscreen();}}
onExitFullscreen(){let player=this;player.is_fullscreen=false;player.ui.$exit_fullscreen.hide();player.ui.$enter_fullscreen.show();player.$wrapper.removeClass('fullscreen');if(is_mobile&&!iOS)player.$wrapper.removeClass('fullscreen-ios');}
updateTimeline(){let player=this;if(!player.source_loaded)return;let video=this.$video[0];let s,m,ms;if(isNaN(video.duration)||isNaN(video.currentTime)||!video.duration)return;let t_percent=video.currentTime/video.duration;let percent=(Math.round(t_percent*1000)/10)+"%";if(player.duration!==video.duration){player.duration=video.duration;s=Math.round(video.duration);m=Math.floor(s/60);s=s%60;if(s<10)s="0"+s;if(m<10)m="0"+m;player.pos.total=m+":"+s;player.pos.total_frames=Math.ceil(video.duration*player.fps);player.ui.$total_time.text(player.pos.total);}
s=Math.floor(video.currentTime);ms=Math.floor((video.currentTime-s)*100).toString();m=Math.floor(s/60).toString();s=(s%60).toString();if(m.length<2)m="0"+m;if(s.length<2)s="0"+s;if(ms.length<2)ms="0"+ms;player.ui.$current_time.text(m+":"+s);player.ui.$timeline_bar.width(percent);if(player.fbf||player.timeline_hover){player.ui.$timeline_pointer.show();let current_time;if(player.fbf){current_time="Frame "+(Math.round(player.pos.total_frames*t_percent)+1)+" / "+(player.pos.total_frames+1);}else{current_time=m+":"+s+"."+ms;}
player.ui.$current_time_pointer.text(current_time);player.ui.$timeline_pointer.css('left',percent);}else{player.ui.$timeline_pointer.hide();}}
showControls(make_active){let player=this;player.$wrapper.removeClass('clean');if(player.cleantimout)clearTimeout(player.cleantimout);if(make_active)player.active=true;if(player.active){player.cleantimout=setTimeout(function(){clearTimeout(player.cleantimout);player.hideControls();},2000);}
player.onShowControls();}
onShowControls(){}
onHideControls(){}
init(callback,thisarg){let player=this;player.hidePostRoll();if(!thisarg)thisarg=player;if(player.initialized){callback.call(thisarg);return;}
player.$video[0].play().then(()=>{player.$video[0].pause();player.preInit(function(){player.initialized=true;if(typeof(callback)==='function'){callback.call(thisarg);}},this);},()=>{console.error("NG Video can't be started outside of a user input event!");});}
preInit(callback,thisArg){if(!thisArg)thisArg=this;callback.call(thisArg);}
play(){let player=this;player.ended=false;player.fbf=false;player.$video.css('visibility','');this.init(function(){player.active=true;player.paused=false;player.$video[0].play();player.ui.$play.hide();player.ui.$pause.show();});}
setFocused(){let player=this;player.focused=true;player.justfocused=true;setTimeout(function(){player.justfocused=false;player.$wrapper.focus();},10);}
reset(){let player=this;player.$video[0].pause();player.$video[0].currentTime=0;player.setFocused();}
pause(){let player=this;player.$video[0].pause();}
onVideoPaused(){let player=this;player.fbf=false;player.paused=true;player.ui.$play.show();player.ui.$pause.hide();}
onEnded(){let player=this;player.fbf=false;player.ended=true;if(player.playlist_id){let playing=ngutils.components.video.playNext(player.playlist_id);if(!playing)player.pause();}else if(player.is_loop){player.paused=false;player.$video[0].currentTime=0;player.play();}else{player.paused=true;player.active=false;player.showControls();player.ui.$play.show();player.ui.$pause.hide();player.showPostRoll();}}},last_playlist_id:'default',playlists:{},initPlaylist:function(playlist_id,reset){if(typeof(ngutils.components.video.playlists[playlist_id])==='undefined'||reset===true){ngutils.components.video.playlists[playlist_id]={player:null,items:[],active:null};ngutils.components.video.last_playlist_id=playlist_id;};},registerPlayer:function(player,playlist_id){if(!playlist_id)playlist_id=player.playlist_id?player.playlist_id:ngutils.components.video.last_playlist_id;ngutils.components.video.initPlaylist(playlist_id);ngutils.components.video.playlists[playlist_id].player=player;},registerPlaybackItem:function($playback_element,playlist_id){if(typeof($playback_element)=='string')$playback_element=$("#"+$playback_element);if($playback_element.attr('data-registered'))return this;if($playback_element.length<1)return this;if(!playlist_id)playlist_id=ngutils.components.video.last_playlist_id;ngutils.components.video.initPlaylist(playlist_id);ngutils.components.video.playlists[playlist_id].items.push(new ngutils.components.video.playbackItem($playback_element,playlist_id,ngutils.components.video.playlists[playlist_id].items.length));},playbackItem:function($playback_element,playlist_id,index){if($playback_element.attr('data-registered'))return;this.playlist_id=playlist_id;this.index=index;this.$element=$playback_element;var _this=this;var $play_btn=$('[data-action="play"]',$playback_element);if($play_btn.length<1)$play_btn=$playback_element;$playback_element.attr('data-registered',1);this.item_id=$playback_element.attr('data-video-playback');this.id=$playback_element.attr('id');$play_btn.click(function(e){if(typeof(ngutils.components.video.playlists[_this.playlist_id])!=='undefined'&&typeof(ngutils.components.video.playlists[_this.playlist_id].player)!=='undefined'){e.stopPropagation();e.preventDefault();ngutils.components.video.startPlaybackItem(_this).setFocused();}});},playPrevious:function(playlist_id){let playlist=ngutils.components.video.playlists[playlist_id];let index=playlist.active?playlist.active.index-1:0;if(index<0){if(!playlist.player.loops)return false;index=playlist.items.length-1;}
return this.playIndex(playlist_id,index);},playNext:function(playlist_id){let playlist=ngutils.components.video.playlists[playlist_id];let index=playlist.active?playlist.active.index+1:playlist.items.length-1;if(index>=playlist.items.length){if(!playlist.player.loops)return false;index=0;}
return this.playIndex(playlist_id,index);},playIndex:function(playlist_id,index){let playlist=ngutils.components.video.playlists[playlist_id];let item=playlist.items[index];if(!item)throw('invalid playbackItem index '+index);this.startPlaybackItem(item);return true;},stopPlaybackItem:function(playlist_id){if(ngutils.components.video.playlists[playlist_id]&&ngutils.components.video.playlists[playlist_id].active){ngutils.components.video.playlists[playlist_id].active.$element.removeClass('playing');}},startPlaybackItem:function(playbackItem){if(typeof(playbackItem)==='undefined'||typeof(playbackItem.playlist_id)==='undefined'||!playbackItem.playlist_id){console.error('missing/invalid playbackItem',playbackItem);return;}
if(typeof(ngutils.components.video.playlists[playbackItem.playlist_id])==='undefined'){console.warn('no playlist was definied for id ',playbackItem);}
if(typeof(ngutils.components.video.playlists[playbackItem.playlist_id].player)==='undefined'||!ngutils.components.video.playlists[playbackItem.playlist_id].player||ngutils.components.video.playlists[playbackItem.playlist_id].player.playlist_id!==playbackItem.playlist_id){let player=ngutils.components.video.player.getGlobal();player.setPlaylistID(playbackItem.playlist_id);ngutils.components.video.playlists[playbackItem.playlist_id].player=player;}
let player=ngutils.components.video.playlists[playbackItem.playlist_id].player;if(ngutils.components.video.playlists[playbackItem.playlist_id].active){ngutils.components.video.playlists[playbackItem.playlist_id].active.$element.removeClass('playing');}
ngutils.components.video.playlists[playbackItem.playlist_id].active=playbackItem;playbackItem.$element.addClass('playing');player.loadMovieByID(playbackItem.item_id,(meta)=>{ngutils.event.dispatch('playlist-item-started',meta);});return player;}};ngutils.components.video.global_player=null;ngutils.components.video.player.getGlobal=function(globalParams){if(ngutils.components.video.global_player===null){let $container=$('#ng-global-video-player');let $wrapper=$('#ng-global-video-player-wrapper');let $shim_wrapper=$('#ng-global-video-player-shimwrap');let $shim=$('#ng-global-video-player-shim');let visible=false;let show_player=globalParams.show_player?true:false;let notification_height=Math.floor($('#notification-bar').outerHeight());let navbar_height=Math.floor($('#header-nav-container').outerHeight());let fixed_top=is_mobile?77:navbar_height+notification_height;let inline_top=is_mobile?fixed_top:navbar_height;let screensize=null;let min_w,min_h,can_shrink;let med_w=980;let med_h=550;function updateMinWidth(){min_w=480;min_h=270;can_shrink=true;if(is_mobile){let mw=window.innerWidth;let mh=Math.floor((mw / 16)*9);if(mh<min_h){can_shrink=false;}else if(Math.abs(mh-min_h)<150){min_h=mh;min_w=mw;can_shrink=false;}}
if(ngutils.components.video.global_player){ngutils.components.video.global_player.canSwitchScreensize(can_shrink);}}
updateMinWidth();function onScreensizeChanged(size){screensize=size;setTimeout(onScreenchange,1);}
ngutils.components.video.global_player=new ngutils.components.video.player($container,{height:'auto',width:'fill',barrier:globalParams.barrier,movie_id:globalParams.movie_id,hide_ui:globalParams.hide_ui,is_loop:globalParams.is_loop,onScreensizeChanged:onScreensizeChanged});ngutils.components.video.global_player.setGlobal(this);ngutils.components.video.registerPlayer(ngutils.components.video.global_player);ngutils.components.video.global_player.visible=visible;let notification_pos=is_mobile?notification_height:0;let fixed=false;function shiftTop(){if(fixed){$wrapper.css('top',notification_pos+"px");}else{$wrapper.css('top',inline_top+"px");}}
function notificationBarMoved(top){}
ngutils.event.addListener('notification-bar-moved',notificationBarMoved);function getSpace(){let s=$(window).scrollTop();let w,h,fw,fh;if(screensize=='large'){w=Math.floor(window.innerWidth);h=Math.floor(window.innerHeight)-200;let w2=Math.floor((h/9)*16);if(w2<w)w=w2;if(!is_mobile&&w<990)w=990;h=Math.round((w/16)*9);}else if(screensize=='medium'){w=med_w;h=med_h;}else{w=min_w;h=min_h;}
if(w<min_w){w=min_w;h=min_h;}
fh=h;if(!ngutils.components.video.global_player.fix_to_top||s<fixed_top){fixed=false;notification_pos=0;$wrapper.removeClass('locked');$wrapper.css('top',inline_top+"px");}else{let nshim=0;fixed=true;$wrapper.css('top',nshim+"px");$wrapper.addClass('locked');if(!is_mobile){fh=Math.round(h-(s-fixed_top));if(fh<min_h)fh=min_h;}}
fw="100%";shiftTop();return{width:w,height:h,fixedwidth:fw,fixedheight:fh};}
this.updateFixed=function(){onScreenchange();}
function onScreenchange(){updateMinWidth();let space=getSpace();$shim_wrapper.height(space.height);$container.height(space.fixedheight);$wrapper.height(space.fixedheight);ngutils.components.video.global_player.fillHeight();}
let manipulate=[$wrapper,$shim_wrapper];ngutils.components.video.global_player.preInit=function(callback,thisarg){if(!thisarg)thisarg=ngutils.components.video.global_player;let space=getSpace();function onFull(){if(!visible){$container.width(space.fixedwidth);visible=true;callback.call(thisarg);$(document).on('scroll',onScreenchange);onScreenchange();}}
manipulate.forEach(($manipulate)=>{if(show_player){$manipulate.addClass('open').css('height',space.height);onFull();ngutils.components.video.global_player.preInit=function(callback,thisarg){if(!thisarg)thisarg=ngutils.components.video.global_player;callback.call(thisarg);};}else{$manipulate.addClass('open').css('height','0px').animate({height:space.height},500,onFull);}});}
ngutils.components.video.global_player.onClose(function(){$(document).off('scroll',onScreenchange);ngutils.event.removeListener('notification-bar-moved',notificationBarMoved);ngutils.components.video.global_player.destroy();ngutils.components.video.global_player=null;manipulate.forEach(($manipulate)=>{$manipulate.animate({height:0},200,function(){$manipulate.removeClass('open');ngutils.components.video.player.getGlobal(globalParams);});});});if(show_player)ngutils.components.video.global_player.preInit(()=>{});show_player=false;}
return ngutils.components.video.global_player;};ngutils.ui={};ngutils.ui.slider=function(config){this._dragging=false;this.onStartDrag=function(position){};this.onStopDrag=function(position){};this.onPositionChanged=function(position){};function missingRequired(bit){console.error("Could not initialize slider with missing/invalid '"+bit+"' value.");}
function getJquery(value){value=typeof(value)=='string'?$('#'+value):value;if(!value||!(value instanceof jQuery)||value.length<1)value=null;return value;}
this.$bar=getJquery(config.bar);this.$button=getJquery(config.button);if(!this.$bar)missingRequired('bar');if(!this.$button)missingRequired('button');this.$fill=getJquery(config.fill);this.$add=getJquery(config.add);this.$subtract=getJquery(config.subtract);this.$toggle=getJquery(config.toggle);this.$select=getJquery(config.select);this.$bar.css('position','relative');this.$button.css('position','absolute');if(this.$fill)this.$fill.css('position','absolute');this._position=parseFloat(config.position);var self=this;if(this.$add||this.$subtract){this._increment=parseFloat(config.increment);if(isNaN(this._increment)||!this._increment||this._increment<=0)this._increment=0.05;}
if(this.$add)this.$add.click(function(){self.setPosition(self._position+self._increment);return false;});if(this.$subtract)this.$subtract.click(function(){self.setPosition(self._position-self._increment);return false;});var $document=$(document);if(this.$toggle&&this.$select){this.$toggle.on(ngutils.input.mouseUp,function(){self.updateBarBounds();self.$select.toggle();self.$toggle.blur();self.$select.focus();return false;});$document.on(ngutils.input.mouseUp,function(){self.$select.hide();});}
this._left=0;this._width=0;this._offset=0;this._lock_bar=config.lock_bar?true:false;var directions=['up','down','left','right'];if(config.direction){this._direction=typeof(config.direction)=='string'&&directions.indexOf(config.direction.toLowerCase())>=0?config.direction.toLowerCase():'right';}else{this._direction='right';}
if(this.$fill){switch(this._direction){case'up':this.$fill.css('bottom','0px');break;case'down':this.$fill.css('top','0px');break;case'left':this.$fill.css('right','0px');break;case'right':this.$fill.css('left','0px');break;}}
function getMousePosition(e){var mouse,bar,size,pos,input;input=ngutils.input.getMouse(e);if(self._direction=='down'||self._direction=='up'){mouse=input.y;start=self._top;size=self._height;}else{mouse=input.x;start=self._left;size=self._width;}
pos=mouse-(self._offset+start);if(pos<0)pos=0;else if(pos>size)pos=size;pos=pos/size;if(self._direction=='up'||self._direction=='left')pos=1-pos;return pos;}
if(is_mobile){$(window).resize(function(){self.updateBarBounds();self.updateFill();self.updateButton();});}
this.updateBarBounds();this.updateFill();this.updateButton();function handleDrag(e){e.preventDefault();if(self._lock_bar){self.setPosition(getMousePosition(e));}else{self.updateButton(getMousePosition(e));}}
function startDrag(e){e.preventDefault();self._dragging=true;self.onStartDrag(self._position);handleDrag(e);$document.off(ngutils.input.mouseUp,endDrag);$document.on(ngutils.input.mouseUp,endDrag);$document.off(ngutils.input.mouseMove,handleDrag);$document.on(ngutils.input.mouseMove,handleDrag);self.$bar.blur();}
function endDrag(e){e.preventDefault();self._dragging=false;$document.off(ngutils.input.mouseMove,handleDrag);$document.off(ngutils.input.mouseUp,endDrag);self.setPosition(getMousePosition(e));self.onStopDrag(self._position);}
this.$bar.on(ngutils.input.mouseDown,function(e){startDrag(e);return false;});};ngutils.ui.slider.prototype={updateBarBounds:function(){var self=this;var toggle_select=(self.$select&&self.$select.is(':hidden'));if(toggle_select)self.$select.show();var button_width=self.$button.outerWidth();var button_height=self.$button.outerHeight();self._left=self.$bar.offset().left;self._top=self.$bar.offset().top;self._width=self.$bar.innerWidth()-button_width;self._height=self.$bar.innerHeight()-button_height;if(this._direction=='down'||this._direction=='up'){self._offset=Math.round(button_height / 2);}else{self._offset=Math.round(button_width / 2);}
if(toggle_select)self.$select.hide();},setPosition:function(position){position=parseFloat(position);if(isNaN(position)||position<0)position=0;else if(position>1)position=1;if(position!==this._position){this._position=position;if(!this._dragging||this._lock_bar){this.updateButton();}
this.updateFill();this.onPositionChanged(this._position);}},updateButton:function(position){if(typeof(position)===typeof(undefined))position=this._position;var fix;if(this._direction=='down'||this._direction=='up'){position=Math.round((this._height*position)*10)/10;fix=this._direction=='up'?'bottom':'top';}else{position=Math.round((this._width*position)*10)/10;fix=this._direction=='left'?'right':'left';}
this.$button.css(fix,position);},updateFill:function(){if(this.$fill){var position;if(this._direction=='down'||this._direction=='up'){position=Math.round((this._height*this._position)*10)/10;position+=this._offset;this.$fill.css('height',position);}else{position=Math.round((this._width*this._position)*10)/10;position+=this._offset;this.$fill.css('width',position);}}}};ngutils.report_akismet_spam=function(selector){var _this=this;var that=selector;if(that.is('a')){that.on('click',function(){var href=that.attr('href');$.post(href,function(response){that.on('click',function(){return false;});that.html('Reported spam');});return false;});}};ngutils.toc=function($list_element,$content_element){if(typeof($list_element)=='string')$list_element=$('#'+$list_element);if(typeof($content_element)=='string')$content_element=$('#'+$content_element);if(!$list_element.attr('class')){$list_element.addClass('table-of-contents');}
$('h2, h3, h4',$content_element).each(function(){var $heading=$(this);var tag,indent=0;if($heading.is('h3')){indent=1;}else if($heading.is('h4')){indent=2;}
if(!$heading.attr('id')){tag="ngutils-toc-"+ngutils.toc.getNextIndex();$heading.attr('id',tag);}else{tag=$heading.attr('id');}
var $a=$('<a>').attr('href',"#"+tag).text($heading.text());var $li=$("<li>");$li.addClass('indent-'+indent);$li.append($a);$list_element.append($li);});};ngutils.toc.last_index=0;ngutils.toc.getNextIndex=function(){ngutils.toc.last_index++;return ngutils.toc.last_index;};ngutils.taghelper=function(prefix,is_user_type,input_id,max_length,max_entries){var self=this;self.prefix=prefix;self.is_user_type=is_user_type;if($.type(input_id)==='string'){if(input_id.indexOf('#')!==0){self.$input=$('#'+input_id);}else{self.$input=$(input_id);input_id=input_id.substring(1);}}else{self.$input=input_id;input_id=self.$input.attr('id');}
ngutils.taghelper.instances[input_id]=self;self.$container=self.$input.parents('div[id^="'+self.prefix+'_input"]');self.$entry_template=$($('#'+self.$container.attr('id')+'_'+prefix).html());if(PHP.get('ng_developer_debug')){console.log("Entry template: ");console.log('#'+self.$container.attr('id')+'_'+prefix);console.log(self.$entry_template.exists());}
self.names=[];self.max_length=max_length;self.max_entries=max_entries||false;self.options={};self.init();};ngutils.taghelper.prototype={addToCollection:function(str){var self=this;console.log("Template: ");console.log(self.$entry_template);var $tag=self.$entry_template.clone();str=str.substr(0,self.max_length);$('span',$tag).html(str);$('input',$tag).val(str);self.register($tag);var $collection=$('.tag-collection',self.$container);if($collection.exists()){$collection.append($tag);}
self.onAddEntry($tag);},checkCollection:function(){var self=this;var $collection=self.getCollection();ngutils.event.dispatch(ngutils.event.tagsUpdated,this);if($collection&&$collection.exists()){var total=$('div.tag',$collection).length;if(total===0){$collection.hide();}else{$collection.show();}
var $used=$('#'+self.$container.attr('id')+'_used');$used.html(total);}else{}},pushToCollection:function(tags){var self=this;var existing=$('div',self.getCollection()).length;var found=false;var str;var strip=function(t){return $.strip_text(t,!self.is_user_type);};console.log(tags);for(var i=0,len=tags.length;i<len;++i){if(self.options&&self.options.strip!==false){str=strip(tags[i]);}else{str=tags[i];}
if(str.length&&!$.rInArray(str.toLowerCase(),self.names)){console.log("ADDING");self.addToCollection(str);found=true;existing=existing+1;}else if(str.length&&$.rInArray(str.toLowerCase(),self.names)){found=true;}
if(false!==self.max_entries&&existing===self.max_entries){break;}}
self.checkCollection();return found;},disable:function(){var self=this;self.$input.disable();},enable:function(){var self=this;self.$input.enable();$(document).focus();self.init();},getCollection:function(){return $('.tag-collection',self.$container);},init:function(){var self=this;if(null===self.max_entries){throw"Please set max entries.";}
var strip=function(t){return $.strip_text(t,!self.is_user_type);};var addTag=function(str){self.addToCollection(str);};var addToCollection=function(e){var v=this.value;var tags=v.split(',');if(!v.length){return true;}
var found=self.pushToCollection(tags);if(found){$(this).val('');}
if(false===self.max_entries||$('div',self.getCollection()).length<self.max_entries){$(this).focus();}else{$(this).prop('disabled',true);self.tabProgressesTo();}};self.$input.off().on('blur',addToCollection).on('paste',function(e){var that=this;setTimeout($.proxy(addToCollection,that),0);}).on('keydown',function(e){var that=this;if(e.which===13){setTimeout(function(){if(that.value.length){$(that).blur();}},0);e.preventDefault();}else if(e.which&&e.which===9){if($(this).data('tablock')){$(this).data('tablock',false);setTimeout(function(){if($(that).prop('disabled')){self.tabProgressesTo();}else{$(that).focus();}},0);}else if(that.value.length){$(this).blur();return false;}else{self.tabProgressesTo();}}});},onAddEntry:function($element){console.debug("taghelper.onAddEntry must be overwritten.");},onRemoveEntry:function($element,editing){console.debug("taghelper.onAddEntry must be overwritten.");},pushName:function(n){this.names.push(n.toLowerCase());},register:function($element){var self=this;if($.isString($element)){$element=$('#'+$element);}
if(!$element.exists()){console.log("Can't register element, it doesn't exist.");console.log($element);return false;}
self.names.push($('span',$element).html().trim());$element.click(function(e){if($(e.target).is('span')){self.removeEntry($element,true);}});$('a[class$="close"]',$element).click(function(){self.removeEntry($(this));});},removeEntry:function($element,push_to_input){var self=this;push_to_input=push_to_input||false;if($element.is('a')){$element=$element.parent('div');}
var slug=$('input',$element).val();var tmp=self.names;var i=tmp.indexOf(slug);if(-1!==i){tmp.splice(i,1);self.names=tmp;}
self.$input.prop('disabled',false);if(push_to_input){self.$input.val($('span',$element).html().trim()).focus();}
var $clone=$element;$element.remove();self.onRemoveEntry($clone,push_to_input);self.checkCollection();},tabProgressesTo:function(){setTimeout(function(){$('div[contenteditable]').first().focus();},0);},setStrip:function(bool){this.options.strip=bool;return this;}};ngutils.taghelper.prototype.constructor=ngutils.taghelper;ngutils.taghelper.instances={};ngutils.taghelper.getInstance=function(id){if($.type(id)!=='string'){id=id.attr('id');}
if(ngutils.taghelper.instances[id]){return ngutils.taghelper.instances[id];}else{return null;}};ngutils.uploadEvent=function(event,uploader,target,data){this.event=event;this.uploader=uploader;this.target=target;this.data=data;};ngutils.uploadEvent.onSubmit="ngutils.uploadEvent.onSubmit";ngutils.uploadEvent.onUpload="ngutils.uploadEvent.onUpload";ngutils.uploadEvent.onCancel="ngutils.uploadEvent.onCancel";ngutils.uploadEvent.onDeleted="ngutils.uploadEvent.onDeleted";ngutils.uploadEvent.onError="ngutils.uploadEvent.onError";ngutils.uploadEvent.onProgress="ngutils.uploadEvent.onProgress";ngutils.uploader=function(element_selector,endpoint,config){var _uploader=this;var webImageTypes=['gif','jpg','jpeg','png','webp'];if(!config)config={};var debug=config.debug?true:false;var multi=typeof(config.multiple)===typeof(undefined)?false:(config.multiple?true:false);var chunking=typeof(config.chunking)===typeof(undefined)?true:(config.chunking?true:false);var chunkSize=config.chunkSize?config.chunkSize:5000000;var maxConnections=config.maxConnections?config.maxConnections:3;var allowedExtensions=config.allowedExtensions?config.allowedExtensions:webImageTypes;var template=config.template?config.template:"upload_template_default";var sizeLimit=config.sizeLimit?config.sizeLimit:2e+9;var redirectsEnabled=config.redirectsEnabled?config.redirectsEnabled:true;_uploader.onPreviewImage=config.onPreviewImage?config.onPreviewImage:null;_uploader.onSelect=config.onSelect?config.onSelect:null;_uploader.onError=config.onError?config.onError:null;_uploader.onComplete=config.onComplete?config.onComplete:null;_uploader.onCancel=config.onCancel?config.onCancel:null;var liveUpdate=config.liveUpdate?config.liveUpdate:false;var $uploader=$(element_selector);this.id=config.id?config.id:$uploader.attr('id');var $droparea,$drop_area_text,$uploader_inner,$preview_img;let hideDroparea=()=>{$droparea.hide();};let showDroparea=()=>{$droparea.show();};var minImageWidth=typeof(config.minImageWidth)=='number'?config.minImageWidth:null;var maxImageWidth=typeof(config.maxImageWidth)=='number'?config.maxImageWidth:null;var minImageHeight=typeof(config.minImageHeight)=='number'?config.minImageHeight:null;var maxImageHeight=typeof(config.maxImageHeight)=='number'?config.maxImageHeight:null;var maxGIFHeight=typeof(config.maxGIFHeight)=='number'?config.maxGIFHeight:maxImageHeight;var maxGIFWidth=typeof(config.maxGIFWidth)=='number'?config.maxGIFWidth:maxImageWidth;var fuconfig={messages:{},maxConnections:maxConnections,template:template,element:$uploader[0],multiple:multi,text:{fileInputTitle:" "},request:{endpoint:endpoint},chunking:{enabled:chunking},callbacks:{onSubmit:function(id,name){var _fu=this;var is_gif=name.split(".").pop().toLowerCase()=='gif';return new Promise((proceed,stop)=>{var event=new ngutils.uploadEvent(ngutils.uploadEvent.onSubmit,_uploader,null,{id:id,name:name});ngutils.event.dispatch(event.event,event);function checkOnSelect(){if(typeof(_uploader.onSelect)=='function'){let success=_uploader.onSelect.call(_fu,id,name);if(typeof(success)==='boolean'){if(success){proceed();}else{stop();}}else{success.then(proceed).catch(stop);}}else{proceed();}}
function validateGIF(gif){if(minImageWidth!==null&&gif.width<minImageWidth){alert("GIF images may not be less than "+minImageWidth+"px wide");return false;}
if(minImageHeight!==null&&gif.height<minImageHeight){alert("GIF images may not be less than "+minImageHeight+"px tall");return false;}
if(maxGIFWidth!==null&&gif.width>maxGIFWidth){alert("GIF images may not be more than "+maxGIFWidth+"px wide");return false;}
if(maxGIFHeight!==null&&gif.height>maxGIFHeight){alert("GIF images may not be more than "+maxGIFHeight+"px tall");return false;}
return true;}
if(typeof(_uploader.onPreviewImage)==='function'){let $thumb=$('<img>');_fu.drawThumbnail(id,$thumb[0]).then(function(){if(is_gif&&(minImageWidth!==null||minImageHeight!==null||maxGIFWidth!==null||maxGIFHeight!==null)&&!validateGIF($thumb[0])){stop();return;}
let success=_uploader.onPreviewImage.call(_fu,$thumb,id,name);if(typeof(success)==='boolean'){if(success){proceed();}else{stop();}}else{success.then(proceed).catch(stop);}},function(){alert('Error: Invalid image!');stop();});}else if(is_gif&&(minImageWidth!==null||minImageHeight!==null||maxGIFWidth!==null||maxGIFHeight!==null)){let $thumb=$('<img>');_fu.drawThumbnail(id,$thumb[0]).then(function(){if(is_gif&&!validateGIF($thumb[0])){stop();}else{checkOnSelect();}},function(){alert('Error: Invalid image!');stop();});}else{checkOnSelect();}});},onUpload:function(id,name){$(".qq-error",$(this.getItemByFileId(id))).first().text('');$uploader_inner.addClass('uploading');var params={userkey:PHP.get('uek','')};if(config.component&&config.component.path){params.component=config.component;}
this.setParams(params);var $file=$(this.getItemByFileId(id));this.setUuid(id,PHP.get('uuid_prefix','uuid')+this.getUuid(id));var ext=name.toLowerCase().split(".").pop();var image_types=['gif','jpg','jpeg','png','bmp','tif','tiff','webp'];if(image_types.indexOf(ext)<0){$('span.ng-upload-thumbnail-selector',$file).first().addClass("icon-dumpfile-"+ext).removeClass("ng-upload-thumbnail-selector");}
if(!multi)hideDroparea();var event=new ngutils.uploadEvent(ngutils.uploadEvent.onUpload,_uploader,$file,{id:id,name:name});ngutils.event.dispatch(event.event,event);},onProgress:function(id,name,updatedBytes,totalBytes){var $file=$(this.getItemByFileId(id));var event=new ngutils.uploadEvent(ngutils.uploadEvent.onProgress,_uploader,$file,{id:id,name:name,updatedBytes:updatedBytes,totalBytes:totalBytes});ngutils.event.dispatch(event.event,event);if(typeof(_uploader.onProgress)=='function')_uploader.onProgress.call(this,id,name,updatedBytes,totalBytes);},onComplete:function(id,name,response){if(redirectsEnabled&&response.redirect){window.location.href=response.redirect;return false;}
$uploader_inner.removeClass('uploading');var $file=$(this.getItemByFileId(id));var parked_id;if(response.parked_id){$("input.ng-id-selector",$file).first().val(response.parked_id);parked_id=response.parked_id;}
if(response.parked_url){$("input.ng-url-selector",$file).first().val(response.parked_url);}
if(response.image_url){var extension=response.image_url.split(".").pop().toLowerCase();if(liveUpdate&&webImageTypes.indexOf(extension)>=0&&$preview_img.length>0){$preview_img.attr('src',response.image_url);if(response.image_width)$preview_img.attr('height',response.image_width);if(response.image_height)$preview_img.attr('width',response.image_height);}}
if(response.delete_url){var $delete_button=$(".ng-upload-delete-seletor",$file).first();$delete_button.show();$delete_button.click(function(){$delete_button.disable();var params=(config.component&&config.component.path)?{component:config.component}:{};params.userkey=PHP.get('uek','');$.post(response.delete_url,params,function(response){var event=new ngutils.uploadEvent(ngutils.uploadEvent.onDeleted,_uploader,$file,{id:id,name:name,response:response});ngutils.event.dispatch(event.event,event);$file.remove();});});}
if(!multi)showDroparea();var event=new ngutils.uploadEvent(ngutils.uploadEvent.onComplete,_uploader,$file,{id:id,name:name,response:response});ngutils.event.dispatch(event.event,event);if(typeof(_uploader.onComplete)=='function')_uploader.onComplete.call(this,id,name,response);},onCancel:function(id,name){$uploader_inner.removeClass('uploading');if(!multi)showDroparea();var $file=$(this.getItemByFileId(id));var event=new ngutils.uploadEvent(ngutils.uploadEvent.onCancel,_uploader,$file,{id:id,name:name});ngutils.event.dispatch(event.event,event);if(typeof(_uploader.onCancel)=='function')return _uploader.onCancel.call(this,id,name);},onError:function(id,name,errorMsg){var $file=$(this.getItemByFileId(id));$uploader_inner.removeClass('uploading');if(!multi)showDroparea();var $error=$(".qq-error",$(this.getItemByFileId(id))).first();if(typeof(_uploader.onError)=='function'){_uploader.onError.call(this,id,name,errorMsg);}else if($error.length>0){$error.text(errorMsg);}else{alert(errorMsg);}
var event=new ngutils.uploadEvent(ngutils.uploadEvent.onError,_uploader,$file,{id:id,name:name,errorMsg:errorMsg});ngutils.event.dispatch(event.event,event);return false;}},validation:{sizeLimit:sizeLimit,allowedExtensions:allowedExtensions},autoUpload:true,debug:debug};if(chunking){fuconfig.chunking.concurrent={enabled:true};fuconfig.chunking.partSize=chunkSize;fuconfig.chunking.mandatory=false;fuconfig.chunking.success={endpoint:endpoint};}
if(minImageWidth!==null||maxImageWidth!==null||minImageHeight!==null||maxImageHeight!==null){fuconfig.validation.image={};if(minImageWidth!==null){fuconfig.validation.image.minWidth=minImageWidth;fuconfig.messages.minWidthImageError="Image must be at least "+minImageWidth+"px wide!";}
if(maxImageWidth!==null){fuconfig.validation.image.maxWidth=maxImageWidth;fuconfig.messages.maxWidthImageError="Image can not be wider than "+maxImageWidth+"px!";}
if(minImageHeight!==null){fuconfig.validation.image.minHeight=minImageHeight;fuconfig.messages.minHeightImageError="Image must be at least "+minImageHeight+"px tall!";}
if(maxImageHeight!==null){fuconfig.validation.image.maxHeight=maxImageHeight;fuconfig.messages.maxHeightImageError="Image can not be taller than "+maxImageHeight+"px!";}}
if(debug)console.log("Uploader config for '"+element_selector+"'",fuconfig);$droparea=$('.qq-upload-drop-area',$uploader).first();$drop_area_text=$('.drop-area-text',$uploader).first();$uploader_inner=$('.qq-uploader-selector',$uploader).first();$preview_img=$('.ng-preview-image',$uploader).first();var fu=new qq.FineUploader(fuconfig);if(typeof(config.dropAreaText)==='string')$drop_area_text.html(config.dropAreaText);var text;if(!config.fileTypesText){text=allowedExtensions&&allowedExtensions.length>0?"Allowed extensions: "+allowedExtensions.join(", "):"Files";text+=" up to "+ngutils.bytesToString(sizeLimit);}else{text=$.trim(config.fileTypesText);}
if(text){$('.ng-file-rules-text',$uploader).first().html(text);}else{$('.ng-file-rules-text',$uploader).hide();}
this.setComponent=function(path,params){this.setComponentPath(path);if(params)this.setComponentParams(params);};this.setComponentPath=function(path){if(typeof(config.component)==typeof(undefined))config.component={};config.component.path=path;};this.setComponentParam=function(name,value){if(typeof(config.component)==typeof(undefined))config.component={};if(typeof(config.component.data)==typeof(undefined))config.component.data={};config.component.data[name]=value;};this.setComponentParams=function(params){if(typeof(config.component)==typeof(undefined))config.component={};config.component.data=params;};this.getComponentParam=function(name){let params=getComponentParams();if(typeof(params[name])==typeof(undefined))return null;return params[name];};this.getComponentParams=function(){if(typeof(config.component)==typeof(undefined)||typeof(config.component.data)==typeof(undefined)){return config.component.data;}
return{};};this.getComponentPath=function(){if(typeof(config.component)==typeof(undefined)||typeof(config.component.path)==typeof(undefined)){return config.component.path;}
return null;};};ngutils.uploads={deleteImageUpload:function(url,source_type,source_id,callback){$.post('/image-delete',{url:url,source_type:source_type,source_id:source_id},callback,'json').fail((x)=>{if(x.status!==403){alert('Unexpected error!');console.error('Unexpected error',x.responseText);}});}};ngutils.croptool=function(config){var id=config.id;this.id=id;ngutils.croptool.ids[id]=this;var $body=$('body').first();var croptool=this;var $template=$('#'+id);var $ui=$('<div>');$body.append($ui);$ui.html($template.html());var $frame=$('[data-crop-frame]',$ui).first();var $image=$('[data-cropping-image]',$ui).first();var $save_btn=$('[data-btn-save]',$ui).first();var $cancel_btn=$('[data-btn-cancel]',$ui).first();var $save_txt=$('[data-saving-text]',$ui).first();var $slider_bar=$('[data-scale-slider-container]',$ui).first();var $slider=$('[data-scale-slider]',$ui).first();this.startSave=function(){saving=true;$save_btn.disable();$cancel_btn.disable();$save_txt.show();$slider_bar.hide();};this.endSave=function(){saving=false;$save_btn.enable();$cancel_btn.enable();$save_txt.hide();$slider_bar.show();};var width=config.width;var height=config.height;var imgLoader=new Image();var anchor,minscale,maxscale,scale,scalerange;var maxzoom=config.maxZoom?config.maxZoom:'auto';var saving=false;$ui.css('display','none');$image.css('position','absolute');this.reset=function(){anchor={x:0,y:0};minscale=1;maxscale=2;scale=1;scalerange=1;$image.removeAttr('src');$(imgLoader).removeAttr('src');$slider.slider('value',0);};this.onCancel=function(){};this.onSave=function(crop,frame){};this.hide=function(){$body.css('overflow','');$ui.css('display','none');ngutils.croptool.current=null;this.reset();};this.show=function(){if(ngutils.croptool.current)ngutils.croptool.current.hide();ngutils.croptool.current=this;$body.css('overflow','hidden');$ui.css('display','');};this.update=function(){var iw=imgLoader.width*scale;var ih=imgLoader.height*scale;var l=Math.round((width/2)-(anchor.x*scale));var t=Math.round((height/2)-(anchor.y*scale));$image.css('width',iw).css('height',ih).css('left',l).css('top',t);};this.newImage=function(){$image.attr('src',imgLoader.src);var wscale=width / imgLoader.width;var hscale=height / imgLoader.height;var _maxzoom=maxzoom;if(maxzoom==='auto'){var xz=(imgLoader.width / width);var yz=(imgLoader.height / height);_maxzoom=xz>yz?xz:yz;}
minscale=wscale>hscale?wscale:hscale;maxscale=minscale*_maxzoom;scale=minscale;scalerange=maxscale-minscale;anchor.x=Math.floor(imgLoader.width / 2);anchor.y=Math.floor(imgLoader.height / 2);croptool.update();};this.showImage=function(src){$image.removeAttr('src');$image.attr('src',imgLoader.src);imgLoader.src=src;croptool.show();};this.onDragged=function(moved){anchor.x-=moved.x / scale;anchor.y-=moved.y / scale;this.checkAnchor();this.update();};this.checkAnchor=function(){var fh=(height/2)/ scale;var fw=(width/2)/ scale;if(anchor.y<fh)anchor.y=fh;else if(anchor.y>imgLoader.height-fh)anchor.y=imgLoader.height-fh;if(anchor.x<fw)anchor.x=fw;else if(anchor.x>imgLoader.width-fw)anchor.x=imgLoader.width-fw;};$(imgLoader).on('load',this.newImage);var dragging=false;var mousePos={x:0,y:0};$slider.slider({value:0,min:0,max:1,step:0.001,slide:function(event,ui){scale=minscale+(scalerange*ui.value);croptool.checkAnchor();croptool.update();}});$cancel_btn.click(function(){croptool.hide();croptool.onCancel();});$save_btn.click(function(){croptool.startSave();var crop={};var fh=(height/2)/ scale;var fw=(width/2)/ scale;crop.top=Math.ceil(anchor.y-fh);crop.left=Math.ceil(anchor.x-fw);crop.width=Math.floor(fw*2);crop.height=Math.floor(fh*2);crop.right=crop.left+crop.width;crop.bottom=crop.top+crop.height;if(croptool.onSave(crop,{width:width,height:height})===true)croptool.hide();});$image.on(ngutils.input.mouseDown,function(e){dragging=true;var posObj=e.changedTouches?e.changedTouches[0]:e;mousePos={x:posObj.screenX,y:posObj.screenY};});$(document).on(ngutils.input.mouseUp,function(){dragging=false;}).on(ngutils.input.mouseMove,function(e){if(!dragging||saving)return;var posObj=e.changedTouches?e.changedTouches[0]:e;var newPos={x:posObj.screenX,y:posObj.screenY};if(mousePos){croptool.onDragged({x:newPos.x-mousePos.x,y:newPos.y-mousePos.y});}
mousePos=newPos;return false;});if(config.src){imgLoader.src=config.src;}
this.reset();};ngutils.croptool.current=null;ngutils.croptool.ids={};ngutils.croptool.get=function(id){return typeof(ngutils.croptool.ids[id])!='undefined'?ngutils.croptool.ids[id]:null;};ngutils.croptool.prototype.constructor=ngutils.croptool;ngutils.croppable_image=function(selector,config){this.onSaved=function(){};this.onCancel=function(){};this.parked_id=null;this.parked_url='';var skip_crop=false;var image_crop=this;var image=new Image();var $container=$(selector);var $aimage=$('[data-image-frame]',$container).first();var $img=$('img',$aimage).first();var $spinner=$('[data-image-spinner]',$container).first();var $save_text=$('[data-saving-text]',$container).first();var $upload=$('div[data-image-upload]',$container).first();var $upload_container=$('div[data-image-upload-toggle]',$container).first();var parkEndpoint=config.parkEndpoint?config.parkEndpoint:"/parkfile";var saveEndpoint=config.saveEndpoint?config.saveEndpoint:null;var liveCrop=config.liveCrop?config.liveCrop:false;var saveParams=config.saveParams?config.saveParams:null;var stretchToFit=typeof(config.stretchToFit)!==typeof(undefined)?config.stretchToFit:true;var fileTypesText=config.fileTypesText?config.fileTypesText:null;var dropAreaText=config.dropAreaText?config.dropAreaText:"Drop Image, or Click Here";function unstretchImage(){if(stretchToFit)return;setTimeout(function(){if($img[0].naturalWidth<$img[0].width){$img[0].width=$img[0].naturalWidth;$img[0].height=$img[0].naturalHeight;$img.removeAttr('style');}},100);}
$img[0].onload=unstretchImage;var canEdit=$upload.length>0;var $crop_ui=$('[data-crop-ui]',$container).first();if(!canEdit){$crop_ui.remove();}else{$crop_ui.addClass('nodim');}
var $slider_container=$('[data-scale-slider-container]',$crop_ui).first();if(!config.frame){config.frame={};}else{if(config.frame.width)config.frame.maxWidth=config.frame.minWidth=config.frame.width;if(config.frame.height)config.frame.maxHeight=config.frame.minHeight=config.frame.height;}
this.maxFrameWidth=config.frame.maxWidth?config.frame.maxWidth:1080;this.maxFrameHeight=config.frame.maxHeight?config.frame.maxHeight:360;this.minFrameWidth=config.frame.minWidth?config.frame.minWidth:480;this.minFrameHeight=config.frame.minHeight?config.frame.minHeight:240;this.fillScale=config.fillScale?config.fillScale:1;this.keepAspect=config.frame.keepAspect?config.frame.keepAspect:false;if(canEdit){var uconfig={template:"croppable_image_template",fileTypesText:fileTypesText,dropAreaText:dropAreaText,multiple:false,allowedExtensions:["webp","png","jpeg","jpg","gif"],onComplete:function(id,filename,response){if(typeof(id)=='number')$(this.getItemByFileId(id)).remove();if(skip_crop){startSaving();var output={nocrop:true,parked_id:response.parked_id};for(var i in saveParams){output[i]=saveParams[i];}
$.post(saveEndpoint,output,function(result){image_crop.oldSrc=result.image_url;image_crop.clearEdit();image_crop.onSaved(result);},'json').fail(function(){image_crop.clearEdit();endSaving();});}else{image_crop.parked_id=response.parked_id;image_crop.parked_url=response.parked_url;image_crop.newImage(image_crop.parked_url);}}};if(config.sizeLimit)uconfig.sizeLimit=config.sizeLimit;if(config.maxWidth)uconfig.maxImageWidth=config.maxWidth;if(config.maxHeight)uconfig.maxImageHeight=config.maxHeight;if(config.minWidth)uconfig.minImageWidth=config.minWidth;if(config.minHeight)uconfig.minImageHeight=config.minHeight;uconfig.maxGIFWidth=this.maxFrameWidth;uconfig.maxGIFHeight=this.maxFrameHeight;if(config.debug)uconfig.debug=true;if(liveCrop){uconfig.autoUpload=false;uconfig.onPreviewImage=function($thumb,id,name){let _fu=this;return new Promise((proceed,reject)=>{if($thumb[0].naturalWidth<=image_crop.maxFrameWidth&&$thumb[0].naturalHeight<=image_crop.maxFrameHeight){$thumb=null;skip_crop=true;return proceed();}
skip_crop=false;function complete(){reject();image.width=$img[0].naturalWidth;image.height=$img[0].naturalHeight;image.src=$img.attr('src');uconfig.onComplete.call(_fu,null,null,{parked_id:0,parked_url:image.src});}
if($thumb[0].naturalWidth<image_crop.maxFrameWidth){let canvas=document.createElement('canvas');let context2d=canvas.getContext('2d');canvas.width=image_crop.maxFrameWidth;canvas.height=$thumb[0].naturalHeight;context2d.drawImage($thumb[0],Math.round((canvas.width-$thumb[0].naturalWidth)/2),0,$thumb[0].naturalWidth,$thumb[0].naturalHeight);$thumb=null;$tmp=$("<img>");$tmp[0].onload=function(){$img[0].src=$tmp[0].src;complete();};$tmp.attr('src',canvas.toDataURL('image/webp',0.8));}else{$img[0].src=$thumb[0].src;complete();}});};}
var uploader=new ngutils.uploader($upload,parkEndpoint,uconfig);setTimeout(unstretchImage,300);}
this.dragMove=null;var first_load=true;function updateSrc(src){if(!first_load)$spinner.show();first_load=false;image.src=src;}
var mode='view';var dragging=false;mousePos=null;if(canEdit){$aimage.on(ngutils.input.mouseDown,function(e){dragging=mode!=='view'?true:false;var posObj=e.changedTouches?e.changedTouches[0]:e;mousePos={x:posObj.screenX,y:posObj.screenY};});$(document).on(ngutils.input.mouseUp,function(){dragging=false;}).on(ngutils.input.mouseMove,function(e){if(!dragging||saving)return;var posObj=e.changedTouches?e.changedTouches[0]:e;var newPos={x:posObj.screenX,y:posObj.screenY};if(mousePos){image_crop.onDragged({x:newPos.x-mousePos.x,y:newPos.y-mousePos.y});}
mousePos=newPos;return false;});}
this.src=config.src?config.src:null;this.oldSrc=this.src;this.updateHeight=function(){if(image_crop.keepAspect){var cWidth=$aimage.width();var cHeight=$aimage.height();var aspectScale=cWidth / image_crop.maxFrameWidth;cHeight=Math.floor(image_crop.maxFrameHeight*aspectScale);$aimage.height(cHeight);}};if(this.keepAspect){this.minFrameWidth=this.maxFrameWidth;this.minFrameHeight=this.maxFrameHeight;this.updateHeight();}
this.minScale=1;this.maxScale=2;this.anchor={x:0,y:0};var frame={width:this.maxFrameWidth,height:Math.ceil(this.maxFrameHeight /(this.minFrameWidth/ this.maxFrameWidth))};var $save=$('[data-btn-save]',$crop_ui).first();var $cancel=$('[data-btn-cancel]',$crop_ui).first();var saving=false;function startSaving(){saving=true;$cancel.disable();$save.disable();$slider_container.hide();$save_text.show();}
function endSaving(){saving=false;$cancel.enable();$save.enable();$slider_container.show();$save_text.hide();}
endSaving();if(canEdit){$cancel.click(function(){image_crop.cancelEdit();});$save.click(function(){if(liveCrop){let $img=$('img',$aimage).first();var src=$img.attr('src');if(!src){alert('Please upload an image first!');return false;}
startSaving();var doLiveCrop=function(){let canvas=document.createElement('canvas');let context2d=canvas.getContext('2d');let scale;canvas.width=image_crop.maxFrameWidth;canvas.height=image_crop.maxFrameHeight;if($aimage.width()<image_crop.maxFrameWidth){scale=image_crop.maxFrameWidth / $aimage.width();}else{scale=1;}
context2d.drawImage($img[0],$img.position().left*scale,$img.position().top*scale,$img.width()*scale,$img.height()*scale);let base64=canvas.toDataURL('image/webp',0.8).split(",").pop();var blob=ngutils.b64toBlob(base64,'image/webp');var formData=new FormData();formData.append("qquuid","auto");formData.append("qqfile",blob);formData.append("qqfilename",'qqCanvasImage.webp');if(saveParams){for(var param in saveParams){formData.append(param,saveParams[param]);}}
$.ajax({url:saveEndpoint,type:"POST",data:formData,contentType:false,cache:false,processData:false,dataType:"json",error:function(err){alert("There was an error uploading your image:\n\n"+err);endSaving();},success:function(result){image_crop.oldSrc=result.image_url;image_crop.clearEdit();image_crop.onSaved(result);}});endSaving();};if($img.naturalWidth===0){$img[0].onload=function(){doLiveCrop();};}else{doLiveCrop();}}else{startSaving();var output={crop:image_crop.crop,frame:frame,parked_id:image_crop.parked_id};for(var i in saveParams){output[i]=saveParams[i];}
$.post(saveEndpoint,output,function(result){image_crop.oldSrc=result.image_url;image_crop.clearEdit();image_crop.onSaved(result);},'json').fail(function(){endSaving();});}});}
this.cancelEdit=function(){image_crop.clearEdit();image_crop.onCancel();};this.clearEdit=function(){ngutils.blackout.undim();$crop_ui.hide();endSaving();mode='view';$container.removeClass('nodim');$container.removeClass('img-edit');$upload_container.addClass('can-upload');updateSrc(image_crop.oldSrc);};this.newImage=function(url){mode='new';updateSrc(url);$container.addClass('img-edit');var rando=Math.random();var $slider=$('[data-scale-slider]',$crop_ui).first();$slider.slider({value:0,min:0,max:1,step:0.001,slide:function(event,ui){image_crop.fillScale=image_crop.minScale+((image_crop.maxScale-image_crop.minScale)*ui.value);image_crop.draw();}});$crop_ui.show();$container.addClass('nodim');ngutils.blackout.dim();$upload_container.removeClass('can-upload');};this.onDragged=function(dragged){this.dragMove=dragged;this.draw();};this.crop=null;this.draw=function(){$spinner.hide();if(!image.src||!image.width)return;if($img.attr('src')!==image.src)$img.attr('src',image.src);$img.css("width","");$img.css("height","");$img.css('top',"");$img.css('left',"");if(image_crop.keepAspect){image_crop.updateHeight();}
var cWidth=$aimage.width();var cHeight=$aimage.height();if(mode==='view'){$img.css("width","100%");var bleed=Math.floor((cHeight-$img.height())/ 2);$img.css('top',bleed+'px');}else{var iWidth=image.width;var iHeight=image.height;var iScale=cWidth / image_crop.maxFrameWidth;var drawMe=function(){var scale=iScale*image_crop.fillScale;var sWidth=iWidth*scale;var sHeight=iHeight*scale;if(image_crop.dragMove){image_crop.anchor.x-=Math.round(image_crop.dragMove.x / scale);image_crop.anchor.y-=Math.round(image_crop.dragMove.y / scale);image_crop.dragMove=null;}
var scaleFrame={width:Math.ceil(frame.width*iScale),height:Math.ceil(frame.height*iScale)};var frameSpace={w:scaleFrame.width / 2,h:scaleFrame.height / 2,x:(scaleFrame.width-sWidth)/ 2,y:(scaleFrame.height-sHeight)/ 2};var anchor={x:image_crop.anchor.x*scale,y:image_crop.anchor.y*scale};if(anchor.x<frameSpace.w){anchor.x=frameSpace.w;image_crop.anchor.x=anchor.x / scale;}else if(anchor.x>sWidth-frameSpace.w){anchor.x=sWidth-frameSpace.w;image_crop.anchor.x=anchor.x / scale;}
if(anchor.y<frameSpace.h){anchor.y=frameSpace.h;image_crop.anchor.y=anchor.y / scale;}else if(anchor.y>sHeight-frameSpace.h){anchor.y=sHeight-frameSpace.h;image_crop.anchor.y=anchor.y / scale;}
image_crop.crop={left:Math.round(image_crop.anchor.x-(frameSpace.w / scale)),right:Math.round(image_crop.anchor.x+(frameSpace.w / scale)),top:Math.round(image_crop.anchor.y-(frameSpace.h / scale)),bottom:Math.round(image_crop.anchor.y+(frameSpace.h / scale))};image_crop.crop.width=image_crop.crop.right-image_crop.crop.left;image_crop.crop.height=image_crop.crop.bottom-image_crop.crop.top;var bleed={x:Math.round((cWidth/2)-anchor.x),y:Math.round((cHeight/2)-anchor.y)};$img.css("width",Math.ceil(sWidth)+"px");$img.css("height",Math.ceil(sHeight)+"px");$img.css("left",bleed.x+"px");$img.css("top",bleed.y+"px");};if(mode==='edit'){drawMe();}else if(mode=='new'){var wscale,hscale;wscale=frame.width / iWidth;hscale=frame.height / iHeight;image_crop.minScale=wscale>hscale?wscale:hscale;image_crop.maxScale=image_crop.minScale*2;if(image_crop.maxScale<1)image_crop.maxScale=1;image_crop.fillScale=image_crop.minScale;image_crop.anchor={x:Math.floor(iWidth/2),y:Math.floor(iHeight/2)};mode='edit';drawMe();}}};$(image).on('load',this.draw);$(function(){image_crop.draw();});if(this.src)updateSrc(this.src);ngutils.event.addListener(ngutils.event.resize,function(){setTimeout(image_crop.draw,5);});};ngutils.user={};ngutils.user.block={onClickTogglePreview:function(event,$element){event.preventDefault();var $wrapper=$($element).closest('[data-block-target]');if($wrapper.hasClass('preview-blocked')){$wrapper.removeClass('preview-blocked');}else{$wrapper.addClass('preview-blocked');}},handleUpdates:function(data){function updateTarget(target,page,data,blocked){var $element=$('[data-block-target="'+target+'"]');if($element.length<1)return false;$element.removeClass('preview-blocked');if(blocked){$element.addClass('user-is-blocked').removeClass('user-not-blocked');}else{$element.addClass('user-not-blocked').removeClass('user-is-blocked');}
var uparams={user_id:data.user_id,page:page,blocked:blocked,exemptions:data.exemptions};function doEvent(e){ngutils.event.dispatch($(e).attr('data-block-event'),uparams);}
$element.each(function(){if($(this).attr('data-block-event'))doEvent($(this));});$('[data-block-event]',$element).each(doEvent);return uparams;}
var blocked=false;for(var i in data.exemptions){if(!data.exemptions[i]){blocked=true;break;}}
updateTarget(data.user_id,null,data,blocked);for(var page in data.exemptions){var target=page+'-'+data.user_id;blocked=!data.exemptions[page];var uparams=updateTarget(target,page,data,blocked);if(uparams)ngutils.event.dispatch(ngutils.event.userBlockUpdated,uparams);}}};ngutils.event.addListener(ngutils.event.userBlocksUpdated,ngutils.user.block.handleUpdates);ngutils.moderation={enableImageModeration:($img,callback)=>{$img=$($img);let $wrapper=$($img).parent();let $module=$('<div class="padded" style="position:absolute; top:0px; right: 0px"><a class="ngicon-25-trash" title="Delete Image"></a></div>');$wrapper.append($module);$('a',$module).click((e)=>{e.preventDefault();if(confirm("Are you sure you want to delete this image?")){callback(()=>{$module.remove();ngutils.element.fancyRemove($img,()=>{$wrapper.remove();});});}});}};ngutils.blogpost={contentType:4001,enableImageModeration:($img)=>{$img=$($img);ngutils.moderation.enableImageModeration($img,(onComplete)=>{let source_id=parseInt($img.closest('[data-post-id]').attr('data-post-id'));ngutils.uploads.deleteImageUpload($img.attr('src'),ngutils.blogpost.contentType,source_id,(result)=>{onComplete();});});},};ngutils.bbspost={contentType:3002,form_id:0,unbanFromClick:(event,button)=>{event.preventDefault();var user_id=$(button).attr('id').split('_').pop();var user=PHP.get('bbs_poster_'+user_id,"this user");if(!confirm("Are you sure you want to clear\n"+user+"'s ban?"))return;$.post(button.href,()=>{let $parent=$(button).closest('[data-ban-details-for]');let $ban_btn=$('[id="ban-btn-text"]',$parent);let $clear_btn=$('[id="clear-ban-btn"]',$parent);let $ban_details=$('[id="ban-details"]',$parent);$clear_btn.hide();$ban_details.hide();$ban_btn.html('ban');});},deleteFromClick:(event,button,post_id,which)=>{event.preventDefault();let $button=$(button);if(confirm('Are you sure you want to delete this '+which+'?')){$.post($button.attr('href'),()=>{let $remove;if(which==='pic'){$button.remove();ngutils.element.fancyRemove($('[id="bbspost_img_'+post_id+'"]').parent());}else{ngutils.element.fancyRemove($('[id="bbspost'+post_id+'_post_text"]').parent());}});}},enableImageModeration:($img)=>{$img=$($img);ngutils.moderation.enableImageModeration($img,(onComplete)=>{let source_id=parseInt($img.closest('[data-post-id]').attr('data-post-id'));ngutils.uploads.deleteImageUpload($img.attr('src'),ngutils.bbspost.contentType,source_id,(result)=>{onComplete();});});},loadFormOnClick:(event,button,post_id,container,context,_confirm)=>{event.preventDefault();if(_confirm){if(!confirm("This is not your post, are you sure you want to edit?"))return false;}
if(!PHP.get('user_logged_in')){PassportHandler.open();return;}
let $button=$(button);ngutils.bbspost.loadForm(post_id,$button.attr('href'),container+"",context);},loadForm:(post_id,href,container,context)=>{ngutils.bbspost.form_id++;let fid=ngutils.bbspost.form_id;var bo=new ngutils.blackout({remove_on_hide:true});if(!context)context='post';let $container=$(container);ngutils.event.addListener('bbs-form-loaded-'+fid,(data)=>{if(!data.result||typeof(data.result.url)===typeof(undefined)){data.posthandler.handled_by_event=true;alert("There was an unexpected problem with your post.");return;}
if($container.length<1||typeof(data.result.html)===typeof(undefined)){bo.hide();data.posthandler.handled_by_event=false;return;}
if(context==='edit'){data.posthandler.handled_by_event=true;let $html=$("<div>").html(data.result.html);$('[id="bbspost'+post_id+'_post_text"]').html($html.html());bo.setBody("<p><strong>Changes Saved!</strong></p>");setTimeout(()=>{bo.hide();},750);}else{data.posthandler.handled_by_event=true;bo.hide();$container.css('display','block');let $parent=$container.closest(".blackout-hover");let top;if($parent.length<1){$parent=$('html,body');top=$container.offset().top;}else{top=$container.position().top;}
top+=$container.outerHeight();let $post=$('<div>');$post.append($(data.result.html));$post=$('div:first',$post);if(!data.result.noscroll)$parent.stop().animate({scrollTop:top},300);$container.append($post);if($post.width())$post.attr('data-scale-width',$post.width());$post.hide();setTimeout(()=>{$('[data-smart-scale]',$post).each(()=>{new ngutils.media.smartscale($(this));});},1);$post.css('visibility','hidden');setTimeout(()=>{$post.css('visibility','').hide();$post.fadeIn(800,()=>{});},250);}});bo.load(href,{form_id:fid,container_id:$container.attr('id'),from_page:PHP.get('bbs_topic_page',0)});}};ngutils.event.addListener('bbs-user-banned',(data)=>{let $details=$('[data-ban-details-for="'+(data.user.toLowerCase())+'"]');let $new=$(data.html);$details.html($new.html());});ngutils.bbssig={deleteFromClick:(event,button,user_id,which)=>{event.preventDefault();let $button=$(button);let msg="signature";if(which=='text')msg="sig text";else if(which=='pic')msg="sig banner";if(!confirm("Are you sure you want to delete this "+msg+"?"))return;let $e=$('[id^="bbs_sig_"][id$="_'+user_id+'"]');function deleteText($e){$('.sig-text',$e).remove();$('[id^="delete_sig_text_"]',$e).remove();}
function deletePic($e){$('.sig-image',$e).remove();$('[id^="delete_sig_pic_"]',$e).remove();}
$.post($button.attr('href'),()=>{$('[id^="delete_sig_both_"]',$e).remove();if(which=='both'){deleteText($e);deletePic($e);}else if(which=='pic'){deletePic($e);}else{deleteText($e);}});},onUpdated:(user_id,updates)=>{var au=PHP.get('activeuser');var is_activeuser=au&&au.id?au.id==user_id:false;$('div.bbs-sig[id$="_'+user_id+'"]').each(function(){var $sig_text=$('div.sig-text:first',$(this));var $sig_image_wrapper=$('div.sig-image:first',$(this));var $sig_image=$('img:first',$sig_image_wrapper);var $sig_link=$('a:first',$sig_image_wrapper);function clearLink(){$sig_link.removeAttr('href');}
function clearImage(){$sig_image.removeAttr('src');clearLink();}
var val,update;for(update in updates){val=$.trim(updates[update]);switch(update){case'image':if(val)$sig_image.attr('src',val).removeAttr('width').removeAttr('height');else clearImage();break;case'link':if(val)$sig_link.attr('href',val);else clearLink();break;case'text':if(val)$sig_text.html(val);else $sig_text.html('');}}
if(!$.trim($sig_text.html())&&!$sig_image.attr('src')){if(is_activeuser){$('.add-signature-link',$(this)).show();}else{$(this).hide();}}else{if(is_activeuser){$('.add-signature-link',$(this)).hide();}else{$(this).show();}}});}};})(jQuery);}