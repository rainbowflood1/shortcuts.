const IMA_AD_WIDTH = 800;
const IMA_AD_HEIGHT = 600;

    // JavaScript Document
var PreRollAd = {
        adsManager: null,
        adsLoader: null,
        adDisplayContainer: null,
        videoContent: null,
        isAds: false,
        intervalTimer: null,
        adContainer: null,
        timeoutTimer: null,
        timeCounter: 15,
        adObject: null,
        startTime: new Date,
        start: function () {
      if (typeof(google) === 'undefined') {
        PreRollAd.showGame();
        return;
      }
      
      PreRollAd.videoContent = $("#videoElement").get(0);
      PreRollAd.adContainer = $("#adContainer");
      PreRollAd.requestAds();
      $(window).bind("resize", PreRollAd.correctPositions);
        },
        showGame: function () {
      $("#adsContainer").hide();
      SkipAdAndShowGame();
        },
        correctPositions: function () {
          if(PreRollAd.adObject && PreRollAd.adsManager ){
              if(PreRollAd.adObject.isLinear()){
                        $("#adTitle").hide();
                        PreRollAd.adContainer.height(600);
                        PreRollAd.adsManager.resize($("#adContainer").width(), $("#adContainer").height(), google.ima.ViewMode.NORMAL);
              }else{
                
              }
          }
        },
        requestAds: function () {
          PreRollAd.adDisplayContainer = new google.ima.AdDisplayContainer(PreRollAd.adContainer.get(0));
          PreRollAd.adDisplayContainer.initialize();
          PreRollAd.adsLoader = new google.ima.AdsLoader(PreRollAd.adDisplayContainer);
          PreRollAd.adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED, PreRollAd.onAdsManagerLoaded, !1);
          PreRollAd.adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, PreRollAd.events.onAdError, !1);
        
          var e = new google.ima.AdsRequest;
          if(!PreRollAd.isAds) {
              e.adTagUrl = PreGameAdURL;
          }
          else {
                e.adTagUrl = "https://googleads.g.doubleclick.net/pagead/ads?ad_type=video_image&client=ca-games-pub-4764333688337558&description_url=" + descriptionURL + "&channel=7323774292&videoad_start_delay=0&hl=en&max_ad_duration=30000";
          }
          
          e.forceNonLinearFullSlot = true;
          e.nonLinearAdSlotWidth = IMA_AD_WIDTH;
          e.nonLinearAdSlotHeight = IMA_AD_HEIGHT;
          e.linearAdSlotWidth = IMA_AD_WIDTH;
          e.linearAdSlotHeight = IMA_AD_HEIGHT;
          PreRollAd.adsLoader.requestAds(e);
        },
        onAdsManagerLoaded: function (e) {
            PreRollAd.adsManager = e.getAdsManager(PreRollAd.videoContent);
            PreRollAd.adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, PreRollAd.events.onAdError);
            PreRollAd.adsManager.addEventListener(google.ima.AdEvent.Type.USER_CLOSE, PreRollAd.events.onUserClose);
            PreRollAd.adsManager.addEventListener(google.ima.AdEvent.Type.LOADED, PreRollAd.events.onAdEvent);
            PreRollAd.adsManager.addEventListener(google.ima.AdEvent.Type.STARTED, PreRollAd.events.onAdEvent);
            PreRollAd.adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE, PreRollAd.events.onAdEvent);
            PreRollAd.adsManager.addEventListener(google.ima.AdEvent.Type.CLICK, PreRollAd.events.onAdEvent);
            PreRollAd.adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED, PreRollAd.events.onUserClose);
            PreRollAd.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, PreRollAd.events.onUserClose);
            try {
                PreRollAd.adsManager.init(IMA_AD_WIDTH, IMA_AD_HEIGHT, google.ima.ViewMode.NORMAL);
                PreRollAd.adsManager.start();
            } catch (i) {
              console.log("ad error",i);
              PreRollAd.showGame();
            }
        },
        events: {
            onUserClose: function () {
                PreRollAd.showGame();
            },
            onAdEvent: function (e) {
                var i = e.getAd();
                switch (e.type) {
                case google.ima.AdEvent.Type.LOADED:
                    PreRollAd.adObject = i, PreRollAd.correctPositions(), i.isLinear() || PreRollAd.tickTimer();
                    break;
                case google.ima.AdEvent.Type.STARTED:
                    break;
                case google.ima.AdEvent.Type.COMPLETE:
                    PreRollAd.showGame();
                    break;
                case google.ima.AdEvent.Type.CLICK:
                    PreRollAd.showGame();
                }
            },
            onAdError: function (e) {
                console.log(e);

                if(PreRollAd.isAds == false) {
                    PreRollAd.isAds = true;
                    PreRollAd.start();
                }
                else  {
                  promoVideo();
                }
            }
        },
        tickTimer: function () {
            $("#adTitle .titleText").html("Advertisement, " + PreRollAd.timeCounter + "")
                PreRollAd.timeoutTimer = setTimeout(function () {
                PreRollAd.timeCounter--;
        if(PreRollAd.timeCounter==0){
          PreRollAd.showGame();
          clearTimeout(PreRollAd.timeoutTimer);
        }else{
          PreRollAd.tickTimer();
        }
            }, 1e3)
        },
        logPageClosedWhileAd: function () {
      
        }
    };

function promoVideo() {
  $("<style type='text/css'>.promo-container{display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;position:absolute;width:100%;height:100%;top:0;left:0}.promo-display-container{flex-grow:1;position:relative}.promo-controls-container{padding:4px 0;text-align:right;visibility:hidden}.promo-display-container>div{box-sizing:border-box;width:0;height:0;min-height:100%;min-width:100%;max-width:100%;max-height:100%;overflow:hidden;position:absolute}#promo-message{box-sizing:border-box;padding:4px 16px;margin:auto;color:#fff;color:rgba(255,255,255,.8);font-family:Helvetica,Arial,sans-serif;font-size:14px;cursor:pointer;min-width:150px;float:left;text-align:left;margin-bottom:8px;font-weight:400;display:none}#promo-button{box-sizing:border-box;padding:4px 16px;margin:auto;border:1px solid rgba(255,255,255,.5);color:#fff;color:rgba(255,255,255,.8);font-family:Helvetica,Arial,sans-serif;font-size:18px;cursor:pointer;min-width:150px;margin-bottom:8px;background:#000}#promo-button:hover{background:linear-gradient(#a711b0,#821088)}#promo-button:active{background:linear-gradient(#a711b0,#821088)}#promo-button:disabled,#promo-button[disabled]{background:#000}.banner{z-index:1020;height:100%;display:flex!important;align-items:center;justify-content:center} </style>").appendTo("head");
  var number = $.now();
  var apnd = '<div id="promo" style="display:none;z-index: 1030; position: absolute; width: 100%; height: 100%; top: 0px; left: 0px;"><div class="promo-container" style="background-color: black;"> <div class="promo-display-container"> <div id="preroll_banner_container"> <div id="preroll_banner" class="banner"> <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script><div id="preroll_banner_ad_' + number + '"> <script>window.googletag=window.googletag ||{cmd: []}; googletag.cmd.push(function(){googletag.defineSlot("/21739493398/AdExchange-300x250", [[300, 250], [250, 250], [200, 200], [300, 75], [120, 240], [180, 150], [240, 133], [300, 100]], "preroll_banner_ad_' + number + '").addService(googletag.pubads()); googletag.enableServices(); googletag.display("preroll_banner_ad_' + number + '");}); </script> </div></div></div></div><div class="promo-controls-container" style="visibility: visible;"> <button id="promo-button">You can skip this in <span id="preroll_time_5">5</span> secs</button> <span id="promo-message">Ad will be closed in <span id="preroll_full_time">31</span> secs</span> </div></div></div>';
    $('.promoVideo').append(apnd);

    $('#promo').show();
    
  var intervaltimer = setInterval(function(){

      if( parseInt( $("#preroll_full_time").html() ) < 1 ){
          $("#promo").remove();
           PreRollAd.showGame();
          clearInterval( intervaltimer );
      }

      $("#preroll_full_time").html( parseInt( $("#preroll_full_time").html() ) - 1 );


      if( parseInt( $("#preroll_time_5").html() ) < 1 ){
        $("#promo-message").show();
          $("#promo-button").html('SKIP').on('click', function(){
              clearInterval( intervaltimer );
              $("#promo").remove();
               PreRollAd.showGame();
          });

      } else {

          $("#preroll_time_5").html( parseInt( $("#preroll_time_5").html() ) - 1 );
      }
      
  }, 1000);
}